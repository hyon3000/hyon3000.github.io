<!DOCTYPE html>
<html>

<head>
<title>Minesweeper</title>

<meta charset="utf-8">
<link href="mine.css" media="screen" rel="stylesheet" type="text/css" />
<link href="win98.css" media="screen" rel="stylesheet" type="text/css" />
<link href="mine-win98.css" media="screen" rel="stylesheet" type="text/css" />

</head>

<body>
<script>
var execute=function(i,j,k,l=1){
	i = parseInt(i);
	j = parseInt(j);
	k = parseInt(k);
	l = parseInt(l);
	if(l>5) l=5;
	else if(l<1) l=1;
	if((i*j-1)*l<k) k=(i*j-1)*l;
	document.getElementById('x').value=i;
	document.getElementById('y').value=j;
	document.getElementById('m').value=l;
	document.getElementById('t').value=k;
	
	if(i<10) {
		$(".menu4").css({"display": "none",});
	}
	else {
		$(".menu4").removeAttr("style");
	}
	if(i<13) {
		$(".menu5").css({"display": "none",});
	}
	else {
		$(".menu5").removeAttr("style");
	}
	if(i<16) {
		$(".menu6").css({"display": "none",});
	}
	else {
		$(".menu6").removeAttr("style");
	}
	if(i<19) {
		$(".menu7").css({"display": "none",});
	}
	else {
		$(".menu7").removeAttr("style");
	}
	if(i<22) {
		$(".menu8").css({"display": "none",});
	}
	else {
		$(".menu8").removeAttr("style");
	}
	minefield.init_board(i, j, k,l);
	$(".mine-window").css({
		"width": 22+i*16,
		"height": 107+j*16,
    });
	$(".window-content .mine-head-area ").css({
		"width": 2+i*16,
    });
	$(".window-content .mine-area").css({
		"width": i*16,
		"height": j*16,
    });
	$(".inner").css({
		"width": i*16,
		"height": j*16,
    });
	$(".window-content .mine-head-area .mine-reset-button").css({
		"left": -8+8*i,
    });
	$(".userctrl").css({
		"margin-top": 117+j*16,
    });
	$(".windows").css({
		"height": 112+j*16,
    });

};

</script>
<div class="windows windows-98" style="height:365px;">

<div class="window has-menu mine-window">
    <div class="title-bar">
        <div class="title-icon"></div>
        <div class="title">Minesweeper</div>
        <div class="title-button-group">
            <div class="title-button minimize"></div>
            <div class="title-button maximize disabled"></div>
            <div class="title-button close"></div>
        </div>
    </div>
    <ul class="menu-bar">
<li class="menu1" onclick="execute(9, 9, 10)">초급</li>
<li class="menu2" onclick="execute(16, 16, 40)">중급</li>
<li class="menu3" onclick="execute(30, 16, 99)">고급</li>
<li class="menu4" onclick="execute(30, 16, 120, 2)">초고급</li>
<li class="menu5" onclick="execute(30, 16, 160, 3)">😱급</li>
<li class="menu6" onclick="execute(30, 16, 220, 4)">💀급</li>
<li class="menu7" onclick="execute(30, 16, 420, 4)">☠️급</li>
<li class="menu8" onclick="execute(30, 16, 530, 5)">☠️☠️</li>
    </ul>

    <div class="window-content">
    <div class="mine-head-area">
        <div class="mine-counter">
            <div class="digit digit-0"></div>
            <div class="digit digit-0"></div>
            <div class="digit digit-0"></div>
        </div>
        <div class="mine-reset-button" onclick="minefield.reset_board()">
            <div class="mine-reset-button-inner"></div>
        </div>
        <div class="mine-timer">
            <div class="digit digit-0"></div>
            <div class="digit digit-0"></div>
            <div class="digit digit-0"></div>
        </div>
    </div>
    <div id="mine-area" class="mine-area">
    </div>
    </div>
</div>

</div>
    
<div class="userctrl" style="margin:373px 0px 0px 0px;">
    <form>
        주문제작:가로
        <input type="text" id="x" min="1" step="1" style="width:40px;" value="30">
        세로
        <input type="text" id="y" min="1" step="1" style="width:40px;" value="16">
        1칸당 최대 지뢰 수
        <input type="text" id="m" min="1" max="5" step="1" style="width:40px;" value="1">
        전체 지뢰 수
        <input type="text" id="t" min="1" step="1" style="width:40px;" value="99">
        
        <input type="button" onclick="execute(document.getElementById('x').value, document.getElementById('y').value, document.getElementById('t').value, document.getElementById('m').value)" value="생성">
    </form>
</div><div>지뢰 수가 많으면 첫 버튼 누른 뒤 시간이 오래 걸리니 기다리기 바랍니다..
</div>

<script src="vendor/jquery.min.js"></script>
<script src="vendor/jquery-ui.min.js"></script>
<script src="jquery.mswin.js"></script>
<script src="jquery.mswin.listview.js"></script>
<script src="jquery.mswin.menu.js"></script>
<script src="mine.js"></script>

<script>
$('.window').window();
$('.listview').listview();
$('.desktop-listview').listview();
$('.menu-bar').menubar();
$('.taskbar ul.start').menubar({
    position_toplevel: {
        my: "left bottom",
        at: "left top",
    },
});

var update_counter = null;
var update_timer = null;

var timer_val = 0;
var timer_id = null;

var mine_area = document.getElementById("mine-area");
var minefield = new window.Minefield(mine_area, function(status) {
    var smile = $(".mine-reset-button .mine-reset-button-inner");
    var bg_pos = "0 0";
    if (status === -1) {
        bg_pos = "-17px 0";
    }
    if (status === -2) {
        bg_pos = "-51px 0";
    }
    if (status === 2) {
        bg_pos = "-34px 0";
    }
    smile.css({
        "background-position": bg_pos,
    });
    
    if (status === 0) {
        timer_id = window.setInterval(update_timer, 1 * 1000);
    }
    if (status < 0 || status === 1) {
        window.clearInterval(timer_id);
        if (status === 1) {
        	
            var num_counter = minefield.num_mines - minefield.num_flags;
            var counter_obj = $(".mine-counter");
            update_counter_mines(num_counter, counter_obj);

            timer_val = 0;
            timer_id = null;
            var timer_obj = $(".mine-timer");
            update_counter_timer(0, timer_obj);
        }
        if(status==-2){
        	var num_counter = minefield.num_mines - minefield.num_flags;
            var counter_obj = $(".mine-counter");
            update_counter_mines(num_counter, counter_obj);
        }
    }
},
function(status) {
    var smile = $(".mine-reset-button .mine-reset-button-inner");
    var bg_pos = "0 0";
    if (status === 1) {
        bg_pos = "-34px 0";
    }
    smile.css({
        "background-position": bg_pos,
    });

}
);

update_timer = function() {
    timer_val += 1;
    var timer_obj = $(".mine-timer");
    update_counter_timer(timer_val, timer_obj);
}

/** counter 안의 digit 자식 개수를 원하는 수로 맞춰줌 */
function ensure_digits(counter, count) {
  const cur = counter.children().length;
  if (cur < count) {
    for (let i = 0; i < count - cur; i++) {
      counter.append('<div class="digit digit-0"></div>');
    }
  } else if (cur > count) {
    for (let i = 0; i < cur - count; i++) {
      $(counter.children()[0]).remove();
    }
  }
}

/** 타이머 전용: 3자리 고정 (기존 동작 유지) */
function update_counter_timer(val, counter) {
  if (val > 999) val = 999;
  if (val < 0) val = 0; // 타이머는 음수 안 씀
  ensure_digits(counter, 3);
  const digits = [
    Math.floor(val / 100),
    Math.floor(val / 10) % 10,
    val % 10,
  ];
  for (let i = 0; i < 3; i++) {
    const d = digits[i];
    const child = $(counter.children()[i]);
    child.removeClass();
    child.addClass("digit digit-" + d);
  }
}

/** 지뢰카운터 전용: 기본 3자리, 필요 시 n자리로 자동 확장 */
function update_counter_mines(val, counter) {
  // N = max(3, digits of total mines)
  const totalMines = minefield.num_mines || 0;
  const N = Math.max(3, String(Math.abs(totalMines)).length);

  ensure_digits(counter, N);

  const isNeg = val < 0;

  if (isNeg) {
    const slots = N - 1;              // 숫자 표시 칸
    const maxAbs = Math.pow(10, slots) - 1;
    let absVal = Math.abs(val);
    if (absVal > maxAbs) absVal = maxAbs; // -99..9 로 클램프

    // 맨 앞: 마이너스
    let child = $(counter.children()[0]);
    child.removeClass();
    child.addClass("digit digit-10");

    // 나머지: 0패딩
    const padded = String(absVal).padStart(slots, "0");
    for (let i = 0; i < slots; i++) {
      const d = padded.charCodeAt(i) - 48;
      child = $(counter.children()[i + 1]);
      child.removeClass();
      child.addClass("digit digit-" + d);
    }
  } else {
    // 양수/0: N자리 0패딩
    const padded = String(val).padStart(N, "0");
    for (let i = 0; i < N; i++) {
      const d = padded.charCodeAt(i) - 48;
      const child = $(counter.children()[i]);
      child.removeClass();
      child.addClass("digit digit-" + d);
    }
  }

  // 줄바꿈 방지 + 폭 맞춤
  const digitWidth = 13; // CSS의 digit 폭(px)에 맞게 필요시 조정
  counter.css({
    width: (N * digitWidth) + "px",
    display: "flex",
    whiteSpace: "nowrap",
  });
}


minefield.on_rclick_func = function(x, y) {
    var num_counter = minefield.num_mines - minefield.num_flags;
    var counter_obj = $(".mine-counter");
    update_counter_mines(num_counter, counter_obj);
};

minefield.init_board(30, 16, 99, 1);
update_counter_mines(minefield.num_mines - minefield.num_flags, $(".mine-counter"));

</script>

</body>

</html>
