<!DOCTYPE html>
<html>

<head>
  <meta name="google-site-verification" content="sVA6QJSCCEozZiu7jjWZHOHMoLK4c4JN6ecoNAuG4bg" />
  <title>Minesweeper</title>
  <meta charset="utf-8" />
  <link href="mine.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="win98.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="mine-win98.css" media="screen" rel="stylesheet" type="text/css" />
  <style>
    /* ì˜¤ë²„ë ˆì´ ì• ë‹ˆë©”ì´ì…˜: 1ì´ˆ(1s) ë”œë ˆì´ í›„ opacity 1ë¡œ ë³€ê²½ */
    @keyframes delayedFadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    #loading-overlay.delayed-show {
      opacity: 0;
      /* ì‹œì‘ì€ íˆ¬ëª… */
      /* duration:0.1s, delay:1s */
      animation: delayedFadeIn 0.1s linear 1s forwards;
    }

    /* ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
    html,
    body {
      overflow-x: auto;
    }

    .windows {
      position: relative;
      overflow: visible;
      width: max-content;
      min-width: 100%;
    }

    .mine-window {
      position: relative;
      display: inline-block;
    }

    /* ì´ì¤‘ ì¹´ìš´í„°ìš© ì»¨í…Œì´ë„ˆ(ì•„ì´ì½˜+ì„¸ê·¸ë¨¼íŠ¸ ë‘ ì¤„) */
    .mine-counters-dual {
      display: inline-flex;
      flex-direction: column;
      gap: 2px;
    }

    .counter-row {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* ê¹ƒë°œ ì•„ì´ì½˜ (mine.pngëŠ” 160x256 ìŠ¤ì¼€ì¼ ê¸°ì¤€) */
    .counter-icon {
      width: 16px;
      height: 16px;
      background-image: url(mine.png);
      background-size: 160px 256px;
      image-rendering: pixelated;
      flex: 0 0 16px;
    }

    /* (ê²€ì€ì§€ë¢°ê¹ƒë°œ) ì›ë³¸(288,288~320,320) â†’ ì ˆë°˜ ì¢Œí‘œ(-144px,-144px) */
    .icon-flag-black {
      background-position: -144px -144px;
    }

    /* (í•˜ì–€ì§€ë¢°ê¹ƒë°œ) ì›ë³¸(0,288~32,320) â†’ ì ˆë°˜ ì¢Œí‘œ(0,-144px) */
    .icon-flag-white {
      background-position: 0px -144px;
    }

    .notice {
      margin: 10px 0 14px;
      padding: 10px 12px;
      border: 1px solid #b5b5b5;
      background: #fcfcfc;
      font-size: 13px;
      line-height: 1.55;
    }

    .notice h3 {
      margin: 0 0 6px;
      font-size: 14px;
    }

    .notice ul {
      margin: 6px 0 0 18px;
      padding: 0;
    }

    .notice li {
      margin: 2px 0;
    }

    .notice .warn {
      display: inline-block;
      padding: 0 6px;
      border-radius: 3px;
      background: #fff3cd;
      border: 1px solid #ffe69c;
    }

    /* --- Console ë¯¸ëŸ¬ íŒ¨ë„ --- */
    .console-panel {
      margin: 10px 0 18px;
      border: 1px solid #b5b5b5;
      background: #ffffff;
    }

    .console-panel .console-head {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      background: #f2f2f2;
      border-bottom: 1px solid #d0d0d0;
      font-size: 13px;
    }

    .console-panel .console-head .title {
      font-weight: 600;
      margin-right: auto;
    }

    .console-panel .console-head button,
    .console-panel .console-head label {
      font-size: 12px;
    }

    .console-panel .console-body {
      max-height: 220px;
      overflow: auto;
      background: #ffffff;
      font: 12px/1.5 monospace;
      padding: 8px;
      white-space: pre-wrap;
    }

    .console-line {
      padding: 1px 0;
    }

    .console-time {
      color: #888;
    }

    .console-lvl-log {
      color: #222;
    }

    .console-lvl-info {
      color: #146c94;
    }

    .console-lvl-warn {
      color: #a46c00;
    }

    .console-lvl-error {
      color: #b00020;
    }

    .ui-resizable-handle {
      display: none !important;
    }
    /*  ë©”ë‰´ í•­ëª© ë§í¬ì—ë§Œ ì ìš© (ë„ˆë¬´ ë„“ê²Œ ì¡ì§€ ì•Šê¸°) */
.menu .ui-menu-item > a {
  display: flex;
  align-items: center;
  gap: 16px;
}

/*  ì˜¤ë¥¸ìª½ ë‹¨ì¶•í‚¤ëŠ” auto marginìœ¼ë¡œ ìš°ì¸¡ ê³ ì • */
.menu .ui-menu-item > a .mi-key {
  margin-left: auto;
  flex: 0 0 auto;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;
  text-align: right;
  min-width: 3ch;
  opacity: 0.9;
}

.menu .ui-menu-item > a .mi-label { flex: 0 1 auto; }
/*  jQuery UIê°€ ì‹¤ì œë¡œ ìŠ¤íƒ€ì¼ì„ ë¨¹ì´ëŠ” wrapperë¥¼ ê°•ì œë¡œ ì¢Œì¸¡ì •ë ¬ + flex */
.menu .ui-menu-item > .ui-menu-item-wrapper,
.menu .ui-menu-item > a.ui-menu-item-wrapper {
  display: flex !important;
  align-items: center;
  justify-content: flex-start !important;
  width: 100% !important;
  box-sizing: border-box;
  text-align: left !important;
}

/*  ë¼ë²¨ì€ ì™¼ìª½, ë‹¨ì¶•í‚¤ëŠ” ì˜¤ë¥¸ìª½ */
.menu .ui-menu-item-wrapper .mi-label { 
  flex: 1 1 auto;
  text-align: left;
}
.menu .ui-menu-item-wrapper .mi-key {
  margin-left: auto;
  flex: 0 0 auto;
  min-width: 3ch;
  text-align: right;
}

/*  ì„œë¸Œë©”ë‰´ í™”ì‚´í‘œ(â–¶)ê°€ ìˆëŠ” í•­ëª©ë„ ë¼ë²¨ì´ ë°€ë ¤ â€œì˜¤ë¥¸ìª½ ì •ë ¬ì²˜ëŸ¼â€ ë³´ì´ì§€ ì•Šê²Œ */
.menu .ui-menu-item-wrapper {
  position: relative;
  padding-right: 18px; /* í™”ì‚´í‘œ ìë¦¬ í™•ë³´ */
}
.menu .ui-menu-item-wrapper .ui-menu-icon {
  position: absolute;
  right: 4px;
  top: 50%;
  transform: translateY(-50%);
}
/*  ì„œë¸Œë©”ë‰´ í™”ì‚´í‘œ(span.ui-menu-icon)ê°€ ê³µê°„ì„ ì°¨ì§€í•˜ì§€ ì•Šê²Œ */
.menu .ui-menu-item > .ui-menu-item-wrapper,
.menu .ui-menu-item > a.ui-menu-item-wrapper {
  position: relative; 
  padding-right: 18px !important; 
}

/* jQuery UI submenu arrow */
.menu .ui-menu-icon.ui-icon {
  position: absolute !important;  
  right: 4px;
  top: 50%;
  transform: translateY(-50%);
  margin: 0 !important;
  flex: 0 0 auto !important;      
  pointer-events: none;         
}
/*  (í…Œë§ˆ/ì¹˜íŠ¸) "ì„œë¸Œë©”ë‰´" í­ì„ ë‚´ìš©ì— ë§ì¶° ìë™ í™•ì¥ + ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
li.menu_theme > ul.menu,
li.menu_cheat > ul.menu {
  width: max-content !important; 
  min-width: 220px !important; 
}

/*  ë©”ë‰´ í•­ëª© í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€(ë¼ë²¨/ë‹¨ì¶•í‚¤/ì „ì²´) */
li.menu_theme > ul.menu .ui-menu-item-wrapper,
li.menu_cheat > ul.menu .ui-menu-item-wrapper,
li.menu_theme > ul.menu .mi-label,
li.menu_cheat > ul.menu .mi-label,
li.menu_theme > ul.menu .mi-key,
li.menu_cheat > ul.menu .mi-key,
.menu,
.menu .ui-menu-item-wrapper,
.menu .mi-label,
.menu .mi-key{
  white-space: nowrap !important;
}

/* (ì„ íƒ) í‚¤/í™”ì‚´í‘œ ìë¦¬ ë•Œë¬¸ì— ì˜¤ë¥¸ìª½ì´ ë‹µë‹µí•˜ë©´ ì—¬ìœ ë¥¼ ë” ì¤Œ */
li.menu_theme > ul.menu .ui-menu-item-wrapper,
li.menu_cheat > ul.menu .ui-menu-item-wrapper {
  padding-right: 40px !important;
}


.menu .ui-menu-item-wrapper {
  flex-wrap: nowrap !important;
}

/*  ì„œë¸Œë©”ë‰´ í­ì´ ë‚´ìš©ì— ë§ê²Œ ëŠ˜ì–´ë‚˜ê²Œ */
.menu {
  width: max-content !important;
  min-width: 220px !important; /* ì·¨í–¥ëŒ€ë¡œ */
}

/*  í™”ì‚´í‘œ ìë¦¬ ë•Œë¬¸ì— ë‹µë‹µí•˜ë©´ ì—¬ìœ  */
.menu .ui-menu-item-wrapper {
  padding-right: 40px !important;
}
/* íƒ€ì´í‹€ë°” ê¸°ì¤€ì  */
.mine-window .title-bar{
  position: relative;
}

/*  íƒ€ì´í‹€ì€ ì•„ì´ì½˜ê³¼ ë²„íŠ¼ ì‚¬ì´ ì˜ì—­ì„ â€œì§ì ‘ ì§€ì •â€ */
.mine-window .title-bar .title{
  position: absolute;
  left: 19.7px;   
  right: 56px;  
  top: 0;
  bottom: 0;
  display: flex;
  align-items: center;

  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
/* 3D ë‚œì´ë„ ë©”ë‰´ëŠ” ê¸°ë³¸ ìˆ¨ê¹€ (inline displayë„ ì´ê¹€) */
.menu-3d-only { display: none !important; }

/* 3D í…Œë§ˆì¼ ë•Œë§Œ í‘œì‹œ */
body.theme-3d .menu-3d-only { display: list-item !important; }


  </style>
</head>

<body>
  <div id="loading-overlay"
    style="display:none; opacity:0;position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:9999; background:silver; border:2px outset white; padding:2px; box-shadow:2px 2px 10px rgba(0,0,0,0.5);">
    <div
      style="border:2px inset white; padding:5px 5px; text-align:center; font-family:'êµ´ë¦¼', sans-serif; font-size:12px;">
      <strong>â³...</strong><br><br>
    </div>
  </div>

  <div id="hscroll-guard" style="height:1px;width:0;overflow:hidden;"></div>
  <script>
    function is3DDifficultyIndex(idx){
  idx = idx | 0;
  return idx >= 16 && idx <= 22; // menu16~menu22
}
function setMenuText(liSelector, label, keyText = "") {
  const li = document.querySelector(liSelector);
  if (!li) return;

  // jQuery UIê°€ wrapperë¥¼ ë§Œë“¤ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš©
  const wrap = li.querySelector(".ui-menu-item-wrapper") || li.querySelector("a");
  if (!wrap) return;

  //  "ëª©ì°¨" ê°™ì€ ì”ì—¬ í…ìŠ¤íŠ¸ ë…¸ë“œ ì œê±° (submenu í™”ì‚´í‘œëŠ” ìœ ì§€)
  [...wrap.childNodes].forEach(n => {
    if (n.nodeType === Node.TEXT_NODE) n.remove();
    // í˜¹ì‹œ ê¹¨ì§„ ë§ˆí¬ì—…ìœ¼ë¡œ ìƒê¸´ span ë“±ë„ ì •ë¦¬ (í•„ìš” ìµœì†Œë§Œ)
    if (n.nodeType === Node.ELEMENT_NODE) {
      const el = n;
      const keep =
        el.classList.contains("mi-label") ||
        el.classList.contains("mi-key") ||
        el.classList.contains("ui-menu-icon");
      if (!keep && el.tagName !== "A") {
        // ì¼ë°˜ì ìœ¼ë¡œëŠ” spanë§Œ ìƒê¸°ë¯€ë¡œ ì œê±°í•´ë„ ì•ˆì „
        // (í˜¹ì‹œ ìœ ì§€í•  ìš”ì†Œê°€ ë” ìˆìœ¼ë©´ keep ì¡°ê±´ì— ì¶”ê°€)
      }
    }
  });

  let lab = wrap.querySelector(".mi-label");
  let key = wrap.querySelector(".mi-key");

  if (!lab) {
    lab = document.createElement("span");
    lab.className = "mi-label";
    // í™”ì‚´í‘œê°€ ìˆìœ¼ë©´ ê·¸ ì•ì—, ì—†ìœ¼ë©´ ë§¨ ì•ì—
    const icon = wrap.querySelector(".ui-menu-icon");
    wrap.insertBefore(lab, icon || wrap.firstChild);
  }

  if (!key) {
    key = document.createElement("span");
    key.className = "mi-key";
    wrap.appendChild(key);
  }

  lab.textContent = label;
  key.textContent = keyText;
}

    (function () {
      console.log("â˜… Global Event Script Loaded");

      // 1. ë§ˆìš°ìŠ¤ ëˆ„ë¦„ ê°ì§€ (ìº¡ì²˜ë§ ëª¨ë“œ: true)
      window.addEventListener('mousedown', function (e) {

        // ì¢Œí´ë¦­(0)ë§Œ ì²˜ë¦¬
        if (e.button !== 0 && e.button !== 1) return;

        // í´ë¦­ëœ ìš”ì†Œê°€ ì§€ë¢°ì°¾ê¸° ìœˆë„ìš°(.mine-window) ë‚´ë¶€ì— ìˆëŠ”ì§€ í™•ì¸
        var targetWin = e.target.closest('.mine-window');
        if (!targetWin) return;
        if (e.button === 1 || e.button === 2) {
          e.preventDefault();
          // preventDefaultë¥¼ í•´ë„ JS ì´ë²¤íŠ¸ ì „íŒŒëŠ” ê³„ì†ë˜ë¯€ë¡œ ê²Œì„ ë¡œì§(Chording)ì€ ì •ìƒ ì‘ë™í•¨
        }
        if (e.target.closest('.menu-bar') || e.target.closest('.title-bar')) {
          return;
        }

        // â˜… [ìˆ˜ì •] í´ë¦­ëœ ìš”ì†Œê°€ 'ì–¼êµ´ ë²„íŠ¼' ìì‹ ì´ë¼ë©´ ì—¬ê¸°ì„œ ì¤‘ë‹¨!
        // ì–¼êµ´ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•ŒëŠ” 'O' í‘œì •ì´ ì•„ë‹ˆë¼, CSSì˜ :active íš¨ê³¼(ë²„íŠ¼ ëˆŒë¦¼)ê°€ ë‚˜ì™€ì•¼ í•¨
        if (e.target.closest('.mine-reset-button')) {
          return;
        }

        // ê²Œì„ ê°ì²´ê°€ ì—†ê±°ë‚˜, ê²Œì„ ì¢…ë£Œ ìƒíƒœ(-1:íŒ¨ë°°, -2:ìŠ¹ë¦¬)ë¼ë©´ ë°˜ì‘í•˜ì§€ ì•ŠìŒ (ì§„í–‰ì¤‘ 1, ëŒ€ê¸° 0)
        if (!window.minefield || window.minefield.game_status < 0) return;

        // ì–¼êµ´ ì•„ì´ì½˜ì„ ì°¾ì•„ ê°•ì œë¡œ 'O' í‘œì •(-48px) ì ìš©
        var faceIcon = document.querySelector(".mine-reset-button .mine-reset-button-inner");
        if (faceIcon) {
          // ê¸°ì¡´ CSS(:active)ë¥¼ ë®ì–´ì“°ê¸° ìœ„í•´ !important ì‚¬ìš©
          faceIcon.style.setProperty("background-position", "-48px 0", "important");
        }
      }, true); // true: ìº¡ì²˜ë§


      // 2. ë§ˆìš°ìŠ¤ ë—Œ ê°ì§€ (ìº¡ì²˜ë§ ëª¨ë“œ: true)
      window.addEventListener('mouseup', function (e) {
        if (!window.minefield) return;

        // A. ìƒì„± ì¤‘(ëª¨ë˜ì‹œê³„)ì¼ ë•ŒëŠ” ì–¼êµ´ì„ ë¦¬ì…‹í•˜ì§€ ì•Šê³  ìœ ì§€ (mine.js ë¡œì§ ì—°ë™)
        if (window.minefield._is_generating) return;

        // B. ê²Œì„ì´ ëë‚œ ìƒíƒœê°€ ì•„ë‹ˆë¼ë©´ ì›ƒëŠ” ì–¼êµ´ë¡œ ë³µêµ¬
        if (window.minefield.game_status >= 0) {
          var faceIcon = document.querySelector(".mine-reset-button .mine-reset-button-inner");
          if (faceIcon) {
            // ê°•ì œ ìŠ¤íƒ€ì¼ ì œê±° -> CSS ê¸°ë³¸ê°’(ì›ƒëŠ” ì–¼êµ´ 0 0)ë¡œ ë³µê·€
            faceIcon.style.removeProperty("background-position");

            // ì•ˆì „ì¥ì¹˜: JSë¡œë„ ëª…ì‹œì  ì´ˆê¸°í™”
            faceIcon.style.backgroundPosition = "0 0";
          }
        }
      }, true); // true: ìº¡ì²˜ë§
    })();
  </script>
  <script>
    function updateHScrollGuard() {
      const win = document.querySelector('.mine-window');
      const guard = document.getElementById('hscroll-guard');
      if (win && guard) guard.style.width = (win.offsetWidth + 32) + 'px';
    }
    window.addEventListener('resize', updateHScrollGuard);

    /* ===== ê³µí†µ ìœ í‹¸: ìˆ«ì/í´ë¨í”„/ìƒí•œ ê³„ì‚° ===== */
    function toInt(v, d = 0) { v = parseInt(v); return isNaN(v) ? d : v; }
    function clamp(v, lo, hi) { return Math.min(hi, Math.max(lo, v)); }

    // capBlackTotal = (cells-1)*maxBlackPerCell
    // capWhiteTotal = capBlackTotal - blackTotal(ìµœì¢…ê°’), ìŒìˆ˜ë©´ 0
    function calcCaps(cols, rows,depth, maxBlackPerCell, blackTotalNow, maxWhitePerCell = 0) {
      // 1) ì „ì²´ ì¹¸ìˆ˜ ë° ê²€ì€ì§€ë¢° ì´ ìˆ˜ìš©ëŸ‰
      const C = Math.max(3, cols | 0);
      const R = Math.max(1, rows | 0);
      const D = Math.max(1, depth | 0);
      const cells = C * R * D;

      const capBlackPerCell = Math.max(1, maxBlackPerCell | 0);
      const capBlackTotal = Math.max(0, (cells - 1) * capBlackPerCell);

      // 2) ê²€ì€ì§€ë¢°ê°€ ìµœì†Œë¡œ ì ìœ í•´ì•¼ í•˜ëŠ” ì¹¸ ìˆ˜
      const blackUsed = Math.min(Math.max(0, blackTotalNow | 0), capBlackTotal);
      const minBlackCells = Math.ceil(blackUsed / capBlackPerCell);

      // 3) í°ì§€ë¢°ë¥¼ ë„£ì„ ìˆ˜ ìˆëŠ” ì¹¸ ìˆ˜
      const whitePlaceableCells = Math.max(0, (cells - 1) - minBlackCells);

      // 4) ì¹¸ë‹¹ í°ì§€ë¢° ìˆ˜ìš©ëŸ‰ì„ ê³±í•´ ìµœëŒ€ í°ì§€ë¢° ì´ëŸ‰
      const capWhitePerCell = Math.max(0, maxWhitePerCell | 0);
      const capWhiteTotal = whitePlaceableCells * capWhitePerCell;

      return { capBlackTotal, capWhiteTotal };
    }

    // í¼ ì…ë ¥ì— ì‹¤ì‹œê°„ ì ìš©: ìƒí˜¸ ì˜ì¡´ ìƒí•œ ë³´ì •
    function applyFormCaps() {
      const cols = toInt(x.value, 3);
      const rows = toInt(y.value, 1);
      const depth = toInt(z.value, 1);
      // 1) ì¹¸ë‹¹ ìµœëŒ€ ê²€ì€ì§€ë¢°ìˆ˜ (1~6)
      let maxBlackPerCell = clamp(toInt(m.value, 1), 1, 6);
      if (toInt(m.value, 1) < 0 || toInt(m.value, 1) > 6) m.value = maxBlackPerCell;

      // 2) ì¹¸ë‹¹ ìµœëŒ€ í°ì§€ë¢°ìˆ˜ (0~6)  â† idëŠ” wm ì´ ë§ìŠµë‹ˆë‹¤.
      let maxWhitePerCell = clamp(toInt(wm.value, 0), 0, 6);
      if (toInt(wm.value, 0) < 0 || toInt(wm.value, 0) > 6) wm.value = maxWhitePerCell;

      // 3) ê²€ì€ ì´ìˆ˜ ë³´ì •
      let k = Math.max(1, toInt(t.value, 1));
      let caps = calcCaps(cols, rows, depth, maxBlackPerCell, k, maxWhitePerCell);
      if (k > caps.capBlackTotal) k = caps.capBlackTotal;
      if (toInt(t.value, 1) < 0 || toInt(t.value, 1) > k) t.value = k;

      // 4) í° ì´ìˆ˜ ë³´ì • (ê²€ì€ í™•ì •ì¹˜ ì‚¬ìš©)
      caps = calcCaps(cols, rows, depth, maxBlackPerCell, k, maxWhitePerCell);
      let whiteTotal = Math.max(0, toInt(wt.value, 0));
      if (whiteTotal > caps.capWhiteTotal) whiteTotal = caps.capWhiteTotal;
      wt.value = whiteTotal;

      // 5) max íŒíŠ¸ ë™ê¸°í™”
      t.max = String(caps.capBlackTotal);
      wt.max = String(caps.capWhiteTotal);
    }

    /* ---------- ì‹¤í–‰ í•¨ìˆ˜ (í°ìƒ‰ ì§€ë¢° ì§€ì›) ---------- */
    var execute = function (i, j, k, l = 1, whiteTotal = 0, whiteMax = 0, aiLevel = null, depth = 1) {
      //setActiveDifficulty(23);
      // 1) ì…ë ¥ ì •ê·œí™”
      i = Math.max(3, toInt(i, 3)); j = toInt(j, 1); 
      k = toInt(k, 1); l = clamp(toInt(l, 1), 1, 6);
      whiteTotal = Math.max(0, toInt(whiteTotal, 0));
      whiteMax = clamp(toInt(whiteMax, 0), 0, 6);
      depth = Math.max(1, toInt(depth, 1));
      depth = is3DTheme() ? depth : 1;
      // 1-1) ì§€ëŠ¥í˜• ìƒì„± ìˆ˜ì¤€ í™•ì • (ê¸°ë³¸ê°’ 0)
      if (aiLevel === null || typeof aiLevel === "undefined") {
        aiLevel = toInt(document.getElementById('ai')?.value, 0);
      } else {
        aiLevel = toInt(aiLevel, 0);
      }
    if (is3DTheme()){
        aiLevel = 0;              // ëª¨ë“œ 0ë§Œ
      }
      // 2) ìƒí•œ ë³´ì •(ëª¨ë“  ê²½ë¡œì—ì„œ ë™ì¼í•˜ê²Œ ê°•ì œ)
      //    2-1) ê²€ì€ì§€ë¢° ì´ìˆ˜ k ë³´ì •
      let caps = calcCaps(i, j,depth, l, k, whiteMax);
      if (k > caps.capBlackTotal) k = caps.capBlackTotal;

      //    2-2) í°ì§€ë¢° ì´ìˆ˜ whiteTotal ë³´ì • (ê²€ì€ í™•ì •ì¹˜ ì‚¬ìš©)
      caps = calcCaps(i, j, depth, l, k, whiteMax);
      if (whiteTotal > caps.capWhiteTotal) whiteTotal = caps.capWhiteTotal;
      // 3) í¼ ê°’ ë°˜ì˜ + í¼ max íŒíŠ¸ ë°˜ì˜
      x.value = i; y.value = j; m.value = l; t.value = k;
      wm.value = whiteMax; wt.value = whiteTotal;
      const aiSel = document.getElementById('ai');
      if (aiSel) aiSel.value = String(aiLevel);

      t.max = String(caps.capBlackTotal);
      wt.max = String(caps.capWhiteTotal);


      /* ë³´ë“œ ìƒì„± (mine.jsê°€ 6ì¸ì ì§€ì› ì‹œ ê·¸ëŒ€ë¡œ ì „ë‹¬) */
if (is3DTheme()){
   stop2DTimerAndResetUI(); 
    stop2DAutoSolve();
    show3DBoard(true);

  //  3DëŠ” ì…€ í¬ê¸°(í”½ì…€)ë¥¼ ë”°ë¡œ ì“°ëŠ” êµ¬ì¡°ë¼ë©´ ì—¬ê¸°ì„œ í†µì¼
  const cellPx = 50;

  //  ì—¬ê¸°ì„œ ì‹¤ì œ ë³´ë“œ í¬ê¸°ë¥¼ i/j/depth/k/l/whiteTotal/whiteMaxë¡œ í™•ì •
  const cols = i;
  const rows = j;
  const dep  = depth;

  const minesTotal      = k;
  const minesPerCell    = l;
  const whitePerCell    = whiteMax;

    const hasWhite = whiteTotal > 0;
      const head = document.querySelector('.window-content .mine-head-area');
      if (head) head.style.height = hasWhite ? '58px' : '38px';

      const extraHead = hasWhite ? 20 : 0; // 58-38
  // ì°½ í¬ê¸° ì¡°ì ˆ (ê¸°ì¡´ 16 ê³ ì •ì€ ì˜¤ë™ì‘)
  $(".mine-window").not("#custom-win, #besttimes-win, #nameinput-win")
    .css({ width: 22 + cellPx * 16, height: 104 + cellPx * 16 });

  $(".mine-window").not("#custom-win, #besttimes-win, #nameinput-win")
    .find(".window-content .mine-head-area")
    .css({ width: 2 + cellPx * 16 });

      
      $(".mine-window").not("#custom-win, #besttimes-win, #nameinput-win")
      .find(".window-content .mine-area")
      .css({ "width": cellPx * 16, "height": cellPx * 16 });
      $(".inner").css({ "width": cellPx * 16, "height": cellPx * 16 });
      
      
        if (hasWhite) $(".mine-window").not("#custom-win, #besttimes-win, #nameinput-win").find(".window-content .mine-head-area .mine-reset-button").css({ "left": -4 + 8 * cellPx });
      else $(".mine-window").not("#custom-win, #besttimes-win, #nameinput-win").find(".window-content .mine-head-area .mine-reset-button").css({ "left": -11 + 8 * cellPx });
      
      
      $(".windows").css({ "height": (112 + extraHead) + cellPx * 16 });
  $("#mine-area-3d").css({ width: cellPx * 16, height: cellPx * 16 });
__threeD.lastInit = {
    cols, rows, depth: dep,
    mines: minesTotal,
    minespercell: minesPerCell,
    whitemines: whiteTotal,
    whiteminespercell: whitePerCell,
  };

  if (__threeD.ready) post3D({ type: "init", payload: __threeD.lastInit });
  else ensure3DIframe();

  updateHScrollGuard();
  return;
  }

  // ---- 2D ì •ìƒ ë™ì‘ ----
  show3DBoard(false);


      minefield.init_board(i, j, k, l, whiteTotal, whiteMax, aiLevel);



      // â–¼ ë…¸í”½ ëª¨ë“œì¼ ë•Œë§Œ ì½˜ì†” ë¯¸ëŸ¬ í‘œì‹œ
      const cp = document.getElementById('console-panel');
      if (cp) {
  
        cp.style.display = '';
        
      }


      /* ë ˆì´ì•„ì›ƒ: ì´ì¤‘ ì¹´ìš´í„°ë©´ í—¤ë” ë†’ì´/ì°½ ë†’ì´ë¥¼ í‚¤ì›€ */
      const hasWhite = whiteTotal > 0;
      const head = document.querySelector('.window-content .mine-head-area');
      if (head) head.style.height = hasWhite ? '58px' : '38px';

      const extraHead = hasWhite ? 20 : 0; // 58-38
      // ë©”ì¸ ì§€ë¢°ì°¾ê¸° ì°½ë§Œ í¬ê¸° ì¡°ì • (ì‚¬ìš©ìì§€ì • ì°½, ìµœê³ ê¸°ë¡ ì°½, ì´ë¦„ì…ë ¥ ì°½ ì œì™¸)
      $(".mine-window").not("#custom-win, #besttimes-win, #nameinput-win").css({ "width": 22 + i * 16, "height": (104 + extraHead) + j * 16 });
      $(".mine-window").not("#custom-win, #besttimes-win, #nameinput-win").find(".window-content .mine-head-area").css({ "width": 2 + i * 16 });
      $(".mine-window").not("#custom-win, #besttimes-win, #nameinput-win").find(".window-content .mine-area").css({ "width": i * 16, "height": j * 16 });
      $(".inner").css({ "width": i * 16, "height": j * 16 });
      
      
        if (hasWhite) $(".mine-window").not("#custom-win, #besttimes-win, #nameinput-win").find(".window-content .mine-head-area .mine-reset-button").css({ "left": -4 + 8 * i });
      else $(".mine-window").not("#custom-win, #besttimes-win, #nameinput-win").find(".window-content .mine-head-area .mine-reset-button").css({ "left": -11 + 8 * i });
      
      
      $(".windows").css({ "height": (112 + extraHead) + j * 16 });

      renderCounters(hasWhite);
      update_all_mine_counters();
      updateHScrollGuard();
    };
  </script>

  <div class="windows windows-98" style="height:365px;">
    <div class="window has-menu mine-window">
      <div class="title-bar">
        <div class="title-icon"></div>
        <div class="title">Minesweeper</div>
        <div class="title-button-group">
          <div class="title-button minimize"></div>
          <div class="title-button maximize disabled"
            onclick="event.preventDefault(); event.stopPropagation(); return false;"></div>
          <div class="title-button close"></div>
        </div>
      </div>
      <ul class="menu-bar">
        <li>
          <a href="#" data-access-key="g" class="menu151">ê²Œì„</a>
          <ul class="menu">
            <li class="menu0" onclick="return runMenu(() => {pressreset();});"><a href="#">
              <span class="mi-label">ã€€ìƒˆ ê²Œì„(N)</span>
              <span class="mi-key">F2</span>
            
            </a></li>
            <li class="separator"></li>
            <li class="menu1"
              onclick="return runMenu(() => {execute(9, 9, 10, 1, 0, 0, 2);setActiveDifficulty(1);  });"><a
                href="#">ã€€ì´ˆê¸‰(B)</a></li>
            <li class="menu2"
              onclick="return runMenu(() => {execute(16, 16, 40, 1, 0, 0, 2);setActiveDifficulty(2);  });"><a
                href="#">ã€€ì¤‘ê¸‰(I)</a></li>
            <li class="menu3"
              onclick="return runMenu(() => {execute(30, 16, 99, 1, 0, 0, 2);setActiveDifficulty(3);  });"><a href="#">âœ“
                ê³ ê¸‰(E)</a></li>
            <li class="menu_4" onclick="event.preventDefault(); event.stopPropagation(); return false;"
              style="cursor: default;">
              <a href="#" onclick="event.preventDefault(); event.stopPropagation(); return false;"
                style="cursor: default;">ã€€ê¸°íƒ€...</a>
              <ul class="menu">
                <li class="menu4"
                  onclick="return runMenu(() => {execute(30, 16, 120, 2, 0, 0, 2);setActiveDifficulty(4);  });"><a
                    href="#">ã€€ì´ˆê³ ê¸‰</a></li>
                <li class="menu5"
                  onclick="return runMenu(() => {execute(30, 16, 160, 3, 0, 0, 2);setActiveDifficulty(5);  });"><a
                    href="#">ã€€ğŸ˜±</a></li>
                <li class="menu6"
                  onclick="return runMenu(() => {execute(30, 16, 220, 4, 0, 0, 2);setActiveDifficulty(6); });"><a
                    href="#">ã€€ğŸ’€</a></li>
                <li class="menu7"
                  onclick="return runMenu(() => {execute(30, 16, 420, 4, 0, 0, 0);setActiveDifficulty(7);  });"><a
                    href="#">ã€€â˜ ï¸</a></li>
                <li class="menu8"
                  onclick="return runMenu(() => {execute(30, 16, 530, 5, 0, 0, 0);setActiveDifficulty(8);  });"><a
                    href="#">ã€€â˜ ï¸Ã—2</a></li>
                <li class="menu9"
                  onclick="return runMenu(() => {execute(30, 16, 680, 6, 0, 0, 0);setActiveDifficulty(9);  });"><a
                    href="#">ã€€â˜ ï¸Ã—3</a></li>
                <li class="menu10"
                  onclick="return runMenu(() => {execute(30, 16, 40, 1, 20, 1, 2);setActiveDifficulty(10);  });"><a
                    href="#">ã€€ìŒìˆ˜ì§€ë¢°</a></li>
                <li class="menu11"
                  onclick="return runMenu(() => {execute(30, 16, 110, 4, 30, 2, 2);setActiveDifficulty(11);  });"><a
                    href="#">ã€€ìŒìˆ˜ ì¤‘ê¸‰</a></li>
                <li class="menu12"
                  onclick="return runMenu(() => {execute(30, 16, 240, 6, 100, 6, 1);setActiveDifficulty(12);  });"><a
                    href="#">ã€€ìŒìˆ˜ ê³ ê¸‰</a></li>
                <li class="menu13"
                  onclick="return runMenu(() => {execute(118, 58, 1412, 1, 0, 0, 0);setActiveDifficulty(13);  });"><a
                    href="#">ã€€ëŒ€í˜•</a></li>
                <li class="menu14"
                  onclick="return runMenu(() => {execute(640, 480, 63300, 1, 0, 0, 0);setActiveDifficulty(14);  });"><a
                    href="#">ã€€ì´ˆëŒ€í˜•</a></li>
                <li class="menu15"
                  onclick="return runMenu(() => {execute(1280, 720, 192000, 1, 0, 0, 0);setActiveDifficulty(15);  });">
                  <a href="#">ã€€íŠ¹ëŒ€í˜•</a></li>
                
                <li class="menu-3d-only menu16"
                  onclick="return runMenu(() => {execute(7, 7, 10, 1, 0, 0, 0,7);setActiveDifficulty(16);  });"><a
                    href="#">ã€€3D ì†Œí˜•</a></li>
                <li class="menu-3d-only menu17"
                  onclick="return runMenu(() => {execute(15, 10, 99, 1, 0, 0, 0,10);setActiveDifficulty(17);  });"><a
                    href="#">ã€€3D ì¤‘í˜•</a></li>
                <li class="menu-3d-only menu18"
                  onclick="return runMenu(() => {execute(15, 12, 180, 1, 0, 0, 0,12);setActiveDifficulty(18);  });"><a
                    href="#">ã€€3D ëŒ€í˜•</a></li>
                <li class="menu-3d-only menu19"
                  onclick="return runMenu(() => {execute(15, 10, 500, 3, 0, 0, 0,10);setActiveDifficulty(19);  });"><a
                    href="#">ã€€3D ê³ ë‚œì´ë„</a></li>
                <li class="menu-3d-only menu20"
                  onclick="return runMenu(() => {execute(15, 10, 1000, 6, 0, 0, 0,10);setActiveDifficulty(20);  });"><a
                    href="#">ã€€3D ì´ˆê³ ë‚œì´ë„</a></li>
                <li class="menu-3d-only menu21"
                  onclick="return runMenu(() => {execute(15, 10, 80, 1, 30, 1, 0,10);setActiveDifficulty(21);  });"><a
                    href="#">ã€€3D ìŒìˆ˜</a></li>
                <li class="menu-3d-only menu22"
                  onclick="return runMenu(() => {execute(15, 10, 300, 6, 150, 6, 0,10);setActiveDifficulty(22);  });"><a
                    href="#">ã€€3D ìŒìˆ˜ ê³ ë‚œì´ë„</a></li>
              </ul>
            </li>
            <li class="menu23" onclick="return runMenu(() => { openCustomDialog();setActiveDifficulty(23);});"><a
                href="#">ã€€ì‚¬ìš©ì ì§€ì •(C)...</a></li>
            <li class="separator"></li>

            <!-- ?í‘œì‹œ(Question marks) í† ê¸€ -->
            <li id="opt-qmark" class="checkable" onclick="return runMenu(() => toggleQuestionMarks());"><a href="#">âœ“ ?
                í‘œì‹œ(M)</a></li>

            <!-- Color í† ê¸€ -->
            <li id="opt-color" class="checkable" onclick="return runMenu(() => toggleColorMode());"><a href="#">âœ“ ì»¬ëŸ¬ë¡œ
                í‘œì‹œ(L)</a></li>

            <!-- Sound í† ê¸€ -->
            <li id="opt-sound" class="checkable" onclick="return runMenu(() => toggleSound());"><a href="#">ã€€ì†Œë¦¬(S)</a>
            </li>

            <!-- Theme ë©”ë‰´ ì¶”ê°€ -->
            <li class="menu_theme" onclick="event.preventDefault(); event.stopPropagation(); return false;"
              style="cursor: default;">
              <a href="#" onclick="event.preventDefault(); event.stopPropagation(); return false;"
                style="cursor: default;">ã€€í…Œë§ˆ...</a>
              <ul class="menu">
                <li class="theme-minesweeper" onclick="return runMenu(() => setTheme('minesweeper'));"><a href="#">âœ“ Minesweeper</a></li>
                <li class="theme-prato-xp" onclick="return runMenu(() => setTheme('prato-xp'));"><a href="#">ã€€Prato fiorito (XP)</a></li>
                <li class="theme-prato-2000" onclick="return runMenu(() => setTheme('prato-2000'));"><a href="#">ã€€Prato fiorito (2000)</a></li>
                <li class="theme-3d" onclick="return runMenu(() => setTheme('3d'));"><a href="#">ã€€3D</a></li>

              </ul>
            </li>

            <!--onclickì‹œ runMenuì—ì„œ window has-menu mine-window ui-resizable ui-draggableì˜ visibleì„ noneìœ¼ë¡œí•œë‹¤-->
            <li class="separator"></li>
            <li class="besttimes" onclick="return runMenu(() => printBestTimes());"><a href="#">ã€€ìµœê³  ê¸°ë¡(T)...</a></li>
            <li class="separator"></li>
            <li class="menuclose"
              onclick="return runMenu(() => { $('.has-menu.mine-window.ui-resizable.ui-draggable').css('visibility', 'hidden'); });">
              <a href="#">ã€€ëë‚´ê¸°(X)</a>
            </li>
          </ul>
        </li>

        <li>
          <a href="#" data-access-key="h" class="menu152">ë„ì›€ë§</a>
          <ul class="menu">
            <li class="menu102" onclick="return runMenu(() => openHelpContents());">
              <a href="#">
                <span class="mi-label">ã€€ëª©ì°¨(C)</span>
              <span class="mi-key">F1</span>
              
              </a>
            </li>
            <li class="menu100" onclick="return runMenu(() => openHelpContents());">
              <a href="#">ã€€ë„ì›€ë§ ê²€ìƒ‰(S)...</a>
            </li>
            <li class="menu103" onclick=""><a href="#">ã€€ë„ì›€ë§ ì‚¬ìš©(H)</a></li>
            <li class="separator"></li>
            <li class="menu_cheat" onclick="event.preventDefault(); event.stopPropagation(); return false;"
              style="cursor: default;">
              <a href="#" onclick="event.preventDefault(); event.stopPropagation(); return false;"
                style="cursor: default;">ã€€ì¹˜íŠ¸...</a>
              <ul class="menu">
                <li class="menu-autosolve"
                  onclick="return runMenu(() => document.getElementById('console-play').click());"><a href="#">
                  <span class="mi-label">ã€€ìë™ìœ¼ë¡œ í’€ê¸°</span>
              <span class="mi-key">F3</span>
                  </a></li>
                <li class="menu-hint" onclick="return runMenu(() => document.getElementById('console-hint').click());">
                  <a href="#">
                    <span class="mi-label">ã€€íŒíŠ¸ ì œê³µ</span>
              <span class="mi-key">F4</span>
                  
                  </a>
                </li>
              </ul>
            </li>
            <li class="menu101" onclick="return runMenu(() => alert(window.__APPNAME_SING || 'Minesweeper'));"><a href="#">ã€€ì§€ë¢° ì°¾ê¸° ì •ë³´(A)...</a>
            </li>

          </ul>
        </li>
      </ul>



      <div class="window-content">
        <div class="mine-head-area" style="height:38px;">
          <!-- ë‹¨ì¼ ì¹´ìš´í„°(ê¸°ë³¸) : ì ˆëŒ€ë°°ì¹˜ ê·¸ëŒ€ë¡œ ì‚¬ìš© -->
          <div id="counters-single" class="counters-single" style="">
            <div class="mine-counter" id="mine-counter-single">
              <div class="digit digit-0"></div>
              <div class="digit digit-0"></div>
              <div class="digit digit-0"></div>
            </div>
          </div>

          <!-- ì´ì¤‘ ì¹´ìš´í„°: ì»¨í…Œì´ë„ˆë§Œ ì ˆëŒ€ë°°ì¹˜, ë‚´ë¶€ ì¹´ìš´í„°ëŠ” flexë¡œ í­ ìë™ -->
          <div id="counters-dual" class="mine-counters-dual"
            style="display:none; position:absolute; top:4px; left:1px;">
            <div id="counter-row-black" class="counter-row" style="min-height:23px;">
              <div class="counter-icon icon-flag-black" title="ê²€ì€ ì§€ë¢°"></div>
              <div class="mine-counter" id="mine-counter-black"
                style="position:static; width:auto; height:23px; display:flex;">
                <div class="digit digit-0"></div>
                <div class="digit digit-0"></div>
                <div class="digit digit-0"></div>
              </div>
            </div>
            <div id="counter-row-white" class="counter-row" style="min-height:23px;">
              <div class="counter-icon icon-flag-white" title="í•˜ì–€(ìŒìˆ˜) ì§€ë¢°"></div>
              <div class="mine-counter" id="mine-counter-white"
                style="position:static; width:auto; height:23px; display:flex;">
                <div class="digit digit-0"></div>
                <div class="digit digit-0"></div>
                <div class="digit digit-0"></div>
              </div>
            </div>
          </div>

          <div class="mine-reset-button" onclick="resetBoard()">
            <div class="mine-reset-button-inner"></div>
          </div>

          <div class="mine-timer">
            <div class="digit digit-0"></div>
            <div class="digit digit-0"></div>
            <div class="digit digit-0"></div>
          </div>
        </div>

        <div id="mine-area-2d" class="mine-area"></div>
        <div id="mine-area-3d" class="mine-area" style="display:none; padding:0;"></div>

      </div>
    </div>
    <!-- Fake mswin Win98-style Custom Dialog -->
    <div id="custom-win" class="window mine-window customdialog">
      <div class="title-bar">
        <div class="title-icon"></div>
        <div class="title" id="custdialtitle">ì‚¬ìš©ì ì§€ì • ê²Œì„</div>
        <div class="title-button-group">
          <div class="title-button close" onclick="closeCustomDialog()"></div>
        </div>
      </div>
      <div class="window-content" style="padding:8px;">
        <form id="custom-form" onsubmit="submitCustomDialog(); return false;">
          <div id="customdial2" style="display:flex; flex-direction:column; gap:8px;">
            <!-- ìƒë‹¨: ì…ë ¥ì°½ë“¤ + ë²„íŠ¼ë“¤ -->
            <div style="display:flex; gap:8px;">
              <!-- ì™¼ìª½: ë†’ì´~ìµœëŒ€ìŒìˆ˜ì§€ë¢° ì…ë ¥ì°½ë“¤ -->
              <div style="display:grid; grid-template-columns: 100px 1fr; gap:6px 8px; align-items:center;">
                <label>ë†’ì´(H)</label>
                <input type="number" id="c-rows" min="1" max="9999" step="1" value="16" style="width:30px;">
                <label>ë„ˆë¹„(W)</label>
                <input type="number" id="c-cols" min="3" max="9999" step="1" value="30" style="width:30px;">
                <label id="lbl-depth1" style="display:none">ê¹Šì´(D)</label>
                <input type="number" id="c-depth" min="1" max="9999" step="1" value="1" style="width:30px; display:none;">
                <label>ì§€ë¢° ìˆ˜(M)</label>
                <input type="number" id="c-total" min="1" step="1" value="99" style="width:30px;">
                <label>ìµœëŒ€ì§€ë¢°/1ì¹¸</label>
                <input type="number" id="c-max" min="1" max="6" step="1" value="1" style="width:30px;">
                <label>ìŒìˆ˜ì§€ë¢° ìˆ˜</label>
                <input type="number" id="c-wtotal" min="0" step="1" value="0" style="width:30px;">
                <label>ìµœëŒ€ìŒìˆ˜ì§€ë¢°/1ì¹¸</label>
                <input type="number" id="c-wmax" min="0" max="6" step="1" value="0" style="width:30px;">
              </div>

              <!-- ì˜¤ë¥¸ìª½: ë²„íŠ¼ë“¤ (ì„¸ë¡œ ë°°ì¹˜) -->
              <div style="display:flex; flex-direction:column; gap:8px; justify-content:center;">
                <button type="submit" class="title-button" style="padding:2px 10px;">í™•ì¸</button>
                <div style="height:10px"> </div>
                <button type="button" class="title-button" onclick="closeCustomDialog()"
                  style="padding:2px 10px;">ì·¨ì†Œ</button>
              </div>
            </div>

            <!-- í•˜ë‹¨: ì§€ëŠ¥í˜• ìƒì„± -->
            <div style="display:grid; grid-template-columns: 100px 1fr; gap:6px 8px; align-items:center;">
              <label>ì§€ëŠ¥í˜• ìƒì„±</label>
              <select id="c-ai" style="width:90px;">
                <option value="0">0: ì°ê¸° í—ˆìš© + ìµœì†Œ êµ¬ì œ</option>
                <option value="1">1: ì°ê¸° í—ˆìš© + ì²«í´ë¦­ ì˜¤í”„ë‹ + ë¬´ì œí•œ êµ¬ì œ</option>
                <option value="2" selected>2: ì°ê¸° ì°¨ë‹¨(ëŠë¦¼)</option>
              </select>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Best Times Dialog -->
    <div id="besttimes-win" class="window mine-window customdialog">
      <div class="title-bar">
        <div class="title-icon"></div>
        <div class="title" id="besttimestitle">ì§€ë¢° ì°¾ê¸° ìµœê³  ê¸°ë¡</div>
        <div class="title-button-group">
          <div class="title-button close" onclick="closeBestTimes()"></div>
        </div>
      </div>
      <div class="window-content" style="padding:12px;">
        <div id="besttimes-content" style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px;">
          <!-- Best times will be populated here dynamically -->
        </div>
        <div style="display:flex; gap:8px; justify-content:center;">
          <button type="button" class="title-button" onclick="resetBestTimes()"
            style="padding:4px 16px;">ì›ë˜ëŒ€ë¡œ(R)</button>
          <button type="button" class="title-button" onclick="closeBestTimes()" style="padding:4px 16px;">í™•ì¸</button>
        </div>
      </div>
    </div>

    <!-- Name Input Dialog (No Title Bar) -->
    <div id="nameinput-win" class="mine-window"
      style="display:none; position:absolute; z-index:1200; background:#c0c0c0; border:2px outset #c0c0c0; padding:4px; width:100px; height:max-content; box-sizing:border-box;">
      <div
        style="text-align:center; align-items:center; height:100%; display:flex; flex-direction:column; justify-content:space-between;">
        <div id="nameinput-message"
          style="font-size:7px; line-height:1.1; margin:0; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:110px;">
        </div>
        <input type="text" id="nameinput-field"
          style="width:80px; padding:0; font-size:7px; margin:1px 0; border:1px solid #808080;" maxlength="20" />
        <button type="button" onclick="submitNameInput()"
          style="width:30px; padding:0; font-size:7px; margin:0; border:1px outset #c0c0c0;">OK</button>
      </div>
    </div>
  </div>

  <div id="userctrl" class="userctrl" style="margin:0">
    <form oninput="applyFormCaps()">
      <a>ì£¼ë¬¸ì œì‘:ê°€ë¡œ</a>
      <input type="number" id="x" min="3" max="9999" step="1" style="width:60px;" value="30">
      <a>ì„¸ë¡œ</a>
      <input type="number" id="y" min="1" max="9999" step="1" style="width:60px;" value="16">
      <a id="lbl-depth2" style="display:none;">ë†’ì´</a>
      <input type="number" id="z" min="1" max="9999" step="1" style="width:60px; display:none;" value="1">

      <a>1ì¹¸ë‹¹ ìµœëŒ€ ì§€ë¢° ìˆ˜</a>
      <input type="number" id="m" min="1" max="6" step="1" style="width:60px;" value="1">
      <a>ì „ì²´ ì§€ë¢° ìˆ˜</a>
      <input type="number" id="t" min="1" step="1" style="width:80px;" value="99">

      <!-- â–¼ ì¶”ê°€: í•˜ì–€ ì§€ë¢° ì…ë ¥(0 í—ˆìš©) -->
      <a>1ì¹¸ë‹¹ ìµœëŒ€ ìŒìˆ˜ì§€ë¢° ìˆ˜</a>
      <input type="number" id="wm" min="0" max="6" step="1" style="width:60px;" value="0">
      <a>ì „ì²´ ìŒìˆ˜ì§€ë¢° ìˆ˜</a>
      <input type="number" id="wt" min="0" step="1" style="width:80px;" value="0">
      <a>ì§€ëŠ¥í˜• ìƒì„±</a>
      <select id="ai" style="width:220px;" value="2">
        <option value="0">0: ì°ê¸° í—ˆìš© + ìµœì†Œ êµ¬ì œ</option>
        <option value="1">1: ì°ê¸° í—ˆìš© + ì²«í´ë¦­ ì˜¤í”„ë‹ + ë¬´ì œí•œ êµ¬ì œ</option>
        <option value="2" selected>2: ì°ê¸° ì°¨ë‹¨(ëŠë¦¼)</option>
      </select>
      <input type="button" onclick="setActiveDifficulty(23);execute(
          document.getElementById('x').value,
          document.getElementById('y').value,
          document.getElementById('t').value,
          document.getElementById('m').value,
          document.getElementById('wt').value,
          document.getElementById('wm').value,
          document.getElementById('ai').value,
          document.getElementById('z').value
        )" value="ìƒì„±">
      <input type="button" onclick="hideViaURL()" value="ë¬¸êµ¬ ìˆ¨ê¸°ê¸°">
    </form>
  </div>
  <!-- Placeholder div to maintain draggable area height when text is hidden -->
  <div id="userctrl-placeholder" style="display:none; visibility:hidden; height:0; overflow:hidden;"></div>
  <div id="heavy-notice" class="notice">
    <h3>ì•ˆë‚´ / ì„±ëŠ¥ ì£¼ì˜</h3>
    <ul>
      <li><strong>3Dì§€ë¢°ì°¾ê¸° ì¶œì‹œ:ê²Œì„-í…Œë§ˆì—ì„œ 3Dë¥¼ ì„ íƒí•˜ì„¸ìš”</strong></li>
      <li> ëª¨ë°”ì¼ì—ì„œ ì¡°ì‘:ì§§ê²Œ ëˆŒëŸ¬ ì¢Œí´ë¦­, ê¸¸ê²Œ ëˆŒëŸ¬ ìš°í´ë¦­, ì—´ë¦°ì¹¸ì„ ë”ë¸”í„°ì¹˜í•´ì„œ chording.</li>
      <li>ì²« í´ë¦­ ì§í›„ <span class="warn">íŒ ìƒì„±</span>ì— ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì§€ë¢° ìˆ˜â†‘, íŒ í¬ê¸°â†‘ì¼ìˆ˜ë¡ ì¦ê°€)</li>
      <ul>
        <li>ì´ˆëŒ€í˜•ê³¼ íŠ¹ëŒ€í˜• íŒì€ ì´ˆê¸°í™”ì— ì•½ 5~10ì´ˆê°€ ì†Œìš”ë©ë‹ˆë‹¤</li>
      </ul>
      <li><strong>ì°ê¸° íŒ¨í„´ ë°œìƒ í—ˆìš©ì˜ êµ¬ì œ ê¸°ëŠ¥ ê´€ë ¨</strong>
        <ul>
          <li>ë³µìˆ˜í•´ê°€ ì¡´ì¬í•˜ì—¬ ì°ê¸° ìƒí™©ì´ ë°œìƒí•˜ì˜€ê³ , ì‚¬ìš©ìê°€ ì§€ë¢°ì¹¸ì„ ì„ íƒí–ˆë”ë¼ë„ ì‚¬ìš©ìì˜ ì…ë ¥ì´ ì´ë¯¸ ê³µê°œëœ ì •ë³´ì— ëª¨ìˆœì„ ë§Œë“¤ì§€ ì•ŠëŠ”ë‹¤ë©´ ê·¸ ì¹¸ì— ì§€ë¢°ê°€ ì—†ë„ë¡ íŒì„ ìˆ˜ì •í•©ë‹ˆë‹¤</li>
          <li>í•˜ì§€ë§Œ ë¬´ì œí•œ êµ¬ì œëŠ” ë‚œì´ë„ë¥¼ ì‹¬ê°í•˜ê²Œ ë‚®ì¶¥ë‹ˆë‹¤</li>
        </ul>
      </li>
      <li><strong>ì°ê¸° íŒ¨í„´ ë°œìƒ ì°¨ë‹¨</strong> ëª¨ë“œ ì„±ëŠ¥ ì£¼ì˜:
        <ul>
          <li>ìŒìˆ˜ì§€ë¢°ê°€ ìˆìœ¼ë©´ ë§¤ìš° ëŠë¦½ë‹ˆë‹¤. (ì¤‘ê¸‰ í¬ê¸°ì˜ íŒ ì´ìƒì—ì„œ ë¹„ê¶Œì¥)</li>
          <li>1ì¹¸ë‹¹ ìµœëŒ€ ì§€ë¢° ìˆ˜ê°€ 4 ì´ìƒì´ë©´ ë§¤ìš° ëŠë¦½ë‹ˆë‹¤.</li>
          <li>ëŒ€í˜• ì´ìƒì˜ í° íŒì—ì„œëŠ” ë§¤ìš° ëŠë¦½ë‹ˆë‹¤.</li>
          <li>í•´ë‹¹ ëª¨ë“œëŠ” â€œì°ê¸° ì—†ëŠ” í’€ì´ ìˆœì„œâ€ë¥¼ í•­ìƒ ë³´ì¥í•©ë‹ˆë‹¤.</li>
        </ul>
      </li>

    </ul>
    <div id="console-panel" class="console-panel" style="display:none">
      <div class="console-head">
        <span class="title">ì‹¤ì‹œê°„ ë¡œê·¸ (Console mirror)</span>
        <label><input type="checkbox" id="console-autoscroll" checked> ìë™ ìŠ¤í¬ë¡¤</label>
        <button type="button" id="console-play">ìë™ìœ¼ë¡œ í’€ê¸°</button>
        <button type="button" id="console-hint">íŒíŠ¸ ì œê³µ</button>
        <button type="button" id="console-pause">ì½˜ì†” ì¼ì‹œì •ì§€</button>
        <button type="button" id="console-clear">ì½˜ì†” ë¹„ìš°ê¸°</button>
        <button type="button" id="console-copy">ì½˜ì†” ë‚´ìš© ë³µì‚¬</button>

      </div>
      <div class="console-body" id="console-body" aria-live="polite"></div>
    </div>
  </div>

  <script src="vendor/jquery.min.js"></script>
  <script src="vendor/jquery-ui.min.js"></script>
  <script src="jquery.mswin.js"></script>
  <script src="jquery.mswin.listview.js"></script>
  <script src="jquery.mswin.menu.js"></script>
  <script src="mine.js"></script>
  <script>
        function isKorean() {
      var lang = (navigator.language || navigator.userLanguage || "").toLowerCase();
      return lang.startsWith("ko");
    }
    function stop2DAutoSolve(){
  const mf = window.minefield;
  if (!mf) return;

  if (mf._macro_timer){
    clearInterval(mf._macro_timer);
    mf._macro_timer = null;
  }
  mf._macro_running = false;
  mf._macro_paused = false;

  // ì½˜ì†” ë¡œê·¸ ë²„í¼ flush (ìˆìœ¼ë©´)
  if (typeof __flushSolveLog === 'function') __flushSolveLog();

  // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì›ë³µ(ìˆìœ¼ë©´)
  const btn = document.getElementById('console-play');
  if (btn){
    const ko = (navigator.language || '').toLowerCase().startsWith('ko');
    btn.textContent = ko ? 'ìë™ìœ¼ë¡œ í’€ê¸°' : 'Solve Automatically';
  }
}

    function stop2DTimerAndResetUI(){
  if (timer_id) { window.clearInterval(timer_id); timer_id = null; }
  timer_val = 0;
  update_counter_timer(0, $(".mine-timer"));
}

    // ë©”ë‰´ì˜ ì²´í¬ ëª¨ì–‘ì„ ë‹¨ìˆœ í…ìŠ¤íŠ¸(âœ“)ë¡œ í‘œí˜„
    function updateQuestionMenuVisual() {
  const on = !!(window.minefield && window.minefield.question);
  setMenuText('#opt-qmark',
    (on ? 'âœ“ ' : 'ã€€') + (isKorean() ? '? í‘œì‹œ(M)' : 'Marks (?)'),
    ''
  );
  document.getElementById('opt-qmark')?.setAttribute('aria-checked', String(on));
}

    // Color ë©”ë‰´ ë¹„ì£¼ì–¼ ì—…ë°ì´íŠ¸
    function updateColorMenuVisual() {
  const on = !!(window.minefield && window.minefield.useColor);
  setMenuText('#opt-color',
    (on ? 'âœ“ ' : 'ã€€') + (isKorean() ? 'ì»¬ëŸ¬ë¡œ í‘œì‹œ(L)' : 'Color'),
    ''
  );
  document.getElementById('opt-color')?.setAttribute('aria-checked', String(on));
}


    // Sound ë©”ë‰´ ë¹„ì£¼ì–¼ ì—…ë°ì´íŠ¸
    function updateSoundMenuVisual() {
  const on = !!(window.minefield && window.minefield.soundEnabled);
  setMenuText('#opt-sound',
    (on ? 'âœ“ ' : 'ã€€') + (isKorean() ? 'ì†Œë¦¬(S)' : 'Sound'),
    ''
  );
  document.getElementById('opt-sound')?.setAttribute('aria-checked', String(on));
}




    // ?í‘œì‹œ í† ê¸€ â†’ minefield.question true/false
    function toggleQuestionMarks() {
      if (!window.minefield) return;
      // ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì†ì„± ì¶”ê°€, ìˆìœ¼ë©´ ë‹¨ìˆœ í† ê¸€
      if (typeof window.minefield.question === 'undefined') {
        window.minefield.question = true;
      } else {
        window.minefield.question = !window.minefield.question;
      }
      updateQuestionMenuVisual();
      if (is3DTheme()) post3D({ type:'config', usemark: !!window.minefield.question });
    }

    // Color í† ê¸€ â†’ ì´ë¯¸ì§€ íŒŒì¼ ì „í™˜
    function toggleColorMode() {
      // minefield ê°ì²´ê°€ ì—†ìœ¼ë©´ ìƒì„±
      if (!window.minefield) {
        window.minefield = {};
      }

      // ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì†ì„± ì¶”ê°€, ìˆìœ¼ë©´ ë‹¨ìˆœ í† ê¸€
      if (typeof window.minefield.useColor === 'undefined') {
        window.minefield.useColor = false; // í˜„ì¬ trueë¼ê³  ê°€ì •í•˜ê³  falseë¡œ í† ê¸€
      } else {
        window.minefield.useColor = !window.minefield.useColor;
      }

      // CSS ì´ë¯¸ì§€ ì°¸ì¡° ì „í™˜
      updateImageReferences(window.minefield.useColor);
      updateColorMenuVisual();

      console.log('Color mode toggled:', window.minefield.useColor);
      if (is3DTheme()) post3D({ type:'config', usecolor: !!window.minefield.useColor });
    }

    // Sound í† ê¸€
    function toggleSound() {
      // minefield ê°ì²´ê°€ ì—†ìœ¼ë©´ ìƒì„±
      if (!window.minefield) {
        window.minefield = {};
      }

      // ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì†ì„± ì¶”ê°€, ìˆìœ¼ë©´ ë‹¨ìˆœ í† ê¸€
      if (typeof window.minefield.soundEnabled === 'undefined') {
        window.minefield.soundEnabled = true; // ì²˜ìŒ í´ë¦­ì‹œ trueë¡œ ì„¤ì •
      } else {
        window.minefield.soundEnabled = !window.minefield.soundEnabled;
      }

      updateSoundMenuVisual();
      console.log('Sound mode toggled:', window.minefield.soundEnabled);
      if (is3DTheme()) post3D({ type:'sound', enabled: !!window.minefield.soundEnabled });

    }
 window.currentTheme = window.currentTheme || 'minesweeper';

    // í…Œë§ˆ ë©”ë‰´ ì²´í¬ í‘œì‹œìš©
    function updateThemeMenuVisual() {
  const current = window.currentTheme || 'minesweeper';
  const labels = {
  'minesweeper': 'Minesweeper',
  'prato-xp': 'Prato fiorito (XP)',
  'prato-2000': 'Prato fiorito (2000)',
  '3d': '3D',
};

const items = [
  { selector: 'li.theme-minesweeper', key: 'minesweeper' },
  { selector: 'li.theme-prato-xp',    key: 'prato-xp' },
  { selector: 'li.theme-prato-2000',  key: 'prato-2000' },
  { selector: 'li.theme-3d',          key: '3d' },
];

  items.forEach(it => {
    const checked = (current === it.key);
    setMenuText(it.selector, (checked ? 'âœ“ ' : 'ã€€') + labels[it.key], '');
  });
}


    // ì‹¤ì œ í…Œë§ˆ ë³€ê²½ í•¨ìˆ˜
    function setTheme(theme) {
      const prevIs3D = is3DTheme();                 // âœ… ë³€ê²½ ì „ ìƒíƒœ ì €ì¥
  const prevDiff = currentDifficultyLevel ?? 3; // âœ… í˜„ì¬ ë‚œì´ë„ë„ ì €ì¥
      const allowed = ['minesweeper', 'prato-xp', 'prato-2000', '3d'];
      if (!allowed.includes(theme)) theme = 'minesweeper';

      window.currentTheme = theme;
      document.body.classList.toggle('theme-3d', theme === '3d');

updateWindowTitle();
  show3DBoard(is3DTheme());
  syncDepthUI();
  syncAIModeUI();

      // ë©”ë‰´ ì²´í¬ ë°˜ì˜
      updateThemeMenuVisual();

      // ì´ë¯¸ì§€ / ì•„ì´ì½˜ ë‹¤ì‹œ ì ìš© (í˜„ì¬ ì»¬ëŸ¬ëª¨ë“œ ìœ ì§€)
      const useColor = !!(window.minefield && window.minefield.useColor);
      updateImageReferences(useColor);
        //if (opts.skipExecute) return;
              //syncDepthUI();//í•œë²ˆë” í•„ìš”
//syncAIModeUI(); // í•œë²ˆë” í•„ìš”
if (is3DTheme()){
  stop2DAutoSolve();
  // í˜„ì¬ í¼ ê°’ìœ¼ë¡œ 2D ì¬ìƒì„±(ì›í•˜ë©´)
   execute(x.value, y.value, t.value, m.value, wt.value, wm.value, ai.value, z.value);
}
else{
  if (is3DDifficultyIndex(currentDifficultyLevel ?? 0)) {
    setActiveDifficulty(1);
    execute(9, 9, 10, 1, 0, 0, 2, 1);
  } else {
    execute(x.value, y.value, t.value, m.value, wt.value, wm.value, ai.value, 1);
  }
}
    }
    // ì‚¬ìš´ë“œ ì¬ìƒ í•¨ìˆ˜
function playSound(soundFile) {
      if (!window.minefield || !window.minefield.soundEnabled) return;

      // í…Œë§ˆì— ë”°ë¼ gameover.wavë§Œ êµì²´
      let actualFile = soundFile;
      const theme = window.currentTheme || 'minesweeper';

      if (soundFile === 'gameover.wav') {
        if (theme === 'prato-xp') {
          actualFile = 'pgameover.wav';
        } else if (theme === 'prato-2000') {
          actualFile = 'qgameover.wav';
        }
      }

      try {
        const audio = new Audio(actualFile);
        audio.play().catch(err => console.warn('Sound playback failed:', err));
      } catch (err) {
        console.warn('Sound creation failed:', err);
      }
    }
    function isPratoTheme() {
  const t = window.currentTheme || 'minesweeper';
  return t === 'prato-xp' || t === 'prato-2000';
}
function updateWindowTitle() {
  const KO = isKorean();
  const prato = isPratoTheme();

  const nameSing = KO
    ? (prato ? 'ê½ƒ í”¼ëŠ” ì´ˆì›' : 'ì§€ë¢° ì°¾ê¸°')
    : (prato ? 'Flowery Meadow' : 'Minesweeper');

  const namePlural = KO
    ? (prato ? 'ê½ƒ í”¼ëŠ” ì´ˆì›' : 'ì§€ë¢° ì°¾ê¸°')
    : (prato ? 'Flowery Meadows' : 'Mine Sweepers');

  window.__APPNAME_SING = nameSing;
  window.__APPNAME_PLUR = namePlural;

  //  ì—¬ê¸° ì¶”ê°€: íƒ€ì´í‹€ë°” í…ìŠ¤íŠ¸ ì‹¤ì œ ë°˜ì˜
  const titleEl = document.querySelector('.mine-window .title-bar .title');
  if (titleEl) titleEl.textContent = nameSing;
 document.title = nameSing;


  // Help > About... ê°±ì‹ ì€ ê¸°ì¡´ëŒ€ë¡œ ìœ ì§€
  if (typeof setMenuText === 'function') {
    setMenuText(
      'li.menu101',
      KO ? `ã€€${nameSing} ì •ë³´(A)...` : `ã€€About ${nameSing}...`,
      ''
    );
  }
}
function buildMineSpriteSelectors(){
  const out = [];

  // base cell
  out.push("table.minetable td", "table.minetable td:active");

  const clsPairs = (prefix, from, to) => {
    for (let i = from; i <= to; i++){
      out.push(`table.minetable td.${prefix}${i}`, `table.minetable td.${prefix}${i}:active`);
    }
  };

  // wrong / mines / flags
  clsPairs("mine-wrong", 1, 6);
  clsPairs("mine-", 1, 6);
  clsPairs("flag-", 0, 6);

  // negative(anti) mine flags/mines
  clsPairs("flag-m", 1, 6);
  clsPairs("mine-m", 1, 6);

  // exploded
  clsPairs("mine-exploded", 1, 6);
  clsPairs("mine-exploded-m", 1, 6);

  // wrong negative
  clsPairs("mine-wrong-m", 1, 6);

  // empty / near
  out.push(
    "table.minetable td.empty", "table.minetable td.empty:active",
    "table.minetable td.near-0", "table.minetable td.near-0:active",
    'table.minetable td[class*="near-"]', 'table.minetable td[class*="near-"]:active'
  );

  return out.join(",\n");
}

    // ëª¨ë“  ì´ë¯¸ì§€ ì°¸ì¡°ë¥¼ ë³€ê²½í•˜ëŠ” í•¨ìˆ˜ (CSS í´ë˜ìŠ¤ ì¶”ê°€ ë°©ì‹)
       // ëª¨ë“  ì´ë¯¸ì§€ ì°¸ì¡°ë¥¼ ë³€ê²½í•˜ëŠ” í•¨ìˆ˜ (CSS í´ë˜ìŠ¤ ì¶”ê°€ ë°©ì‹)
    function updateImageReferences(useColor) {
      const suffix = useColor ? '' : 'b'; // ì»¬ëŸ¬: mineX.png, í‘ë°±: mineXb.png

      // í…Œë§ˆì— ë”°ë¼ ê¸°ë³¸ íŒŒì¼ ì´ë¦„ ê²°ì •
      const theme = window.currentTheme || 'minesweeper';
      let mineBase = 'mine';          // mine.png / mineb.png
      let iconFile = 'mine_icon.png'; // íƒ€ì´í‹€ë°” ì•„ì´ì½˜

      if (theme === 'prato-xp') {
        mineBase = 'pmine';           // pmine.png / pmineb.png
        iconFile = 'pmine_icon.png';
      } else if (theme === 'prato-2000') {
        mineBase = 'qmine';           // qmine.png / qmineb.png
        iconFile = 'qmine_icon.png';
      }

      // ê¸°ì¡´ ìŠ¤íƒ€ì¼ íƒœê·¸ê°€ ìˆìœ¼ë©´ ì œê±°
      const oldStyle = document.getElementById('color-mode-override');
      if (oldStyle) {
        oldStyle.remove();
      }

      // ìƒˆë¡œìš´ ìŠ¤íƒ€ì¼ íƒœê·¸ ìƒì„±
      const styleTag = document.createElement('style');
      styleTag.id = 'color-mode-override';
const spriteSelectors = buildMineSpriteSelectors();

styleTag.textContent = `
/* Dynamic color/theme override - ${useColor ? 'COLOR' : 'BLACK & WHITE'} / theme=${theme} */

${!useColor ? `
.window-content .mine-head-area .mine-reset-button .mine-reset-button-inner { border-color:#000000 !important; }
.window-content .mine-head-area { border-top-color:#000000 !important; border-left-color:#000000 !important; }
.window-content .mine-head-area .mine-counter,
.window-content .mine-head-area .mine-timer { border-top-color:#000000 !important; border-left-color:#000000 !important; }
.window-content .mine-head-area .mine-reset-button {
  border-top-color:#000000 !important; border-left-color:#000000 !important;
  border-bottom:1px solid #000000 !important; border-right:1px solid #000000 !important;
}
.window-content .mine-head-area .mine-reset-button:active { border-top-color:#000000 !important; border-left-color:#000000 !important; }
.window-content .mine-area { border-top-color:#000000 !important; border-left-color:#000000 !important; }
` : ''}

/* ì§€ë¢°íŒ ì…€ ìŠ¤í”„ë¼ì´íŠ¸ */
${spriteSelectors} {
  background-image: url(${mineBase}${suffix}.png) !important;
}

/* ì¹´ìš´í„° ì•„ì´ì½˜(ê¹ƒë°œ) */
.counter-icon { background-image: url(${mineBase}${suffix}.png) !important; }

/* ìˆ«ì ë””ìŠ¤í”Œë ˆì´ */
.window-content .mine-head-area .mine-counter .digit,
.window-content .mine-head-area .mine-timer .digit,
.digit { background-image: url(digit${suffix}.png) !important; }

/* ë¦¬ì…‹ ë²„íŠ¼ (ì–¼êµ´) */
.window-content .mine-head-area .mine-reset-button .mine-reset-button-inner {
  background-image: url(face${suffix}.png) !important;
  background-size: 120px 24px !important;
}
.window-content .mine-head-area .mine-reset-button:active .mine-reset-button-inner {
  background-position: -96px 0 !important;
}

/* íƒ€ì´í‹€ë°” ì•„ì´ì½˜ */
.title-bar .title-icon {
  background-image: url(${iconFile}) !important;
  image-rendering: pixelated;
}
`;

      

      document.head.appendChild(styleTag);

      console.log(`âœ“ Theme: ${theme}, Color mode: ${useColor ? 'COLOR' : 'B/W'}`);
      console.log(`âœ“ Using images: ${mineBase}${suffix}.png, digit${suffix}.png, face${suffix}.png, ${iconFile}`);
    }

    // ì´ˆê¸° ìƒíƒœ(ì›í•˜ë©´ ê¸°ë³¸ê°’ì„ trueë¡œ ì‹œì‘)
    document.addEventListener('DOMContentLoaded', function () {
      // minefield ê°ì²´ ì´ˆê¸°í™” (ì—†ìœ¼ë©´ ìƒì„±)
      if (!window.minefield) {
        window.minefield = {};
      }

      if (typeof window.minefield.question === 'undefined') {
        window.minefield.question = true;  // ê¸°ë³¸ ON (ì›í•˜ë©´ falseë¡œ ë°”ê¾¸ì„¸ìš”)
      }
      if (typeof window.minefield.useColor === 'undefined') {
        window.minefield.useColor = true;  // ê¸°ë³¸ ì»¬ëŸ¬ ëª¨ë“œ ON
      }
      if (typeof window.minefield.soundEnabled === 'undefined') {
        window.minefield.soundEnabled = false;  // ê¸°ë³¸ì ìœ¼ë¡œ í•´ì œ
      }

      updateQuestionMenuVisual();
      updateColorMenuVisual();
      updateSoundMenuVisual();
      updateThemeMenuVisual(); 
      document.body.classList.toggle('theme-3d', is3DTheme());

      updateImageReferences(window.minefield.useColor);
      updateWindowTitle(); // íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
      // ê¸°ì¡´ ë©”ë‰´ ì‹œìŠ¤í…œ í™œì„±í™”(ì´ë¯¸ ì‚¬ìš© ì¤‘ì´ë©´ ë¬´ì‹œ)
      if ($('.menu-bar').length) $('.menu-bar').menubar();
    });
    updateWindowTitle();
  </script>

  <script>
    /* GET íŒŒì„œ */
    function getQueryParams() {
      const p = new URLSearchParams(window.location.search);
      return {
        rows: p.get('rows'),
        cols: p.get('cols'),
        depth: p.get('depth'), 
        minespercell: p.get('minespercell'),
        mines: p.get('mines'),
        whiteminespercell: p.get('whiteminespercell'),
        whitemines: p.get('whitemines'),
        logic: p.get('logic'),
        hide: p.get('hide'),
        theme: p.get('theme'),
      };
    }
    function themeIdxToKey(idx){
      idx = idx|0;
      if (idx === 1) return 'prato-xp';
      if (idx === 2) return 'prato-2000';
      if (idx === 3) return '3d';
      return 'minesweeper'; // 0 or default
    }
    function themeKeyToIdx(key){
      if (key === 'prato-xp') return 1;
      if (key === 'prato-2000') return 2;
      if (key === '3d') return 3;
      return 0;
    }
    function hasCoreParams(q) {
      return q.rows !== null && q.cols !== null && q.minespercell !== null && q.mines !== null;
    }
    function getQueryDefault0(v) { const n = parseInt(v); return isNaN(n) ? 0 : n; }

    /* í•˜ë‹¨ ì…ë ¥ ìˆ¨ê¸°ê¸° */
    function hideUserInputs() {
      const u = document.getElementById('userctrl');
      const n = document.getElementById('heavy-notice');
      const placeholder = document.getElementById('userctrl-placeholder');

      // Calculate combined height before hiding
      let totalHeight = 0;
      if (u) {
        totalHeight += u.offsetHeight;
      }
      if (n) {
        totalHeight += n.offsetHeight;
      }

      // Hide the actual elements
      if (u) u.style.display = 'none';
      if (n) n.style.display = 'none';

      // Show placeholder with the same height to maintain draggable area
      if (placeholder && totalHeight > 0) {
        placeholder.style.display = 'block';
        placeholder.style.height = totalHeight + 'px';
      }
    }

    /* GET ë¦¬ë‹¤ì´ë ‰íŠ¸(ë³´ë‚´ê¸° ì „ì— ìƒí•œ ë³´ì •) */
    function hideViaURL() {
      let cols = clamp(toInt(x.value, 3), 3, 999999);
      let rows = clamp(toInt(y.value, 1), 1, 999999);
       let depth = clamp(toInt(z.value, 1), 1, 999999);
  if (!is3DTheme()) depth = 1;
      let mpc = clamp(toInt(m.value, 1), 1, 6);
      let mines = Math.max(1, toInt(t.value, 1));
      let wmpc = clamp(toInt(wm.value, 0), 0, 6);
      let wmines = Math.max(0, toInt(wt.value, 0));

      // ë³´ì • 1: ê²€ì€ ì´ìˆ˜
      let caps = calcCaps(cols, rows, depth,mpc, mines, wmpc);
      if (mines > caps.capBlackTotal) mines = caps.capBlackTotal;

      // ë³´ì • 2: í° ì´ìˆ˜(ê²€ì€ í™•ì •ì¹˜ ë°˜ì˜)
      caps = calcCaps(cols, rows, depth,mpc, mines, wmpc);
      if (wmines > caps.capWhiteTotal) wmines = caps.capWhiteTotal;

      // í¼ì—ë„ ë°˜ì˜(ì‹œê°ì  í”¼ë“œë°±)
      x.value = cols; y.value = rows; m.value = mpc; t.value = mines;
      wm.value = wmpc; wt.value = wmines;
      t.max = String(caps.capBlackTotal);
      wt.max = String(caps.capWhiteTotal);

      const u = new URL(window.location.href);
      // âœ… theme ì¸ë±ìŠ¤ ì¶”ê°€ (0,1,2,3)
  u.searchParams.set('theme', themeKeyToIdx(window.currentTheme || 'minesweeper'));

      u.searchParams.set('cols', cols);
      u.searchParams.set('rows', rows);
      u.searchParams.set('depth', depth);
      u.searchParams.set('minespercell', mpc);
      u.searchParams.set('mines', mines);
      u.searchParams.set('whiteminespercell', wmpc);
      u.searchParams.set('whitemines', wmines);
      // ì§€ëŠ¥í˜• ìƒì„± ìˆ˜ì¤€ í¬í•¨(ê¸°ë³¸ 0)
      let logic = toInt(document.getElementById('ai')?.value, 0);
      u.searchParams.set('logic', logic);
      // ìˆ¨ê¹€ í”Œë˜ê·¸ & ìºì‹œ ë°©ì§€ìš© íƒ€ì„ìŠ¤íƒ¬í”„
      u.searchParams.set('hide', '1');
      u.searchParams.set('ts', String(Date.now()));

      // ë’¤ë¡œê°€ê¸° íˆìŠ¤í† ë¦¬ë¥¼ ë‚¨ê¸°ì§€ ì•Šê³ , ê°•ì œ ìƒˆë¡œê³ ì¹¨ íš¨ê³¼
      window.location.replace(u.pathname + '?' + u.searchParams.toString());
    }

    /* ìœ í‹¸: digit DOM ìˆ˜ ë§ì¶”ê¸° */
    function ensure_digits(counter, count) {
      const cur = counter.children().length;
      if (cur < count) {
        for (let i = 0; i < count - cur; i++) counter.append('<div class="digit digit-0"></div>');
      } else if (cur > count) {
        for (let i = 0; i < cur - count; i++) $(counter.children()[0]).remove();
      }
    }
    /* íƒ€ì´ë¨¸(3ìë¦¬ ê³ ì •) */
    function update_counter_timer(val, counter) {
      if (val > 999) val = 999; if (val < 0) val = 0;
      ensure_digits(counter, 3);
      const digits = [Math.floor(val / 100), Math.floor(val / 10) % 10, val % 10];
      for (let i = 0; i < 3; i++) {
        const d = digits[i];
        const child = $(counter.children()[i]);
        child.removeClass(); child.addClass("digit digit-" + d);
      }
    }
    /* ìˆ«ì ì¹´ìš´í„°(ìë¦¿ìˆ˜ ê³ ì • ì§€ì›) */
    function update_counter_generic(val, counter, totalForWidth, fixedDigits) {
      let N = fixedDigits || Math.max(3, String(Math.abs(totalForWidth || val || 0)).length);
      ensure_digits(counter, N);
      const isNeg = val < 0;
      if (isNeg) {
        const slots = N - 1;
        const maxAbs = Math.pow(10, slots) - 1;
        let absVal = Math.abs(val);
        if (absVal > maxAbs) absVal = maxAbs;
        let child = $(counter.children()[0]);
        child.removeClass().addClass("digit digit-10");
        const padded = String(absVal).padStart(slots, "0");
        for (let i = 0; i < slots; i++) {
          const d = padded.charCodeAt(i) - 48;
          child = $(counter.children()[i + 1]);
          child.removeClass().addClass("digit digit-" + d);
        }
      } else {
        const padded = String(val).padStart(N, "0");
        for (let i = 0; i < N; i++) {
          const d = padded.charCodeAt(i) - 48;
          const child = $(counter.children()[i]);
          child.removeClass().addClass("digit digit-" + d);
        }
      }
      counter.css({ width: (N * 13) + "px", display: "flex", whiteSpace: "nowrap", height: "23px" });
    }

    /* ëª¨ë“ˆ ì „í™˜ */
    function renderCounters(hasWhite) {
      const single = document.getElementById('counters-single');
      const dual = document.getElementById('counters-dual');
      if (!single || !dual) return;
      if (hasWhite) {
        single.style.display = 'none'; dual.style.display = '';
        //div classê°€ mint-timerì¸ ê²ƒê³¼ mine-reset-buttonì¸ ê²ƒì˜ styleì˜ topì„ 16pxë¡œ ì„¤ì •
        const timer = document.querySelector('.mine-timer');
        if (timer) timer.style.top = '16px';
        const resetBtn = document.querySelector('.mine-reset-button');
        if (resetBtn) resetBtn.style.top = '16px';
      }
      else {
        single.style.display = ''; dual.style.display = 'none';
        //div classê°€ mint-timerì¸ ê²ƒê³¼ mine-reset-buttonì¸ ê²ƒì˜ styleì˜ topì„ 6pxë¡œ ì„¤ì •
        const timer = document.querySelector('.mine-timer');
        if (timer) timer.style.top = '6px';
        const resetBtn = document.querySelector('.mine-reset-button');
        if (resetBtn) resetBtn.style.top = '6px';
      }
    }

    /* ëª¨ë“  ì¹´ìš´í„° ê°±ì‹  */
    function update_all_mine_counters() {
      const hasWhite = (minefield.white_total || minefield.num_mines_white || 0) > 0;
      if (hasWhite) {
        const bTotal = (minefield.num_mines || 0);
        const wTotal = (minefield.white_total || minefield.num_mines_white || 0);
        const maxTotalAbs = Math.max(Math.abs(bTotal), Math.abs(wTotal));
        const N = Math.max(3, String(maxTotalAbs).length);
        const blackRemain = bTotal - (minefield.num_flags || 0);
        const whiteRemain = wTotal - (minefield.num_flags_white || 0);
        update_counter_generic(blackRemain, $("#mine-counter-black"), bTotal, N);
        update_counter_generic(whiteRemain, $("#mine-counter-white"), wTotal, N);
      } else {
        const remain = (minefield.num_mines || 0) - (minefield.num_flags || 0);
        update_counter_generic(remain, $("#mine-counter-single"), minefield.num_mines || 0);
      }
    }

    /* ìœˆë„ìš°/ë©”ë‰´ ì´ˆê¸°í™” â€” ìš”ì†Œê°€ ìˆì„ ë•Œë§Œ ì•ˆì „í•˜ê²Œ ì‹¤í–‰ */
    if ($('.window').length) $('.window').window();
    if ($('.listview').length) $('.listview').listview();
    if ($('.desktop-listview').length) $('.desktop-listview').listview();
    if ($('.menu-bar').length) $('.menu-bar').menubar();
    if ($('.taskbar ul.start').length) {
      $('.taskbar ul.start').menubar({ position_toplevel: { my: "left bottom", at: "left top" } });
    }

    /* íƒ€ì´ë¨¸ */
    var timer_val = 0, timer_id = null;
    var update_timer = function () {
      timer_val += 1;
      update_counter_timer(timer_val, $(".mine-timer"));
      // íƒ€ì´ë¨¸ê°€ ì¦ê°€í•  ë•Œ ì†Œë¦¬ ì¬ìƒ
      playSound('timer.wav');
    };

    /* Minefield ì¸ìŠ¤í„´ìŠ¤ */
    var mine_area = document.getElementById("mine-area-2d");

    var minefield = new window.Minefield(
      mine_area,
      function (status) {
        var smile = $(".mine-reset-button .mine-reset-button-inner");
        // ì–¼êµ´ ìœ„ì¹˜: 0=í‰ìƒì‹œ, -24px=ì£½ìŒ, -48px=ìƒê°ì¤‘, -72px=ìŠ¹ë¦¬, -96px=ëˆŒë¦¼(ê°•ì¡°)
        var bg = "0 0"; if (status === -1) bg = "-24px 0"; if (status === -2) bg = "-72px 0"; if (status === 2) bg = "-48px 0";
        smile.css({ "background-position": bg });

        if (status === 0) {
          timer_id = window.setInterval(update_timer, 1000);
          playSound('timer.wav');
          update_counter_timer(1, $(".mine-timer"));
        }
        if (status < 0 || status === 1) {
          window.clearInterval(timer_id);
          if (status === 1) {
            const hasWhite = (minefield.white_total || minefield.num_mines_white || 0) > 0;
            renderCounters(hasWhite);
            const head = document.querySelector('.window-content .mine-head-area');
            if (head) head.style.height = hasWhite ? '58px' : '38px';
            update_all_mine_counters();
            timer_val = 1; timer_id = null;
            // íƒ€ì´ë¨¸ê°€ ì¦ê°€í•  ë•Œ ì†Œë¦¬ ì¬ìƒ
            update_counter_timer(0, $(".mine-timer"));
          }
          if (status === -1) {
            // ê²Œì„ ì‹¤íŒ¨ ì‹œ (ì§€ë¢°ë¥¼ ë°Ÿì•˜ì„ ë•Œ) gameover.wav ì¬ìƒ
            playSound('gameover.wav');
          }
          if (status === -2) {
            update_all_mine_counters();
            // ê²Œì„ í´ë¦¬ì–´ ì‹œ clear.wav ì¬ìƒ
            playSound('clear.wav');
            // Save best time if this is a tracked difficulty level
            if (DIFFICULTY_LEVELS[currentDifficultyLevel]) {
              const level = DIFFICULTY_LEVELS[currentDifficultyLevel];
              const currentTime = timer_val;
              const bestTime = getBestTime(level);
              if (currentTime < bestTime) {
                // ìƒˆë¡œìš´ ê¸°ë¡ì´ë¯€ë¡œ ì´ë¦„ ì…ë ¥ ì°½ì„ ë„ì›€
                showNameInputDialog(level, currentTime);
              }
            }
          }
        }
      },
      function (status) {
        // â˜… ê²Œì„ì´ ëë‚œ ìƒíƒœ(-1: íŒ¨ë°°, -2: í´ë¦¬ì–´)ì—ì„œëŠ” ë®ì–´ì“°ì§€ ì•ŠìŒ
        if (minefield.game_status < 0) return;

        var smile = $(".mine-reset-button .mine-reset-button-inner");

        // status === 1: ì…€ ë²„íŠ¼ ëˆŒë¦¼ â†’ 3ë²ˆì§¸ ì–¼êµ´(-48px, thinking face)
        // status === 0: ì •ìƒ â†’ 1ë²ˆì§¸ ì–¼êµ´(0)
        // 5ë²ˆì§¸ ì–¼êµ´(-96px)ì€ CSS :activeë¡œ ì–¼êµ´ ë²„íŠ¼ ìì²´ê°€ ëˆŒë ¸ì„ ë•Œ í‘œì‹œ
        smile.css({ "background-position": (status === 1) ? "-48px 0" : "0 0" });
      }
    );

    /* ê¹ƒë°œ ìš°í´ë¦­ ì‹œ ì¹´ìš´í„° ê°±ì‹  */
    minefield.on_rclick_func = function () { update_all_mine_counters(); };



    /* GET ì¸ì ìë™ ì ìš© (ë¡œë“œ ì‹œì—ë„ ìƒí•œ ë³´ì • ê°•ì œ) */
    document.addEventListener('DOMContentLoaded', function () {
      const q = getQueryParams();
        // âœ… 1) theme ë¨¼ì € ì ìš©(ë³´ë“œ ì¬ìƒì„±ì€ ì—¬ê¸°ì„œ í•˜ì§€ ì•ŠìŒ)
          let themeIdx;
  if (q.theme !== null) {
    themeIdx = clamp(toInt(q.theme, 0), 0, 3);
  } else {
    const d = toInt(q.depth, 1);              // depthê°€ ì—†ìœ¼ë©´ 1ë¡œ ê°„ì£¼
    themeIdx = (d >= 2) ? 3 : 0;              // ê·œì¹™: (ì—†ìŒ/1)->0, (>=2)->3
  }
   setTheme(themeIdxToKey(themeIdx), { skipExecute: true });
      if (hasCoreParams(q)) {
        let cols = Math.max(3, toInt(q.cols, 30));
        let rows = toInt(q.rows, 16);
        let depth = toInt(q.depth, 1);
        let mpc = clamp(toInt(q.minespercell, 1), 1, 6);
        let mines = Math.max(1, toInt(q.mines, 99));
        let wmpc = clamp(getQueryDefault0(q.whiteminespercell), 0, 6);
        let wmines = Math.max(0, getQueryDefault0(q.whitemines));
        let logic = (q.logic !== null) ? clamp(toInt(q.logic, 0), 0, 2) : 0;
        // ë³´ì • 1: ê²€ì€ ì´ìˆ˜
        let caps = calcCaps(cols, rows, depth,mpc, mines, wmpc);
        if (mines > caps.capBlackTotal) mines = caps.capBlackTotal;

        // ë³´ì • 2: í° ì´ìˆ˜
        caps = calcCaps(cols, rows, depth,mpc, mines, wmpc);
        if (wmines > caps.capWhiteTotal) wmines = caps.capWhiteTotal;

        execute(cols, rows, mines, mpc, wmines, wmpc, logic, depth);

        // í¼ê³¼ max íŒíŠ¸ë„ ë™ê¸°í™”
        x.value = cols; y.value = rows; z.value = depth; m.value = mpc; t.value = mines;
        wm.value = wmpc; wt.value = wmines;
        t.max = String(caps.capBlackTotal);
        wt.max = String(caps.capWhiteTotal);
        const aiSel = document.getElementById('ai');
        if (aiSel) aiSel.value = String(logic);
        hideUserInputs();
      }
      else if (q.hide === '1') {
        // í•µì‹¬ íŒŒë¼ë¯¸í„°ê°€ ì—†ë”ë¼ë„, hide=1ì´ë©´ ì„¤ëª…/í¼ì„ ë¬´ì¡°ê±´ ìˆ¨ê¹€
        hideUserInputs();
      }
      else {
        // li class="menu1"ë¥¼ ëˆ„ë¥´ëŠ” ëª…ë ¹ì„ í•œë²ˆ ì¤€ë‹¤
        const menu1 = document.querySelector('li.menu1');
        if (menu1) menu1.click();
      }
    });
    /* ===== Console Mirror ===== */
    (function setupConsoleMirror() {
      const bodyEl = document.getElementById('console-body');
      const btnPlay = document.getElementById('console-play');
      const btnPause = document.getElementById('console-pause');
      const btnClear = document.getElementById('console-clear');
      const btnCopy = document.getElementById('console-copy');
      const cbAuto = document.getElementById('console-autoscroll');

      if (!bodyEl) return; // ì•ˆì „ê°€ë“œ

      let paused = false;
      function ts() {
        const d = new Date();
        const pad = (n) => String(n).padStart(2, '0');
        return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}.${String(d.getMilliseconds()).padStart(3, '0')}`;
      }
      function print(level, args) {
        if (paused) return;
        const line = document.createElement('div');
        line.className = `console-line console-lvl-${level}`;
        const t = document.createElement('span');
        t.className = 'console-time';
        t.textContent = `[${ts()}] `;
        line.appendChild(t);

        const content = Array.from(args).map(v => {
          try {
            if (typeof v === 'string') return v;
            return JSON.stringify(v);
          } catch (_) {
            return String(v);
          }
        }).join(' ');
        line.appendChild(document.createTextNode(content));
        bodyEl.appendChild(line);

        if (cbAuto && cbAuto.checked) {
          bodyEl.scrollTop = bodyEl.scrollHeight;
        }
      }

      // ì›ë³¸ ë³´ì¡´
      const orig = {
        log: console.log.bind(console),
        info: console.info?.bind(console) || function () { },
        warn: console.warn?.bind(console) || function () { },
        error: console.error?.bind(console) || function () { },
      };

      // í›„í‚¹
      console.log = function () { print('log', arguments); orig.log.apply(console, arguments); };
      console.info = function () { print('info', arguments); orig.info.apply(console, arguments); };
      console.warn = function () { print('warn', arguments); orig.warn.apply(console, arguments); };
      console.error = function () { print('error', arguments); orig.error.apply(console, arguments); };

      // ì»¨íŠ¸ë¡¤
      if (btnPause) {
        btnPause.addEventListener('click', function () {
          paused = !paused;
          btnPause.textContent = paused ? 'ì¬ê°œ' : 'ì¼ì‹œì •ì§€';
        });
      }
      if (btnClear) {
        btnClear.addEventListener('click', function () {
          bodyEl.textContent = '';
        });
      }
      if (btnCopy) {
        btnCopy.addEventListener('click', async function () {
          const text = Array.from(bodyEl.querySelectorAll('.console-line'))
            .map(el => el.textContent).join('\n');
          try { await navigator.clipboard.writeText(text); } catch (_) { }
        });
      }

      // ì‹œì‘ ë©”ì‹œì§€
      console.info('[Console mirror started]');
    })();
    


    

    // íƒ€ì´í‹€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    
    //pressreset í•¨ìˆ˜ëŠ” minefield.reset_board();ë¥¼ ì‹¤í–‰
    function pressreset() {
      if (window.minefield) {
        minefield.reset_board();
      }
    }

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì²˜ë¦¬ (F2 + ë©”ë‰´ ë‹¨ì¶•í‚¤)
    document.addEventListener('keydown', function (e) {
      const key = e.key.toUpperCase();
      if (e.key === 'F1') {
        e.preventDefault();
        openHelpContents();
        return;
      }
      // F2 í‚¤: í•­ìƒ ìƒˆ ê²Œì„
      if (e.key === 'F2') {
        e.preventDefault();
        pressreset();
        return;
      }
      if (e.key === 'F3') {
        e.preventDefault();
        document.getElementById('console-play')?.click();
        return;
      }
      if (e.key === 'F4') {
        e.preventDefault();
        document.getElementById('console-hint')?.click();
        return;
      }
      // ì„œë¸Œë©”ë‰´ê°€ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸
      const gameSubMenu = document.querySelector('.menu-bar > li:first-child > .menu');
      const helpSubMenu = document.querySelector('.menu-bar > li:nth-child(2) > .menu');

      const isGameMenuVisible = gameSubMenu && (
        gameSubMenu.style.display === 'block' ||
        window.getComputedStyle(gameSubMenu).display === 'block'
      );

      const isHelpMenuVisible = helpSubMenu && (
        helpSubMenu.style.display === 'block' ||
        window.getComputedStyle(helpSubMenu).display === 'block'
      );

      // ê²Œì„ ë©”ë‰´ê°€ ì—´ë ¤ìˆì„ ë•Œ
      if (isGameMenuVisible) {
        let handled = false;

        if (key === 'N') {
          e.preventDefault();
          pressreset();
          handled = true;
        } else if (key === 'B') {
          e.preventDefault();
          execute(9, 9, 10, 1, 0, 0, 2);
          setActiveDifficulty(1);
          handled = true;
        } else if (key === 'I') {
          e.preventDefault();
          execute(16, 16, 40, 1, 0, 0, 2);
          setActiveDifficulty(2);
          handled = true;
        } else if (key === 'E') {
          e.preventDefault();
          execute(30, 16, 99, 1, 0, 0, 2);
          setActiveDifficulty(3);
          handled = true;
        } else if (key === 'C') {
          e.preventDefault();
          openCustomDialog();
          setActiveDifficulty(23);
          handled = true;
        } else if (key === 'M') {
          e.preventDefault();
          toggleQuestionMarks();
          handled = true;
        } else if (key === 'L') {
          e.preventDefault();
          toggleColorMode();
          handled = true;
        } else if (key === 'S') {
          e.preventDefault();
          toggleSound();
          handled = true;
        } else if (key === 'T') {
          e.preventDefault();
          printBestTimes();
          handled = true;
        } else if (key === 'X') {
          e.preventDefault();
          $('.has-menu.mine-window.ui-resizable.ui-draggable').css('visibility', 'hidden');
          handled = true;
        }

        if (handled) {
          closeMenus();
        }
      }

      // Best Times ë‹¤ì´ì–¼ë¡œê·¸ê°€ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸
      const bestTimesDialog = document.getElementById('besttimes-win');
      const isBestTimesVisible = bestTimesDialog && (
        bestTimesDialog.style.display === 'block' ||
        (bestTimesDialog.style.display !== 'none' && window.getComputedStyle(bestTimesDialog).display === 'block')
      );

      // Best Times ë‹¤ì´ì–¼ë¡œê·¸ê°€ ì—´ë ¤ìˆì„ ë•Œ
      if (isBestTimesVisible) {
        if (key === 'R') {
          e.preventDefault();
          resetBestTimes();
          return;
        }
      }

      // ë„ì›€ë§ ë©”ë‰´ê°€ ì—´ë ¤ìˆì„ ë•Œ
      if (isHelpMenuVisible) {
        let handled = false;
        const alertMsg = isKorean() ? 'ë„ì›€ë§ì€ ì•„ë˜ì— ìˆìŠµë‹ˆë‹¤' : 'Help is below';

        if (key === 'C') {
          e.preventDefault();
          alert(alertMsg);
          handled = true;
        } else if (key === 'S') {
          e.preventDefault();
          alert(alertMsg);
          handled = true;
        } else if (key === 'H') {
          e.preventDefault();
          // ë„ì›€ë§ ì‚¬ìš© (ê¸°ëŠ¥ ì—†ìŒ)
          handled = true;
        } else if (key === 'A') {
          e.preventDefault();
          alert(window.__APPNAME_SING || 'Minesweeper');
          handled = true;
        }

        if (handled) {
          closeMenus();
        }
      }
    });

    /* ===== Runtime i18n: if not Korean, switch UI texts to English ===== */
    (function () {


      function setText(el, txt) { if (el) el.textContent = txt; }
      function setHTML(el, html) { if (el) el.innerHTML = html; }

     function localizeToEnglish() {
  document.documentElement.setAttribute("lang", "en");

  // ìƒë‹¨ ë©”ë‰´(ì´ê±´ <a class="menu151"> í˜•íƒœë¼ setMenuTextê°€ ì•„ë‹ˆë¼ textContent ê·¸ëŒ€ë¡œ OK)
  document.querySelector('.menu151') && (document.querySelector('.menu151').textContent = 'Game');
  document.querySelector('.menu152') && (document.querySelector('.menu152').textContent = 'Help');

  // ê²Œì„ ë©”ë‰´
  setMenuText('li.menu0',  'ã€€New', 'F2');
  setMenuText('li.menu1',  'ã€€Beginner', '');
  setMenuText('li.menu2',  'ã€€Intermediate', '');
  setMenuText('li.menu3',  'ã€€Expert', '');
  setMenuText('li.menu_4', 'ã€€Others...', '');
  setMenuText('li.menu4',  'ã€€Ultra', '');
  setMenuText('li.menu5',  'ã€€ğŸ˜±', '');
  setMenuText('li.menu6',  'ã€€ğŸ’€', '');
  setMenuText('li.menu7',  'ã€€â˜ ï¸', '');
  setMenuText('li.menu8',  'ã€€â˜ ï¸Ã—2', '');
  setMenuText('li.menu9',  'ã€€â˜ ï¸Ã—3', '');
  setMenuText('li.menu10', 'ã€€AntiMine', '');
  setMenuText('li.menu11', 'ã€€Anti Intermediate', '');
  setMenuText('li.menu12', 'ã€€Anti Expert', '');
  setMenuText('li.menu13', 'ã€€Large', '');
  setMenuText('li.menu14', 'ã€€XLarge', '');
  setMenuText('li.menu15', 'ã€€XXLarge', '');
  setMenuText('li.menu16', 'ã€€3D Mini', '');
  setMenuText('li.menu17', 'ã€€3D Medium', '');
  setMenuText('li.menu18', 'ã€€3D Large', '');
  setMenuText('li.menu19', 'ã€€3D Expert', '');
  setMenuText('li.menu20', 'ã€€3D SuperExpert', '');
  setMenuText('li.menu21', 'ã€€3D Neg', '');
  setMenuText('li.menu22', 'ã€€3D Neg Expert', '');
  setMenuText('li.menu23', 'ã€€Custom...', '');
  setMenuText('li.besttimes', 'ã€€Best Times...', '');
  setMenuText('li.menuclose', 'ã€€Exit', '');

  // ë„ì›€ë§ ë©”ë‰´
  setMenuText('li.menu102', 'ã€€Contents', 'F1');
  setMenuText('li.menu100', 'ã€€Search for Help on...', '');
  setMenuText('li.menu103', 'ã€€Using Help', '');
  setMenuText('li.menu101', 'ã€€About Minesweeper...', '');

  // ì¹˜íŠ¸ ë©”ë‰´
  setMenuText('li.menu_cheat', 'ã€€Cheat...', '');
  setMenuText('li.menu-autosolve', 'ã€€Solve Automatically', 'F3');
  setMenuText('li.menu-hint', 'ã€€Hint', 'F4');
setMenuText('li.menu_theme', 'ã€€Theme...', '');

  // ì˜µì…˜/í…Œë§ˆëŠ” ê¸°ì¡´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ê°€ setMenuTextë¥¼ ì“°ê²Œ ë°”ê¿¨ìœ¼ë‹ˆ ì´ê²ƒë§Œ í˜¸ì¶œ
  updateQuestionMenuVisual();
  updateColorMenuVisual();
  updateSoundMenuVisual();
  updateThemeMenuVisual();
updateWindowTitle();
  // íƒ€ì´í‹€
  //const titleEl = document.querySelector('.mine-window .title-bar .title');
  //if (titleEl) titleEl.textContent = 'Minesweeper';
  /* 2) Counter icon tooltips */

        const blackIcon = document.querySelector(".icon-flag-black");
        if (blackIcon) blackIcon.setAttribute("title", "Black mine");
        const whiteIcon = document.querySelector(".icon-flag-white");
        if (whiteIcon) whiteIcon.setAttribute("title", "Anti-mine");

        /* 3) Form labels / buttons */
        const form = document.querySelector("#userctrl form");
        if (form) {
          // ë¼ë²¨ì€ ì •ì ì¸ í•œêµ­ì–´ í…ìŠ¤íŠ¸ë¥¼ ì¹˜í™˜
          let html = form.innerHTML;
          html = html.replace("ì£¼ë¬¸ì œì‘:ê°€ë¡œ", "Custom: cols")
            .replace("ì„¸ë¡œ", "rows").replace("ë†’ì´", "depth")
            .replace("1ì¹¸ë‹¹ ìµœëŒ€ ì§€ë¢° ìˆ˜", "Max mines / cell")
            .replace("ì „ì²´ ì§€ë¢° ìˆ˜", "Total mines")
            .replace("1ì¹¸ë‹¹ ìµœëŒ€ ìŒìˆ˜ì§€ë¢° ìˆ˜", "Max anti-mines / cell")
            .replace("ì „ì²´ ìŒìˆ˜ì§€ë¢° ìˆ˜", "Total anti-mines")
            .replace("ì§€ëŠ¥í˜• ìƒì„±", "Generation mode")
            .replace("ìƒì„±", "Create")
            .replace("ë¬¸êµ¬ ìˆ¨ê¸°ê¸°", "Hide controls")

          form.innerHTML = html;

          // ì…€ë ‰íŠ¸ ì˜µì…˜ë„ ì˜ë¬¸í™”
          const aiSel = document.getElementById('ai');
          if (aiSel) {
            const opt = aiSel.options;
            if (opt[0]) opt[0].text = "0: allow guesses + minimal rescue";
            if (opt[1]) opt[1].text = "1: allow guesses + guaranteed first click opening +unlimited rescue";
            if (opt[2]) opt[2].text = "2: strict no-guess (slow)";
          }
        }

        /* 4) Heavy notice(ì œëª©/ë¬¸êµ¬ë§Œ ë¶€ë¶„ ì¹˜í™˜, DOMì€ ë³´ì¡´) */
        const notice = document.getElementById("heavy-notice");
        if (notice) {
          const h3 = notice.querySelector("h3");
          setText(h3, "Notice / Performance Tips");

          // í•œêµ­ì–´ ë¦¬ìŠ¤íŠ¸ í•­ëª©ì„ ì•ˆì „í•˜ê²Œ êµì²´ (ìˆëŠ” ê²½ìš°ì—ë§Œ)
          // ì²« ë²ˆì§¸ í° <ul> ì•ˆì˜ í•œêµ­ì–´ ë¬¸êµ¬ë“¤ì„ ì°¾ì•„ ì˜ì–´ë¡œ ë°”ê¿‰ë‹ˆë‹¤.
          // ì´ë¯¸ ì˜ì–´ë¼ë©´ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
          const list = notice.querySelector("ul");
          if (list) {
            let html = list.innerHTML;
            html = html
              .replace(/3Dì§€ë¢°ì°¾ê¸° ì¶œì‹œ:ê²Œì„-í…Œë§ˆì—ì„œ 3Dë¥¼ ì„ íƒí•˜ì„¸ìš”/, '3D Minesweeper was Launched: Choose 3D in the Game Themes')
              .replace(/ëª¨ë°”ì¼ì—ì„œ ì¡°ì‘:ì§§ê²Œ ëˆŒëŸ¬ ì¢Œí´ë¦­, ê¸¸ê²Œ ëˆŒëŸ¬ ìš°í´ë¦­, ì—´ë¦°ì¹¸ì„ ë”ë¸”í„°ì¹˜í•´ì„œ chording.<\/li>/, 'Controls on mobile: Short press to left-click, long press to right-click, double-tap an open space to chord.</li>')
              .replace(/ì²« í´ë¦­ ì§í›„ .*?ì¦ê°€\)<\/li>/, 'Right after the first click, <span class="warn">board generation</span> may take a while. (More mines & larger boards take longer.)</li>')
              .replace(/ì´ˆëŒ€í˜•ê³¼ íŠ¹ëŒ€í˜• íŒì€ ì´ˆê¸°í™”ì— ì•½ .*?<\/li>/, 'XLarge and XXLarge boards take about 5â€“10 seconds to initialize.</li>')
              .replace(/<li><strong>ì°ê¸° íŒ¨í„´ ë°œìƒ í—ˆìš©ì˜ êµ¬ì œ ê¸°ëŠ¥ ê´€ë ¨<\/strong>/, '<li><strong>About the rescue feature when guesses are allowed</strong>')
              .replace(/ë³µìˆ˜í•´ê°€ .*?ìˆ˜ì •í•©ë‹ˆë‹¤<\/li>/, 'If multiple solutions exist and a guess situation occurs, and you click a mine cell without contradicting revealed info, the board will be modified so that there is no mine in that cell.</li>')
              .replace(/í•˜ì§€ë§Œ ë¬´ì œí•œ êµ¬ì œëŠ” ë‚œì´ë„ë¥¼ ì‹¬ê°í•˜ê²Œ ë‚®ì¶¥ë‹ˆë‹¤<\/li>/, 'However, unlimited rescues significantly reduce the difficulty.</li>')
              .replace(/<li><strong>ì°ê¸° íŒ¨í„´ ë°œìƒ ì°¨ë‹¨<\/strong> ëª¨ë“œ ì„±ëŠ¥ ì£¼ì˜:/, '<li><strong>Strict no-guess</strong> mode performance caveats:')
              .replace(/ìŒìˆ˜ì§€ë¢°ê°€ ìˆìœ¼ë©´ ë§¤ìš° ëŠë¦½ë‹ˆë‹¤.*?<\/li>/, 'Very slow when anti-mines are used (not recommended for â‰¥ Intermediate).</li>')
              .replace(/1ì¹¸ë‹¹ ìµœëŒ€ ì§€ë¢° ìˆ˜ê°€ 4 ì´ìƒì´ë©´ ë§¤ìš° ëŠë¦½ë‹ˆë‹¤\.<\/li>/, 'Very slow if max mines per cell â‰¥ 4.</li>')
              .replace(/ëŒ€í˜• ì´ìƒì˜ í° íŒì—ì„œëŠ” ë§¤ìš° ëŠë¦½ë‹ˆë‹¤\.<\/li>/, 'Very slow on large boards (â‰¥ Large).</li>')
              .replace(/í•´ë‹¹ ëª¨ë“œëŠ” â€œì°ê¸° ì—†ëŠ” í’€ì´ ìˆœì„œâ€ë¥¼ í•­ìƒ ë³´ì¥í•©ë‹ˆë‹¤\.<\/li>/, 'This mode guarantees a guess-free solution order.</li>')
              .replace(/ë„ì›€ë§/, 'Help')
              .replace(/ë‚œì´ë„ëŠ” ê²Œì„ì—ì„œ ì„ íƒí•˜ì„¸ìš”.\\n?í‘œì‹œëŠ” ì˜µì…˜ì—ì„œ í† ê¸€í•©ë‹ˆë‹¤./, 'Select difficulty in-game.\\nToggle question marks in options.');
            setHTML(list, html);
          }

        }
        const form2 = document.querySelector("#customdial2");
        if (form2) {
          // ë¼ë²¨ì€ ì •ì ì¸ í•œêµ­ì–´ í…ìŠ¤íŠ¸ë¥¼ ì¹˜í™˜
          let html = form2.innerHTML;

          // â–¼ í•œâ€“ì˜ ì¹˜í™˜: #userctrl í¼ ì•ˆì—ì„œ ì“°ì´ëŠ” ëª¨ë“  í•œêµ­ì–´ ë¼ë²¨/ë²„íŠ¼ í…ìŠ¤íŠ¸ ì»¤ë²„
          html = html
            // "ì£¼ë¬¸ì œì‘:ê°€ë¡œ" ë° ê³µë°± ë³€í˜•
            // ê°€ë¡œ/ì„¸ë¡œ(í–‰) ë¼ë²¨(ê´„í˜¸ ìœ ë¬´ ëª¨ë‘)
            .replace(/ë„ˆë¹„\s*\(W\)*/g, "Width")
            .replace(/ë†’ì´\s*\(H\)*/g, "Height")
            .replace(/ê¹Šì´\s*\(D\)*/g, "Depth")
            // ì§€ë¢°/ìŒìˆ˜ì§€ë¢°(= anti-mine) í•­ëª©
            .replace(/ìµœëŒ€ì§€ë¢°\/1ì¹¸/g, "Max mines/cell")
            .replace(/ì§€ë¢°\s*ìˆ˜\s*\(M\)*/g, "Mines")
            .replace(/ìµœëŒ€ìŒìˆ˜ì§€ë¢°\/1ì¹¸/g, "Max antiMines/cell")
            .replace(/ìŒìˆ˜ì§€ë¢°\s*ìˆ˜/g, "antiMines")
            // ìƒì„± ëª¨ë“œ
            .replace(/ì§€ëŠ¥í˜•\s*ìƒì„±/g, "Generation mode")
            // ë²„íŠ¼ë“¤
            .replace(/í™•ì¸/g, "OK")
            .replace(/ì·¨ì†Œ/g, "Cancel");

          form2.innerHTML = html;

          // ì…€ë ‰íŠ¸ ì˜µì…˜(ì§€ëŠ¥í˜• ìƒì„±) ì˜ì–´í™”ëŠ” ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€
          const aiSel = document.getElementById('c-ai');
          if (aiSel) {
            const opt = aiSel.options;
            if (opt[0]) opt[0].text = "0: allow guesses + minimal rescue";
            if (opt[1]) opt[1].text = "1: allow guesses + guaranteed first click opening + unlimited rescue";
            if (opt[2]) opt[2].text = "2: strict no-guess + auto-solve (slow)";
          }
        }
        //custdialtitleì˜ í…ìŠ¤íŠ¸ë„ ì²˜ë¦¬
        const custdialtitle = document.querySelector('#custdialtitle');
        if (custdialtitle) {
          let html = custdialtitle.innerHTML;
          html = html.replace(/ì‚¬ìš©ì\s*ì§€ì •\s*ê²Œì„/g, 'Custom Field');
          custdialtitle.innerHTML = html;
        }

        /* 5) Console panel í—¤ë”/ë²„íŠ¼ */
        const cp = document.getElementById("console-panel");
        if (cp) {
          const titleEl = cp.querySelector('.console-head .title');
          const pauseEl = document.getElementById('console-pause');
          const playEl = document.getElementById('console-play');
          const hintEl = document.getElementById('console-hint');   // â† ëˆ„ë½ëë˜ ë¶€ë¶„ ì¶”ê°€
          const clearEl = document.getElementById('console-clear');
          const copyEl = document.getElementById('console-copy');
          const autoLbl = cp.querySelector('.console-head label');

          setText(titleEl, 'Live Log (Console mirror)');
          setText(playEl, 'Solve Automatically');
          setText(hintEl, 'Hint From Log');              // â† â€œíŒíŠ¸ ì œê³µâ€ ë²ˆì—­
          setText(pauseEl, 'Pause Console');
          setText(clearEl, 'Clear Console');
          setText(copyEl, 'Copy Console');
          if (autoLbl) setHTML(autoLbl, '<input type="checkbox" id="console-autoscroll" checked> Auto scroll');

          // ì¼ì‹œì •ì§€ ë²„íŠ¼ í† ê¸€ í…ìŠ¤íŠ¸ë„ ì˜ì–´ë¡œ
          pauseEl?.addEventListener('click', function () {
            const isResume = pauseEl.textContent.includes('Resume');
            pauseEl.textContent = isResume ? 'Pause' : 'Resume';
          });
        }
}

      if (!isKorean()) {
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", localizeToEnglish);
        } else {
          localizeToEnglish();
        }
      } else {
        // í•œêµ­ì–´ì¸ ê²½ìš°ì—ë„ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", updateWindowTitle);
        } else {
          updateWindowTitle();
        }
      }
    })();

const I18N_STRINGS = {
  'i18n-wrong-flag': 'ì˜ëª» ë§ˆí‚¹í•œ ì¹¸ì´ ìˆìŠµë‹ˆë‹¤: ({x}, {y}). ë¨¼ì € ì´ ì¹¸ì„ ìˆ˜ì •í•˜ì„¸ìš”.',
  'i18n-wrong-flag-en': 'You mis-flagged a cell: ({x}, {y}). Please fix this first.',

  'i18n-not-nopick': 'ì´ ê¸°ëŠ¥ì€ â€˜ì°ê¸° ì—†ìŒâ€™ ë³´ë“œì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. â€˜ì°ê¸° ì—†ìŒâ€™ ëª¨ë“œë¼ë©´, ì ì–´ë„ í•œ ì¹¸ì„ ì—¬ì„¸ìš”. ',
  'i18n-not-nopick-en': "Hints are available only on a â€œno-pickâ€ board. If itâ€™s already â€œno-pickâ€ mode, please open at least one cell. ",

  'i18n-no-next': 'ë” ì´ìƒ ì œê³µí•  íŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. í•œ ì¹¸ë„ ì—´ì§€ ì•Šì•˜ë‹¤ë©´ ì ì–´ë„ í•œ ì¹¸ì„ ì—¬ì„¸ìš”.',
  'i18n-no-next-en': "No further hints. If you haven't opened any cells yet, open at least one cell. ",

  'i18n-next-open': 'ë‹¤ìŒìœ¼ë¡œ ì—´ì–´ì•¼ í•˜ëŠ” ì•ˆì „í•œ ì¹¸: ({x}, {y}). ê·¼ê±°: {reason}',
  'i18n-next-open-en': 'Next safe cell to open: ({x}, {y}). Rationale: {reason}',

  'i18n-next-flag-black': 'ë‹¤ìŒ ìœ„ì¹˜ì— ì§€ë¢° ê¹ƒë°œ {n}ê°œ: ({x}, {y}). ê·¼ê±°: {reason}',
  'i18n-next-flag-black-en': 'Place {n} mine flag(s) at ({x}, {y}). Rationale: {reason}',

  'i18n-next-flag-white': 'ë‹¤ìŒ ìœ„ì¹˜ì— ìŒìˆ˜ ì§€ë¢° ê¹ƒë°œ {n}ê°œ: ({x}, {y}). ê·¼ê±°: {reason}',
  'i18n-next-flag-white-en': 'Place {n} anti-mine flag(s) at ({x}, {y}). Rationale: {reason}',

  'i18n-guess-needed': 'ì°ê¸° ë¶ˆê°€í”¼-í•œ ì¹¸ì˜ ì •ë‹µì„ ì œê³µ',
  'i18n-guess-needed-en': 'Guess unavoidable â€” revealing the truth for one cell.',

  'i18n-dead': 'ì´ë¯¸ ì£½ì—ˆìŠµë‹ˆë‹¤',
  'i18n-dead-en': 'Already dead',

  'i18n-last-cell': 'ë§ˆì§€ë§‰ ë‚¨ì€ ì¹¸(ì°ê¸° ì•„ë‹˜)',
  'i18n-last-cell-en': 'Last remaining cell (not a guess)',
};
function _findWrongFlag(mf){
  if (!mf || !mf.flags || !mf.mines) return null;
  const W = mf.columns|0, H = mf.rows|0;

  for (let y = 0; y < H; y++) for (let x = 0; x < W; x++){
    const f = (mf.flags[x]?.[y] || 0) | 0;
    if (f === 0) continue;
    const ans = (mf.mines[x]?.[y] || 0) | 0;
    if (f !== ans) return { x, y, ans };
  }
  return null;
}
  /* ===== (ì¶”ê°€) trace ê°€ëŠ¥ ì—¬ë¶€ ===== */
  function _hasTracePlayable(mf) {
    return !!(mf && mf.use_nopick && Array.isArray(mf._nopick_trace) && mf._nopick_trace.length);
  }

  /* ===== (ì¶”ê°€) flagsë¥¼ ì •í™•íˆ targetìœ¼ë¡œ ë§ì¶”ê¸°(0 í¬í•¨) ===== */
  function _setFlagExactUI(mf, x, y, target) {
    target = (target | 0);
    let g = 32;
  if (target === 0) {
    while (_isFlagUI(mf, x, y) && g--) mf.on_rclick(x, y);
    return !_isFlagUI(mf, x, y);
  }
    while (((mf.flags[x][y] || 0) | 0) !== target && g--) mf.on_rclick(x, y);
    return (((mf.flags[x][y] || 0) | 0) === target);
  }

  /* ===== (ì¶”ê°€) ì„ì˜ í•œ ì¹¸ ì •ë‹µ ì œê³µ(ì°ê¸° ë¶ˆê°€í”¼) ===== */
  function _pickOneTruthCell(mf) {
    const cand = _frontierClosedCells(mf); // â˜… ì¸ì ‘ í”„ë¡ í‹°ì–´ë§Œ í—ˆìš©
  if (!cand || !cand.length) return null;

  // ê¸°ì¡´ì²˜ëŸ¼ "ì²« ë²ˆì§¸"ë¥¼ ê³ ë¥´ê³  ì‹¶ìœ¼ë©´ ê·¸ëŒ€ë¡œ [0],
  // ì„ì˜ë¡œ ê³ ë¥´ê³  ì‹¶ìœ¼ë©´ ëœë¤ ì„ íƒ
  const [x, y] = cand[(Math.random() * cand.length) | 0];

  const ans = (mf.mines[x][y] | 0);
  if (ans === 0) return { kind: "open", x, y, reason: "ì°ê¸° ë¶ˆê°€í”¼-í•œ ì¹¸ì˜ ì •ë‹µì„ ì œê³µ" };
  return { kind: "markMine", x, y, val: ans, reason: "ì°ê¸° ë¶ˆê°€í”¼-í•œ ì¹¸ì˜ ì •ë‹µì„ ì œê³µ" };
}
/* ===== (ì¶”ê°€) ë¯¸ì˜¤í”ˆ ì¹¸ì´ ìœ ì¼í•˜ë©´ ê·¸ ì¢Œí‘œ ë°˜í™˜, ì•„ë‹ˆë©´ null ===== */
function _onlyOneUnopenedCell(mf) {
  const W = mf.columns | 0, H = mf.rows | 0;
  let foundX = -1, foundY = -1, cnt = 0;

  for (let y = 0; y < H; y++) for (let x = 0; x < W; x++) {
    if (!mf.is_opened(x, y)) {
      cnt++;
      if (cnt > 1) return null;
      foundX = x; foundY = y;
    }
  }
  return (cnt === 1) ? { x: foundX, y: foundY } : null;
}

  /* ===== (ì¶”ê°€) ìš”êµ¬ì‚¬í•­ ì„œë¸Œë£¨í‹´ =====
     mode:
       { cause: "hint"|"auto", isFirstAuto: boolean }
  */
  function assistSubroutine(mf, mode) {
    mode = mode || { cause: "hint", isFirstAuto: true };
    if (!mf || mf.game_status < 0) return null;

    // 1) ì˜ëª» ë§ˆí‚¹ëœ ê¹ƒë°œì´ ìˆìœ¼ë©´ ê·¸ ì¤‘ í•˜ë‚˜ ìˆ˜ì •
    const W = mf.columns | 0, H = mf.rows | 0;
    for (let y = 0; y < H; y++) for (let x = 0; x < W; x++) {
      const f = (mf.flags[x][y] || 0) | 0;
      if (f === 0) continue;
      const ans = (mf.mines[x][y] | 0);
      if (f !== ans) {
        return {
          kind: "fixFlag",
          x, y,
          val: ans,
          reason: "ì˜ëª» ë§ˆí‚¹í•œ ì¹¸ì´ ìˆìŠµë‹ˆë‹¤"
        };
      }
    }

    // 2) ì˜ëª» ë§ˆí‚¹ì´ ì—†ìœ¼ë©´ solveonestep 1ìŠ¤í…
    if (typeof mf.solveonestep === "function") {
      const step = mf.solveonestep();
      if (step) return step; // solveonestep ê²°ê³¼(íƒ€ì…)ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    }
// 2.5) â˜… ì¶”ê°€: ë¯¸ì˜¤í”ˆ ì¹¸ì´ ìœ ì¼(1ê°œ)í•˜ë©´ 'ì°ê¸°'ë¡œ ì·¨ê¸‰í•˜ì§€ ì•Šê³  í™•ì • ì²˜ë¦¬
{
  const last = _onlyOneUnopenedCell(mf);
  if (last) {
    const x = last.x | 0, y = last.y | 0;

    const capB = Math.max(1, (mf.max_mines | 0));
    const capW = Math.max(0, (mf.max_mines_white | 0));

    const bRemain = ((mf.num_mines | 0) - (mf.num_flags | 0)) | 0;
    const wTotal  = ((mf.white_total != null ? mf.white_total : mf.num_mines_white) | 0);
    const wRemain = (wTotal - (mf.num_flags_white | 0)) | 0;
const lastReason = _msg('i18n-last-cell', 'i18n-last-cell-en');
    // ë‚¨ì€ ì§€ë¢°ê°€ ìˆìœ¼ë©´ -> ê·¸ 1ì¹¸ì´ ì§€ë¢°, ì—†ìœ¼ë©´ -> ì•ˆì „ì¹¸ ì˜¤í”ˆ
    if (bRemain > 0) {
      const v = Math.min(capB, bRemain | 0); // ì•ˆì „ì¥ì¹˜(ìº¡ ì´ˆê³¼ ë°©ì§€)
      return { kind: "markMine", x, y, val: v, reason: lastReason };
    }
    if (wRemain > 0) {
      const v = -Math.min(capW, wRemain | 0); // ìŒìˆ˜ì§€ë¢°ëŠ” ìŒìˆ˜ val
      return { kind: "markMine", x, y, val: v, reason: lastReason };
    }
    return { kind: "open", x, y, reason: lastReason };
  }
}

    // 3) solveonestepì´ nullì´ê³ , íŒíŠ¸ì´ê±°ë‚˜ ìë™ ì²« ì‹¤í–‰ì´ë©´ â€œì •ë‹µ 1ì¹¸ ì œê³µâ€
    if (mode.cause === "hint" || (mode.cause === "auto" && mode.isFirstAuto)) {
      const step = _pickOneTruthCell(mf);
      // â˜… (ì¶”ê°€) ìë™ ì²« ì‹¤í–‰ì—ì„œ 'ì •ë‹µ 1ì¹¸ ì œê³µ'ì´ ì‹¤ì œë¡œ ë°œìƒí•˜ë©´ ê²½ê³ ì°½
      if (step && mode.cause === "auto" && mode.isFirstAuto) {
        alert(_msg('i18n-guess-needed', 'i18n-guess-needed-en'));

      }
      return step;
    }

    // 4) ìë™ 2ë²ˆì§¸ ì´í›„ nullì´ë©´ null
    return null;
  }

  /* ===== (ì¶”ê°€) step ì ìš©ê¸° ===== */
  function applyAssistStep(mf, step) {
    if (!step) return false;
    const x = step.x | 0, y = step.y | 0;

    if (step.kind === "open") {
      const ok = _openWithUnflag(mf, x, y);
      if (typeof update_all_mine_counters === "function") update_all_mine_counters();
      return ok;
    }

    if (step.kind === "fixFlag" || step.kind === "markMine") {
      // solveonestepì´ valì„ ì£¼ë©´ ê·¸ê±¸, ì•„ë‹ˆë©´ ì‹¤ì œ ì •ë‹µ(mf.mines)ìœ¼ë¡œ ë§ì¶¤
      const target = ("val" in step) ? (step.val | 0) : (mf.mines[x][y] | 0);
      const ok = _setFlagExactUI(mf, x, y, target);
      if (typeof update_all_mine_counters === "function") update_all_mine_counters();
      return ok;
    }

    return false;
  }
    /* ===== ì‘ì€ i18n í—¬í¼ ===== */
    const _isKO = () => (navigator.language || '').toLowerCase().startsWith('ko');
    function _msg(idKo, idEn, map = {}) {
      const key = _isKO() ? idKo : idEn;
      let s = I18N_STRINGS[key] || '';
      return s.replace(/\{(\w+)\}/g, (_, k) => (map[k] ?? ''));
    }

    const _deadMsg = () => _msg('i18n-dead', 'i18n-dead-en') || 'you already dead';

    /* ===== ê³µí†µ ìœ í‹¸(ê¹ƒë°œ/ì—´ê¸°) ===== */
    function _isFlagUI(mf, x, y) { const c = mf.get_class(x, y); return !!(c && /^flag-/.test(c)); }
    function _removeFlagFully(mf, x, y) { let g = 24; while (_isFlagUI(mf, x, y) && g--) mf.on_rclick(x, y); }
    function _ensureFlagExactly(mf, x, y, target) { if ((mf.flags[x][y] || 0) === target) return false; let g = 24; while ((mf.flags[x][y] || 0) !== target && g--) mf.on_rclick(x, y); return true; }
    function _openWithUnflag(mf, x, y) { if (_isFlagUI(mf, x, y)) _removeFlagFully(mf, x, y); if (mf.is_opened(x, y)) return false; mf.on_click(x, y); return true; }
// ì—´ë¦°ì¹¸/ê¹ƒë°œì¹¸ì— ì¸ì ‘í•œ(8ë°©í–¥) "ë‹«íŒ & ë¹„ê¹ƒë°œ" ì¹¸ ëª©ë¡
function _frontierClosedCells(mf) {
  const W = mf.columns | 0, H = mf.rows | 0;
  const set = new Set();
  const out = [];

  const inb = (x,y)=> (x>=0 && y>=0 && x<W && y<H);

  for (let y = 0; y < H; y++) for (let x = 0; x < W; x++) {
    const opened = mf.is_opened(x, y);
    const flagged = _isFlagUI(mf, x, y); // flag-*ë§Œ â€œê¹ƒë°œâ€ë¡œ ë³¸ë‹¤(ìš”êµ¬ì‚¬í•­ ë¬¸êµ¬ì™€ ì¼ì¹˜)

    if (!opened && !flagged) continue; // anchor(ì—´ë¦¼/ê¹ƒë°œ)ë§Œ ê¸°ì¤€ì 

    for (let dy = -1; dy <= 1; dy++) for (let dx = -1; dx <= 1; dx++) {
      if (!dx && !dy) continue;
      const nx = x + dx, ny = y + dy;
      if (!inb(nx, ny)) continue;

      // í›„ë³´: ë‹«í˜”ê³ (flag í¬í•¨í•´) ì•„ì§ í‘œì‹œ ì•ˆ ëœ ì¹¸
      if (mf.is_opened(nx, ny)) continue;
      if (_isFlagUI(mf, nx, ny)) continue;

      const key = nx + "," + ny;
      if (!set.has(key)) { set.add(key); out.push([nx, ny]); }
    }
  }
  return out;
}

    /* ===== trace ì§„í–‰ìƒíƒœ ìœ í‹¸ ===== */
    function _done(mf, t) {
      if (!t) return true;
      if (t.kind === 'open')
        return mf.is_opened(t.x, t.y);
      if (t.kind === 'markMine')
        return ((mf.flags[t.x][t.y] || 0) === (mf.mines[t.x][t.y] | 0));
      return true; // rule/subset/flood ë“±ì€ íŒíŠ¸/ë§¤í¬ë¡œ ê´€ì ì—ì„œ ì†Œë¹„ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
    }
    function _nextVisible(mf) {
      const tr = mf._nopick_trace || []; let i = 0;
      while (i < tr.length &&
        _done(mf, tr[i]))
        i++;
      for (; i < tr.length; i++) {
        const t = tr[i]; if (t.kind === 'open' || t.kind === 'markMine')
          return t;
      }
      return null;
    }
    function humanizeReason(raw) {
      if (!raw) return "";
      const KO = (navigator.language || "").toLowerCase().startsWith("ko");

      // ê·œì¹™ë³„ ì •ê·œì‹ ë§¤í•‘ (ìœ„ì—ì„œë¶€í„° ìš°ì„ ì ìš©)
      const table = [
        // Rule A
        [/^RuleA N==0\b/i, () => KO
          ? "ìˆ«ìì¹¸ì˜ ë‚¨ì€ ì§€ë¢° ìˆ˜ Nì´ 0 â†’ ì£¼ë³€ ë‹«íŒ ì¹¸ì€ ëª¨ë‘ ì•ˆì „"
          : "Remaining mines N is 0 â†’ all adjacent closed cells are safe"],
        [/^RuleA N==F\b/i, () => KO
          ? "ì¸ì ‘ ê¹ƒë°œ ìˆ˜ Fê°€ ìš”êµ¬ ì§€ë¢° ìˆ˜ Nê³¼ ê°™ìŒ â†’ ë‚˜ë¨¸ì§€ ì¸ì ‘ ì¹¸ì€ ëª¨ë‘ ì•ˆì „"
          : "Flags F equals required mines N â†’ all other adjacent cells are safe"],

        // Rule B
        [/^RuleB U==1 exact count=(\d+)/i, (m) => KO
          ? `ì£¼ë³€ ë‹«íŒ ì¹¸ Uê°€ 1ê°œì´ê³  ë‚¨ì€ ì§€ë¢°ê°€ ${m[1]}ê°œ â†’ ê·¸ 1ì¹¸ì´ ì „ë¶€ ì§€ë¢°`
          : `Only 1 closed neighbor (U=1) and ${m[1]} mine(s) remaining â†’ that cell must be a mine`],
        [/^RuleB cap count=(\d+)/i, (m) => KO
          ? `ì¸ì ‘ ì œì•½(ìµœëŒ€ ìˆ˜ìš©)ìœ¼ë¡œ ì§€ë¢° ${m[1]}ê°œê°€ ê°•ì œ`
          : `Capacity bounds force ${m[1]} mine(s)`],

        // SUBSET
        [/^subset single exact count=(\d+)/i, (m) => KO
          ? `ë¶€ë¶„ì§‘í•© ì¶”ë¡ ìœ¼ë¡œ í•´ë‹¹ ì¹¸(ë¬¶ìŒ)ì— ì§€ë¢° ${m[1]}ê°œê°€ ì •í™•íˆ í•„ìš”`
          : `Subset logic forces exactly ${m[1]} mine(s) in the cell set`],
        [/^subset Î”=0\b/i, () => KO
          ? "ë¶€ë¶„ì§‘í•© ì¶”ë¡  ê²°ê³¼ Î”=0 â†’ ë¹„êµëœ ë‚˜ë¨¸ì§€ ì¹¸ì€ ëª¨ë‘ ì•ˆì „"
          : "Subset logic Î”=0 â†’ remaining compared cells are all safe"],
        [/^subset Î”=\|S\|\*cap\b/i, () => KO
          ? "ë¶€ë¶„ì§‘í•© Sì˜ í¬ê¸°Ã—ì¹¸ë‹¹ ìµœëŒ€ì§€ë¢°(cap)ë§Œí¼ ì±„ì›Œì•¼ í•¨ â†’ Sê°€ ëª¨ë‘ ì§€ë¢°"
          : "Subset size Ã— per-cell cap must be filled â†’ S is all mines"],

        // EXISTENCE
        [/^exist\(range==\{0\}\)/i, () => KO
          ? "ëª¨ë“  ê°€ëŠ¥í•œ ë°°ì¹˜ì—ì„œ ì£¼ë³€ ì§€ë¢° ìˆ˜ê°€ 0 â†’ í•­ìƒ ì•ˆì „"
          : "In all placements neighbors count is 0 â†’ always safe"],
        [/^exist\(range==\{(\d+)\}\)/i, (m) => KO
          ? `ê°€ëŠ¥í•œ ë°°ì¹˜ì—ì„œ ì£¼ë³€ ì§€ë¢° ìˆ˜ê°€ ${m[1]}ìœ¼ë¡œë§Œ ì¼ì¹˜`
          : `Across all placements the neighbor count is always ${m[1]}`],

        // BOUNDS
        [/^bounds exact count=(\d+)/i, (m) => KO
          ? `ìƒÂ·í•˜í•œ ê²½ê³„ ê³„ì‚°ìœ¼ë¡œ ì •í™•íˆ ì§€ë¢° ${m[1]}ê°œ í•„ìš”`
          : `Lower/upper bounds force exactly ${m[1]} mine(s)`],
        [/^bounds chord N==minSum\b/i, () => KO
          ? "ìµœì†Œ í•©ì´ ì´ë¯¸ ì±„ì›Œì ¸ ë” ì´ìƒ ì§€ë¢° ë¶ˆê°€ â†’ ë‚˜ë¨¸ì§€ëŠ” ì•ˆì „"
          : "Minimum sum already satisfied â†’ remaining cells are safe"],

        // ê¸°íƒ€ ìì£¼ ë³´ì´ëŠ” ë¡œê·¸ ê¼¬ë¦¬í‘œ
        [/^flood-neighbor\b/i, () => KO
          ? "0ì¹¸ ì—°ì‡„ ê³µê°œë¡œ ì¸ì ‘ ì•ˆì „ì¹¸ ìë™ ê³µê°œ"
          : "Auto-reveal from zero-cell flood"],
        [/^seed\b/i, () => KO
          ? "ì²« í´ë¦­ìœ¼ë¡œ ì‹œì‘í•œ ì•ˆì „ ì˜¤í”ˆ"
          : "Safe open triggered by the first click"],

        [/^RuleB\s+N==U\s+count=(\d+)/i, (m) => KO
          ? `ìˆ«ìì¹¸ì—ì„œ ë‚¨ì€ ì§€ë¢° ìˆ˜ Nì´ ë¯¸ì • ì¹¸ ìˆ˜ Uì™€ ê°™ìŒ â†’ ê·¸ Uì¹¸ì´ ëª¨ë‘ ì§€ë¢° (ì´ ${m[1]}ê°œ)`
          : `Remaining mines N equals number of unknown cells U â†’ all U cells are mines (total ${m[1]})`],

      ];

      for (const [re, make] of table) {
        const m = re.exec(raw);
        if (m) {
          const explain = make(m);
          // ì›ë¬¸ë„ í•¨ê»˜ ë³´ì—¬ ì£¼ë˜, ì‚¬ëŒì´ ì½ëŠ” ì„¤ëª…ì„ ë’¤ì— ë§ë¶™ì„
          return `${raw} â€” ${explain}`;
        }
      }
      // ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ì›ë¬¸ ê·¸ëŒ€ë¡œ
      return raw;
    }
    /* ===== íŒíŠ¸: wrong-flag ìš°ì„  ì•Œë¦¼+ì¦‰ì‹œìˆ˜ì • â†’ ë‹¤ìŒ ìŠ¤í… 1íšŒ ì‹¤í–‰+ê·¼ê±° alert ===== */
      window.provide_nopick_hint = function () {
    const mf = window.minefield;
    if (!mf) return;

    if (mf.game_status === -1) { alert(_deadMsg()); console.warn('you already dead'); return; }

    // A) trace ì¬ìƒ ê°€ëŠ¥í•˜ë©´: ê¸°ì¡´ trace ê¸°ë°˜ íŒíŠ¸(í˜„ì¬ ë¡œì§ ìœ ì§€)
    if (_hasTracePlayable(mf)) {
      // âœ… (ì¶”ê°€) nopick(trace) ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ "ì˜ëª» ë§ˆí‚¹" ìš°ì„  ì²˜ë¦¬
      const wrong = _findWrongFlag(mf);
      if (wrong){
        // ê¸°ì¡´ â€œì°ê¸°ìˆìŒâ€ìª½ ë™ì‘ê³¼ ë§ì¶”ë ¤ë©´ ì—¬ê¸°ì„œ ìë™ ìˆ˜ì •ê¹Œì§€ í•´ë„ ë¨
        _setFlagExactUI(mf, wrong.x, wrong.y, wrong.ans);
        if (typeof update_all_mine_counters === 'function') update_all_mine_counters();

        alert(_msg('i18n-wrong-flag', 'i18n-wrong-flag-en', { x: wrong.x, y: wrong.y }));
        return;
      }
      // ---- (ê¸°ì¡´ íŒíŠ¸ ë¡œì§ ê·¸ëŒ€ë¡œ) ----
      const t = _nextVisible(mf);
      if (!t) { alert(_msg('i18n-no-next', 'i18n-no-next-en')); return; }

      const reason = (t.reason ?? (t.kind === 'flood' ? 'ì¸ì ‘ ì¹¸ ìë™ ê³µê°œ' : 'auto'));
      const nice = humanizeReason(reason);

      if (t.kind === 'open') {
        if (_openWithUnflag(mf, t.x, t.y)) {
          alert(_msg('i18n-next-open', 'i18n-next-open-en', { x: t.x, y: t.y, reason: nice }));
        } else {
          alert(_msg('i18n-no-next', 'i18n-no-next-en'));
        }
      } else { // markMine
        const want = mf.mines[t.x][t.y] | 0;
        if (!want) { alert(_msg('i18n-no-next', 'i18n-no-next-en')); return; }

        if (_setFlagExactUI(mf, t.x, t.y, want)) {
          alert(_msg(want < 0 ? 'i18n-next-flag-white' : 'i18n-next-flag-black',
            want < 0 ? 'i18n-next-flag-white-en' : 'i18n-next-flag-black-en',
            { x: t.x, y: t.y, n: Math.abs(want), reason: nice }));
        } else {
          alert(_msg('i18n-no-next', 'i18n-no-next-en'));
        }
      }
      return;
    }

    // B) trace ì¬ìƒí•  ê²Œ ì—†ìœ¼ë©´: ìš”êµ¬ì‚¬í•­ ì„œë¸Œë£¨í‹´ 1íšŒ
    const step = assistSubroutine(mf, { cause: "hint", isFirstAuto: true });
    if (!step) { alert(_msg('i18n-no-next', 'i18n-no-next-en')); return; }

    // step ì ìš©
    applyAssistStep(mf, step);
__pushSolveLog(mf, step, true); // â˜… íŒíŠ¸ëŠ” 1ìŠ¤í…ì´ë¯€ë¡œ ì¦‰ì‹œ 1ì¤„ ì¶œë ¥

    // ì•ˆë‚´ ë¬¸êµ¬(ì¢Œí‘œ+ê·¼ê±°)
    const reason =
      (step.reason === "ì°ê¸° ë¶ˆê°€í”¼-í•œ ì¹¸ì˜ ì •ë‹µì„ ì œê³µ")
        ? _msg('i18n-guess-needed', 'i18n-guess-needed-en')
        : humanizeReason(step.reason || "");
    if (step.kind === "open") {
      alert(_msg('i18n-next-open', 'i18n-next-open-en', { x: step.x, y: step.y, reason }));
    } else if (step.kind === "fixFlag") {
      // fixFlagëŠ” ìš”êµ¬ì‚¬í•­ reason ê³ ì •
      alert(_msg('i18n-wrong-flag', 'i18n-wrong-flag-en', { x: step.x, y: step.y }) );
    } else { // markMine
      const v = ("val" in step) ? (step.val | 0) : (mf.mines[step.x][step.y] | 0);
      alert(_msg(v < 0 ? 'i18n-next-flag-white' : 'i18n-next-flag-black',
        v < 0 ? 'i18n-next-flag-white-en' : 'i18n-next-flag-black-en',
        { x: step.x, y: step.y, n: Math.abs(v), reason }));
    }
  };

    /* ===== ë³´ë“œ UID: init_mines_nopick ì„±ê³µì‹œ ì¦ê°€ ===== */
    (function () {
      const orig = window.Minefield?.prototype?.init_mines_nopick;
      if (orig && !window.Minefield.prototype.__uidWrapped) {
        window.Minefield.prototype.__uidWrapped = true;
        window.Minefield.prototype.init_mines_nopick = function (fx, fy) {
          const r = orig.call(this, fx, fy); if (r === 1) this._nopick_board_uid = (this._nopick_board_uid || 0) + 1; return r;
        };
      }
    })();

    /* ===== ìë™ì¬ìƒ: 0.3s, ë³´ë“œêµì²´/ì‚¬ë§ ì •ì§€, ë²„íŠ¼ í† ê¸€(ì¼ì‹œì •ì§€/ì¬ê°œ) ===== */
    /* ===== ìë™ì¬ìƒ: 0.3s, ë³´ë“œêµì²´/ì‚¬ë§ ì •ì§€, ë²„íŠ¼ í† ê¸€(ì¼ì‹œì •ì§€/ì¬ê°œ) ===== */
(function () {
  const labelPlay = () => _isKO() ? 'ìë™ìœ¼ë¡œ í’€ê¸°' : 'Solve Automatically';
  const labelPause = () => _isKO() ? 'ìë™ í’€ê¸° ì¼ì‹œ ì¤‘ì§€' : 'Pause Auto-solve';
 function bindConsoleButtons() {
    const btn = document.getElementById('console-play');
    const hintBtn = document.getElementById('console-hint');

    if (!btn) return;

    // ë²„íŠ¼ ë¼ë²¨ ì´ˆê¸°í™”(3D ìƒíƒœ ë°˜ì˜í•˜ë ¤ë©´ _syncSolveBtnText3D() í˜¸ì¶œí•´ë„ OK)
    btn.textContent = labelPlay();

    btn.addEventListener('click', () => {
      if (typeof is3DTheme === 'function' && is3DTheme()) {
        toggle3DAutoSolve();
        return;
      }
      const mf = window.minefield;
      if (mf && typeof startOrResume === 'function') startOrResume(mf);
    });

    if (hintBtn) {
      hintBtn.addEventListener('click', () => {
        if (typeof is3DTheme === 'function' && is3DTheme()) {
          request3DHint();
          return;
        }
        try { window.provide_nopick_hint(); } catch (e) { console.error(e); }
      });
    }
  }
  function startOrResume(mf) {

    // â˜… (ë³€ê²½) trace ê°•ì œ ì²´í¬ ì œê±°: traceê°€ ì—†ìœ¼ë©´ assist ëª¨ë“œë¡œ ë™ì‘
    if (mf.game_status === -1) { alert(_deadMsg()); console.warn('you already dead'); return; }

    // í† ê¸€(ì¼ì‹œì •ì§€/ì¬ê°œ) êµ¬ì¡°ëŠ” ê·¸ëŒ€ë¡œ
    if (mf._macro_timer && mf._macro_running && mf._macro_paused) { mf._macro_paused = false; btn && (btn.textContent = labelPause()); return; }
    if (mf._macro_timer && mf._macro_running && !mf._macro_paused) { mf._macro_paused = true; btn && (btn.textContent = labelPlay()); return; }

    if (mf._macro_timer) clearInterval(mf._macro_timer);
    mf._macro_running = true; mf._macro_paused = false;

    // â˜… (ì¶”ê°€) ì´ë²ˆ ìë™í’€ê¸°ì—ì„œ traceë¥¼ ì“¸ì§€/assistë¥¼ ì“¸ì§€ ê²°ì •
    const hasTrace = !!(mf.use_nopick && Array.isArray(mf._nopick_trace) && mf._nopick_trace.length);
    const startUID = mf._nopick_board_uid || 0;       // ê¸°ì¡´ ìœ ì§€
    let firstAssist = true;                           // â˜… assist ëª¨ë“œì—ì„œ â€œì²« ì„œë¸Œë£¨í‹´ë§Œ ì°ê¸° ë¶ˆê°€í”¼ í—ˆìš©â€ êµ¬í˜„ìš©

    mf._macro_timer = setInterval(function () {
      if (!mf._macro_running) { stop('manual'); return; }
      if (mf._macro_paused) return;

      // â˜… (ë³€ê²½) ë³´ë“œ êµì²´ ì²´í¬ëŠ” trace ëª¨ë“œì—ì„œë§Œ ì˜ë¯¸ ìˆìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ ë‘ë˜ ì¡°ê±´ë¶€
      if (hasTrace && (mf._nopick_board_uid || 0) !== startUID) { stop('board changed'); return; }

      if (mf.game_status === -1) { stop('dead'); console.warn('you already dead'); alert(_deadMsg()); return; }

      if (hasTrace) {
        // ===== (ê¸°ì¡´) trace ê¸°ë°˜ 1í‹± 1ê°œ =====
        const step = _nextVisible(mf); if (!step) { stop('done'); return; }
        if (step.kind === 'open') _openWithUnflag(mf, step.x, step.y);
        else _ensureFlagExactly(mf, step.x, step.y, (mf.mines[step.x][step.y] | 0));
        return;
      }

      // ===== â˜… (ì¶”ê°€) traceê°€ ì—†ìœ¼ë©´ assist ì„œë¸Œë£¨í‹´ ë°˜ë³µ =====
      const step = assistSubroutine(mf, { cause: "auto", isFirstAuto: firstAssist });
      firstAssist = false;

      if (!step) { stop('done'); return; } // ìë™í’€ê¸°: 2ë²ˆì§¸ ì´í›„ nullì´ë©´ ì¢…ë£Œ(ìš”êµ¬ì‚¬í•­ 4)

      applyAssistStep(mf, step);
      __pushSolveLog(mf, step, false); // â˜… 20ê°œì”© ë¬¶ì–´ì„œ ì¶œë ¥

      // 1í‹±ë‹¹ 1ê°œë§Œ ìˆ˜í–‰ (ê¸°ì¡´ ì •ì±… ìœ ì§€)
    }, 40);

    function stop(reason) {
      clearInterval(mf._macro_timer); mf._macro_timer = null;
      mf._macro_running = false; mf._macro_paused = false;
      __flushSolveLog();
      btn && (btn.textContent = labelPlay());
      if (reason) console.info('[macro] stopped:', reason);
    }
    btn && (btn.textContent = labelPause());
  }
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindConsoleButtons);
  } else {
    bindConsoleButtons();
  }
  // Minefield ë©”ì„œë“œë¡œë„ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ (ê¸°ì¡´ ìœ ì§€)
  if (window.Minefield && !window.Minefield.prototype.nopick_debug_macro)
    window.Minefield.prototype.nopick_debug_macro = function () { startOrResume(this); };

  

})();

  </script>
  <script>
    function closeMenus() {
      const mb = $('.menu-bar');
      // 1) ìœ„ì ¯ APIë¡œ ì „ì²´ ì ‘ê¸° (ê°€ëŠ¥í•˜ë©´ ì´ê²Œ ê°€ì¥ ê¹”ë”)
      try { mb.menubar('collapseAll'); } catch (e) { }

      // 2) ìƒíƒœ í´ë˜ìŠ¤/ARIA ì •ë¦¬ + ì‹¤ì œ ìˆ¨ê¹€ (í´ë°±)
      mb.find('.ui-state-open').removeClass('ui-state-open');
      mb.find('> li').removeClass('ui-state-active ui-state-hover ui-state-focus');
      mb.find('.ui-state-active').removeClass('ui-state-active');
      mb.find('.menu')
        .hide()
        .attr({ 'aria-hidden': 'true', 'aria-expanded': 'false' });

      // 3) í¬ì»¤ìŠ¤ë„ ì‚´ì§ ë¹¼ì£¼ë©´ blur ì˜ì¡´ UIì—ì„œë„ ì•ˆì „
      mb.trigger('blur');
    }
  </script>
  <script>
    // ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°: í˜„ì¬ ê°’ ë°˜ì˜ + í™”ë©´ ì¤‘ì•™ì— ë³´ì—¬ì£¼ê¸°
    function openCustomDialog() {




      // í˜„ì¬ í¼/ë³´ë“œ ìƒíƒœë¥¼ ê°€ì ¸ì™€ ê¸°ë³¸ê°’ ì±„ìš°ê¸°
      try {
        const cols = parseInt(document.getElementById('x')?.value || minefield?.columns || 30) || 30;
        const rows = parseInt(document.getElementById('y')?.value || minefield?.rows || 16) || 16;
        const mpc = parseInt(document.getElementById('m')?.value || 1) || 1;
        const tot = parseInt(document.getElementById('t')?.value || 99) || 99;
        const wmpc = parseInt(document.getElementById('wm')?.value || 0) || 0;
        const wtot = parseInt(document.getElementById('wt')?.value || 0) || 0;
        const aiStr = document.getElementById('ai')?.value;
        let ai = parseInt(aiStr, 10);
        if (Number.isNaN(ai)) ai = 2;   // NaNì¼ ë•Œë§Œ 2ë¡œ ëŒ€ì²´ (0ì€ ì‚´ë¦¼)


        document.getElementById('c-cols').value = cols;
        document.getElementById('c-rows').value = rows;
        document.getElementById('c-max').value = mpc;
        document.getElementById('c-total').value = tot;
        document.getElementById('c-wmax').value = wmpc;
        document.getElementById('c-wtotal').value = wtot;
        document.getElementById('c-ai').value = String(ai);
        document.getElementById('c-qmark').checked = !!(window.minefield && window.minefield.question);
      } catch (_) { }

      const $w = $('#custom-win');
      if (!$w.data('mswin-window')) $w.window(); // ì•ˆì „: ìµœì´ˆ 1íšŒë§Œ
      $w.css({
        display: '',
        position: 'absolute',
        left: '10px',
        top: '10px',
        'z-index': 1100

      });
      const dialog = document.getElementById('custom-win');
      if (dialog) {
        dialog.style.width = '225px';
        dialog.style.height = 'max-content';
        //ì´ ë‹¤ì´ì–¼ë¡œê·¸ë¥¼ ê°€ì¥ ì•ìœ¼ë¡œ
        dialog.style.zIndex = 1000;
      }

    }

    function closeCustomDialog() {
      $('#custom-win').hide();
    }

    // í™•ì¸ â†’ ë³´ì • â†’ execute() â†’ ?í‘œì‹œ ë°˜ì˜ â†’ ëë‚´ê¸°
    function submitCustomDialog() {
      // ì…ë ¥
      let i = parseInt(document.getElementById('c-cols').value, 10);
      let j = parseInt(document.getElementById('c-rows').value, 10);
      let d = parseInt(document.getElementById('c-depth').value, 10);
      let l = parseInt(document.getElementById('c-max').value, 10);       // mines per cell
      let k = parseInt(document.getElementById('c-total').value, 10);     // total mines
      let wm = parseInt(document.getElementById('c-wmax').value, 10);      // white mines per cell
      let wt = parseInt(document.getElementById('c-wtotal').value, 10);    // total white mines
      let ai = parseInt(document.getElementById('c-ai').value, 10);


      // ê¸°ë³¸/ë³´ì •
      i = Math.max(3, i | 0);
      j = Math.max(1, j | 0);
      d = Math.max(1, d | 0);
      if (!is3DTheme()) d = 1;          // 2Dë©´ ê¹Šì´ëŠ” í•­ìƒ 1
      // (ì›í•˜ë©´ ìƒí•œë„) d = Math.min(9999, d);

      l = Math.min(6, Math.max(1, l | 0));
      wm = Math.min(6, Math.max(0, wm | 0));
      k = Math.max(1, k | 0);
      wt = Math.max(0, wt | 0);
      ai = Math.max(0, Math.min(2, ai | 0));

      // ìƒí•œ ë³´ì •(ìº¡) â€” ê¸°ì¡´ calcCaps() ì¬ì‚¬ìš©
      let caps = calcCaps(i, j, d, l, k, wm);
      if (k > caps.capBlackTotal) k = caps.capBlackTotal;
      caps = calcCaps(i, j, d, l, k, wm);
      if (wt > caps.capWhiteTotal) wt = caps.capWhiteTotal;

      // ì ìš©
      try {
        setActiveDifficulty(23);
        execute(i, j, k, l, wt, wm, ai, d);

      } catch (e) {
        console.error(e);
      }

      closeCustomDialog();
    }

    //customdialogì˜ display:none;ë¥¼ jsì½”ë“œë¡œ ë™ì ìœ¼ë¡œ ì§€ì •
    document.addEventListener('DOMContentLoaded', function () {
      const dialog = document.getElementById('custom-win');
      if (dialog) {
        dialog.style.display = 'none';
      }
    });

  </script>
<script>
/* ===== (ì¶”ê°€) pick-mode(=trace ì—†ìŒ)ì—ì„œë„ ì½˜ì†”ì— ê·¼ê±° ë¡œê·¸ ë‚¨ê¸°ê¸° ===== */
(function installSolveReasonLogger(){
  if (window.__solveReasonLoggerInstalled) return;
  window.__solveReasonLoggerInstalled = true;

  const BUF_MAX = 20;          // 20ê°œì”© í•œ ì¤„
  const FLUSH_MS = 350;        // ë„ˆë¬´ ì˜¤ë˜ ìŒ“ì´ë©´(ì‹¤ì‹œê°„ì„±) ê°•ì œ flush

  const state = window.__solveLogState = window.__solveLogState || {
    buf: [],
    lastFlush: 0
  };

  function _safeReason(step){
  let r = (step && typeof step.reason === 'string' && step.reason.trim())
    ? step.reason.trim()
    : 'auto';

  // ì˜ì–´ í™˜ê²½ì´ë©´ í•œêµ­ì–´ reasonì„ ì¹˜í™˜
  const isKO =
    (typeof _isKO === 'function') ? _isKO()
    : ((navigator.language || '').toLowerCase().startsWith('ko'));

  if (!isKO) {
    const guessEN = (typeof _msg === 'function')
      ? _msg('i18n-guess-needed', 'i18n-guess-needed-en')
      : 'Guess unavoidable â€” revealing the truth for one cell.';

    //  ë¬¸ìì—´ "ë¹„êµ" ì—†ì´ ì¹˜í™˜ë§Œ ì‚¬ìš©
    r = r
      .replace(/ì°ê¸°\s*ë¶ˆê°€í”¼-í•œ\s*ì¹¸ì˜\s*ì •ë‹µì„\s*ì œê³µ/g, guessEN)
      .replace(/ì˜ëª»\s*ë§ˆí‚¹í•œ\s*ì¹¸ì´\s*ìˆìŠµë‹ˆë‹¤/g, 'Mis-flag detected');
  }

  return r;
}


  function _formatStep(mf, step){
    if (!step) return null;
    const x = (step.x|0), y = (step.y|0);
    const r = _safeReason(step);

    if (step.kind === 'open') {
      return `OPEN(${x},${y})-${r}`;
    }

    if (step.kind === 'markMine' || step.kind === 'fixFlag') {
      // valì´ ìˆìœ¼ë©´ ê·¸ê±¸, ì—†ìœ¼ë©´ ì •ë‹µ(mf.mines)ì„ ì°¸ê³ 
      let v = 0;
      if (step && ('val' in step)) v = (step.val|0);
      else if (mf && mf.mines && mf.mines[x] && typeof mf.mines[x][y] !== 'undefined') v = (mf.mines[x][y]|0);

      const n = Math.abs(v);
      // ë‹¤ì¤‘ì§€ë¢°(í•œ ì¹¸ì— 2ê°œ ì´ìƒ) í‘œê¸°ë¥¼ ì›í•˜ë©´ xNì„ ë¶™ì„ (ì›ì¹˜ ì•Šìœ¼ë©´ ì´ ë¶€ë¶„ ì‚­ì œ ê°€ëŠ¥)
      const mult = (n > 1) ? `x${n}` : '';
      return `FLAG(${x},${y})${mult}-${r}`;
    }

    // í˜¹ì‹œ solveonestepì´ ë‹¤ë¥¸ kindë¥¼ ì¤„ ë•Œë¥¼ ëŒ€ë¹„(ìˆìœ¼ë©´ ë¡œê·¸ë¼ë„ ë‚¨ê¹€)
    if (typeof step.x !== 'undefined' && typeof step.y !== 'undefined') {
      return `${String(step.kind||'STEP').toUpperCase()}(${x},${y})-${r}`;
    }
    return `${String(step.kind||'STEP').toUpperCase()}-${r}`;
  }

  window.__pushSolveLog = function(mf, step, immediate=false){
    const msg = _formatStep(mf, step);
    if (!msg) return;

    // hint ë²„íŠ¼ì€ 1ìŠ¤í…ë§Œ ìˆ˜í–‰í•˜ë‹ˆ ë°”ë¡œ ì°ëŠ” ê²Œ ë³´ê¸° ì¢‹ìŒ
    if (immediate) {
      console.info(msg);
      return;
    }

    state.buf.push(msg);
    const now = Date.now();

    if (state.buf.length >= BUF_MAX || (now - state.lastFlush) > FLUSH_MS) {
      console.info(state.buf.join(' | '));
      state.buf.length = 0;
      state.lastFlush = now;
    }
  };

  window.__flushSolveLog = function(){
    if (state.buf.length) {
      console.info(state.buf.join(' | '));
      state.buf.length = 0;
      state.lastFlush = Date.now();
    }
  };
})();
</script>

  <script>
    // ===== Best Times Management =====
    // Difficulty level mapping: menu index -> level name
    const DIFFICULTY_LEVELS = {
      1: 'beginner',      // ì´ˆê¸‰
      2: 'intermediate',  // ì¤‘ê¸‰
      3: 'expert',        // ê³ ê¸‰
      4: 'ultra',         // ì´ˆê³ ê¸‰
      5: 'level5',        // ğŸ˜±
      6: 'level6',        // ğŸ’€
      7: 'level7',        // â˜ ï¸
      8: 'level8',        // â˜ ï¸Ã—2
      9: 'level9',        // â˜ ï¸Ã—3
      10: 'antimine',     // ìŒìˆ˜ì§€ë¢°
      11: 'antimine2',     // ìŒìˆ˜ì§€ë¢°
      12: 'antimine3',     // ìŒìˆ˜ì§€ë¢°
      13: 'large',        // ëŒ€í˜•
      14: 'xlarge',       // ì´ˆëŒ€í˜•
      15: 'xxlarge',       // íŠ¹ëŒ€í˜•
      16: '_3dmini',     // 3D ì†Œí˜•
      17: '_3dmedium',   // 3D ì¤‘í˜•
      18: '_3dlarge',    // 3D ëŒ€í˜•
      19: '_3dexpert',   // 3D ê³ ë‚œì´ë„
      20: '_3dsuperexpert', // 3D ì´ˆê³ ë‚œì´ë„
      21: '_3dneg',      // 3D ìŒìˆ˜
      22: '_3dnegexpert' // 3D ìŒìˆ˜ ê³ ë‚œì´
    };

    const DIFFICULTY_NAMES_KO = {
      beginner: 'ì´ˆê¸‰',
      intermediate: 'ì¤‘ê¸‰',
      expert: 'ê³ ê¸‰',
      ultra: 'ì´ˆê³ ê¸‰',
      level5: 'ğŸ˜±',
      level6: 'ğŸ’€',
      level7: 'â˜ ï¸',
      level8: 'â˜ ï¸Ã—2',
      level9: 'â˜ ï¸Ã—3',
      antimine: 'ìŒìˆ˜ì§€ë¢°',
      antimine2: 'ìŒìˆ˜ ì¤‘ê¸‰',
      antimine3: 'ìŒìˆ˜ ê³ ê¸‰',
      large: 'ëŒ€í˜•',
      xlarge: 'ì´ˆëŒ€í˜•',
      xxlarge: 'íŠ¹ëŒ€í˜•',
      _3dmini: '3D ì†Œí˜•',
      _3dmedium: '3D ì¤‘í˜•',
      _3dlarge: '3D ëŒ€í˜•',
      _3dexpert: '3D ê³ ë‚œì´ë„',
      _3dsuperexpert: '3D ì´ˆê³ ë‚œì´ë„',
      _3dneg: '3D ìŒìˆ˜',
      _3dnegexpert: '3D ìŒìˆ˜ ê³ ë‚œì´ë„'
    };

    const DIFFICULTY_NAMES_EN = {
      beginner: 'Beginner',
      intermediate: 'Intermediate',
      expert: 'Expert',
      ultra: 'Ultra',
      level5: 'ğŸ˜±',
      level6: 'ğŸ’€',
      level7: 'â˜ ï¸',
      level8: 'â˜ ï¸Ã—2',
      level9: 'â˜ ï¸Ã—3',
      antimine: 'AntiMine',
      antimine2: 'Anti Intermediate',
      antimine3: 'Anti Expert',
      large: 'Large',
      xlarge: 'XLarge',
      xxlarge: 'XXLarge',
      _3dmini: '3D Mini',
      _3dmedium: '3D Medium',
      _3dlarge: '3D Large',
      _3dexpert: '3D Expert',
      _3dsuperexpert: '3D Super Expert',
      _3dneg: '3D Negative',
      _3dnegexpert: '3D Negative Expert'
    };

    // Current active difficulty (set when user selects a difficulty)
    let currentDifficultyLevel = 3; // Default to Expert

    // Get best time for a difficulty level
    function getBestTime(level) {
      try {
        const stored = localStorage.getItem('minesweeper_best_' + level);
        return stored ? parseInt(stored, 10) : 999;
      } catch (e) {
        return 999;
      }
    }

    // Get best time record (time + name) for a difficulty level
    function getBestRecord(level) {
      try {
        const timeStored = localStorage.getItem('minesweeper_best_' + level);
        const nameStored = localStorage.getItem('minesweeper_name_' + level);
        const time = timeStored ? parseInt(timeStored, 10) : 999;
        const defaultName = isKorean() ? 'ìµëª…' : 'Anonymous';
        const name = nameStored || defaultName;
        return { time, name };
      } catch (e) {
        const defaultName = isKorean() ? 'ìµëª…' : 'Anonymous';
        return { time: 999, name: defaultName };
      }
    }

    // Set best time for a difficulty level
    function setBestTime(level, time, playerName = null) {
      try {
        localStorage.setItem('minesweeper_best_' + level, String(time));
        if (playerName) {
          localStorage.setItem('minesweeper_name_' + level, playerName);
        }
      } catch (e) {
        console.error('Failed to save best time:', e);
      }
    }

    // Reset all best times
    function resetAllBestTimes() {
      Object.values(DIFFICULTY_LEVELS).forEach(level => {
        try {
          localStorage.removeItem('minesweeper_best_' + level);
          localStorage.removeItem('minesweeper_name_' + level);
        } catch (e) { }
      });
    }

    // Open best times dialog
    function openBestTimes() {
      const $w = $('#besttimes-win');
      if (!$w.data('mswin-window')) $w.window();

      // Update dialog content
      const content = document.getElementById('besttimes-content');
      if (!content) return;

      const isKO = isKorean();
      const names = isKO ? DIFFICULTY_NAMES_KO : DIFFICULTY_NAMES_EN;
      const secondsText = isKO ? 'ì´ˆ' : ' seconds';

      // Build the content
      let html = '';
      const show3D = is3DTheme();

Object.keys(DIFFICULTY_LEVELS)
  .sort((a, b) => parseInt(a) - parseInt(b))
  .filter(key => {
    const level = DIFFICULTY_LEVELS[key];
    const is3DLevel = /^_3d/.test(level);   // ë‚´ë¶€ ID ê¸°ì¤€(ê°€ì¥ ì•ˆì „)
    return show3D || !is3DLevel;            // 3Dí…Œë§ˆê°€ ì•„ë‹ˆë©´ 3Dë ˆë²¨ ìˆ¨ê¹€
  })
  .forEach(key => {
        const level = DIFFICULTY_LEVELS[key];
        const name = names[level] + ':';
        const record = getBestRecord(level);
        const timeStr = record.time === 999 ? '999' : String(record.time);

        html += `<div style="display:flex; justify-content:space-between; align-items:center; padding:4px 8px; ">
  <span style="flex:0 0 70px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${name}</span>
  <span style="flex:0 0 80px; ">${timeStr}${secondsText}</span>
  <span style="flex:1; ">${record.name}</span>
</div>`;
      });

      content.innerHTML = html;

      // Update dialog title
      const title = document.getElementById('besttimestitle');
      if (title) {
        title.textContent = isKO
  ? ((isPratoTheme() ? 'ê½ƒ í”¼ëŠ” ì´ˆì›' : 'ì§€ë¢° ì°¾ê¸°') + ' ìµœê³  ê¸°ë¡')
  : ('Fastest ' + (window.__APPNAME_PLUR || 'Mine Sweepers'));

      }

      // Update button labels
      const buttons = $w.find('button');
      if (buttons.length >= 2) {
        buttons.eq(0).text(isKO ? 'ì›ë˜ëŒ€ë¡œ(R)' : 'Reset Scores');
        buttons.eq(1).text(isKO ? 'í™•ì¸' : 'OK');
      }

      // Position and show (best times dialog specific)
      $w.css({
        display: '',
        position: 'absolute',
        left: '10px',
        top: '10px',
        'z-index': 1100,
        width: '250px',
        height: 'max-content'
      });
    }

    function closeBestTimes() {
      $('#besttimes-win').hide();
    }

    function resetBestTimes() {


      resetAllBestTimes();
      openBestTimes(); // Refresh the dialog

    }

    function printBestTimes() {
      openBestTimes();
    }

    // Initialize besttimes dialog on load
    document.addEventListener('DOMContentLoaded', function () {
      const dialog = document.getElementById('besttimes-win');
      if (dialog) {
        dialog.style.display = 'none';
      }

      // Initialize name input dialog
      const nameDialog = document.getElementById('nameinput-win');
      if (nameDialog) {
        nameDialog.style.display = 'none';
      }
    });

    // Variables to store current record info
    let currentRecordLevel = null;
    let currentRecordTime = null;

    // Show name input dialog for new record
    function showNameInputDialog(level, time) {
      currentRecordLevel = level;
      currentRecordTime = time;

      const dialog = document.getElementById('nameinput-win');
      const messageEl = document.getElementById('nameinput-message');
      const inputEl = document.getElementById('nameinput-field');

      if (!dialog || !messageEl || !inputEl) return;

      // Set language-appropriate message
      const isKO = isKorean();
      const levelNames = isKO ? DIFFICULTY_NAMES_KO : DIFFICULTY_NAMES_EN;
      const levelName = levelNames[level] || level;

      const message = isKO
        ? `${levelName} ìˆ˜ì¤€ì—ì„œëŠ” ìµœê³  ê¸°ë¡ì…ë‹ˆë‹¤.\nì´ë¦„ì„ ì…ë ¥í•˜ì‹­ì‹œì˜¤.`
        : `You have the fastest time for ${levelName} level.\nPlease enter your name.`;

      messageEl.style.whiteSpace = 'pre-line';
      messageEl.textContent = message;

      // Set default name
      const defaultName = isKO ? 'ìµëª…' : 'Anonymous';
      inputEl.value = defaultName;

      // Update button text
      const button = dialog.querySelector('button');
      if (button) {
        button.textContent = isKO ? 'í™•ì¸' : 'OK';
      }

      // Position dialog at (10,10)
      dialog.style.display = 'block';
      dialog.style.left = '10px';
      dialog.style.top = '10px';
      dialog.style.transform = 'none';

      // Focus and select input text
      setTimeout(() => {
        inputEl.focus();
        inputEl.select();
      }, 100);
    }

    // Submit name input and save record
    function submitNameInput() {
      const inputEl = document.getElementById('nameinput-field');
      const dialog = document.getElementById('nameinput-win');

      if (!inputEl || !dialog || !currentRecordLevel || currentRecordTime === null) return;

      const playerName = inputEl.value.trim() || (isKorean() ? 'ìµëª…' : 'Anonymous');

      // Save the record with player name
      setBestTime(currentRecordLevel, currentRecordTime, playerName);

      // Hide dialog
      dialog.style.display = 'none';

      // Clear current record info
      currentRecordLevel = null;
      currentRecordTime = null;
      printBestTimes();
    }

    // Handle Enter key in name input
    document.addEventListener('keydown', function (e) {
      const dialog = document.getElementById('nameinput-win');
      if (dialog && dialog.style.display === 'block' && e.key === 'Enter') {
        e.preventDefault();
        submitNameInput();
      }
    });
  </script>

  <script>
    function runMenu(fn) {
      // ë©”ë‰´ ì ‘ê¸°ëŠ” ë°”ë¡œ, ì‹¤í–‰ì€ ë‹¤ìŒ í‹±ì—
      closeMenus();

      // ì¶”ê°€: ë©”ë‰´ë°”ì˜ ëª¨ë“  í™œì„± ìƒíƒœë¥¼ ê°•ì œë¡œ ì œê±°
      $('.menu-bar > li').removeClass('ui-state-active ui-state-hover ui-state-focus ui-state-open');
      $('.menu-bar .menu').hide().attr('aria-hidden', 'true').attr('aria-expanded', 'false');
      $('.menu-bar .ui-state-active').removeClass('ui-state-active');

      setTimeout(fn, 0);   // ë˜ëŠ”: requestAnimationFrame(fn)

      return false;        // a# href="#" ê¸°ë³¸ ë‚´ë¹„ ë§‰ê¸°
    }
    function setActiveDifficulty(idx) {
      // Update current difficulty level for best times tracking
      if (typeof currentDifficultyLevel !== 'undefined') {
        currentDifficultyLevel = idx;
      }

      const KO = isKorean();

      // ë‚œì´ë„ ë©”ë‰´ ë²ˆí˜¸: Beginner~Custom (menu1~menu11)
      
      const labelsKO = [
    "ìƒˆ ê²Œì„(N)", "ì´ˆê¸‰(B)", "ì¤‘ê¸‰(I)", "ê³ ê¸‰(E)", "ì´ˆê³ ê¸‰", "ğŸ˜±", "ğŸ’€", "â˜ ï¸", "â˜ ï¸Ã—2",
    "â˜ ï¸Ã—3", "ìŒìˆ˜ì§€ë¢°", "ìŒìˆ˜ ì¤‘ê¸‰", "ìŒìˆ˜ ê³ ê¸‰", "ëŒ€í˜•", "ì´ˆëŒ€í˜•", "íŠ¹ëŒ€í˜•", "3D ì†Œí˜•","3D ì¤‘í˜•","3D ëŒ€í˜•","3D ê³ ë‚œì´ë„","3D ì´ˆê³ ë‚œì´ë„","3D ìŒìˆ˜","3D ìŒìˆ˜ ê³ ë‚œì´ë„","ì‚¬ìš©ì ì§€ì •(C)..."
  ];
  const labelsEN = [
    "New", "Beginner", "Intermediate", "Expert", "Ultra", "ğŸ˜±", "ğŸ’€", "â˜ ï¸", "â˜ ï¸Ã—2",
    "â˜ ï¸Ã—3", "AntiMine", "Anti Intermediate", "Anti Expert", "Large", "XLarge", "XXLarge", "3D Mini","3D Medium","3D Large","3D Expert","3D Super Expert","3D Negative","3D Negative Expert","Custom..."
  ];

      // ì „ì²´ ì´ˆê¸°í™”
  for (let i = 0; i <= 23; i++) {
    const label = (KO ? labelsKO[i] : labelsEN[i]) || '';
    const key = (i === 0) ? 'F2' : '';
    setMenuText(`li.menu${i}`, 'ã€€' + label, key);
  }

  // ì„ íƒ í•­ëª© ì²´í¬
  {
    const label = (KO ? labelsKO[idx] : labelsEN[idx]) || '';
    const key = (idx === 0) ? 'F2' : '';
    setMenuText(`li.menu${idx}`, 'âœ“ ' + label, key);
  }
    }
  </script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Windows 98 í…Œë§ˆ ì „ì²´ì—ì„œ ìš°í´ë¦­ ë©”ë‰´ ë¹„í™œì„±í™”
  const win98 = document.querySelectorAll('.windows-98');

  win98.forEach(el => {
    el.addEventListener('contextmenu', function (e) {
      e.preventDefault();   // ë¸Œë¼ìš°ì € ê¸°ë³¸ ë©”ë‰´ë§Œ ì°¨ë‹¨
      // stopPropagation() ì€ ì ˆëŒ€ ì“°ì§€ ë§ˆì„¸ìš” â€” ìš°í´ë¦­ ë¡œì§ì´ ë§‰í™ë‹ˆë‹¤.
    });
	 el.addEventListener('mousedown', function (e) {
      if (e.button !== 1) return; // middle ë²„íŠ¼ë§Œ ê´€ì‹¬

      // â–¶ ì§€ë¢°íŒ(#mine-area) ìœ„ ì¤‘í´ë¦­ì€ ê·¸ëŒ€ë¡œ ë‘ê¸°
      //   - ì—¬ê¸°ì„œ preventDefault()ë¥¼ ì•ˆ í•´ì•¼
      //     mine.js / Minefieldì˜ ì¤‘í´ë¦­(chording ë“±) ë¡œì§ì´ ì˜¨ì „íˆ ë™ì‘
      if (e.target.closest('#mine-area-2d, #mine-area-3d, .mine-area')) {
  return;
}

      // ê·¸ ì™¸ Win98 ì˜ì—­ì—ì„œëŠ” ì¤‘í´ë¦­ ìë™ ìŠ¤í¬ë¡¤ ê¸°ë³¸ë™ì‘ë§Œ ì°¨ë‹¨
      e.preventDefault();
      // ì ˆëŒ€ stopPropagation() ì“°ì§€ ë§ˆì„¸ìš”.
      // ì´ë²¤íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ìœ„/ì•„ë˜ë¡œ í˜ëŸ¬ì•¼ ê¸°ì¡´ ì½”ë“œê°€ ì‘ë™í•©ë‹ˆë‹¤.
    });
  });
});
document.addEventListener('DOMContentLoaded', function () {
  const overlay = document.getElementById('loading-overlay');
  const host = document.querySelector('.mine-window .window-content') || document.querySelector('.mine-window');
  if (overlay && host && overlay.parentNode !== host) {
    host.appendChild(overlay);
    // fixedë¡œ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì•ˆì „í•˜ê²Œ absolute ê°•ì œ
    overlay.style.position = 'absolute';
    overlay.style.top = '50%';
    overlay.style.left = '50%';
    overlay.style.transform = 'translate(-50%, -50%)';
    overlay.style.zIndex = '9999';
  }
});
function openHelpContents() {
  // â€œë„ì›€ë§ì€ ì•„ë˜ì— ìˆìŠµë‹ˆë‹¤â€ì— í•´ë‹¹í•˜ëŠ” ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
  const target = document.getElementById('heavy-notice') || document.getElementById('userctrl');
  if (!target) return;

  const st = window.getComputedStyle(target);
  if (st.display === 'none' || st.visibility === 'hidden') {
    alert(isKorean() ? 'ë„ì›€ë§(ì•ˆë‚´) ì˜ì—­ì´ ìˆ¨ê²¨ì ¸ ìˆìŠµë‹ˆë‹¤.' : 'Help area is hidden.');
    return;
  }

  target.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
// ===== 3D Bridge =====
function is3DTheme(){ return (window.currentTheme || 'minesweeper') === '3d'; }

const __threeD = {
  iframe: null,
  ready: false,
  lastInit: null,
  pendingHintPopup: false,
};

function ensure3DIframe(){
  const host = document.getElementById('mine-area-3d');
  if (!host) return null;

  if (__threeD.iframe && __threeD.iframe.isConnected) return __threeD.iframe;

  const ifr = document.createElement('iframe');
  ifr.src = '3dmine.html';
  ifr.style.width = '100%';
  ifr.style.height = '100%';
  ifr.style.border = '0';
  ifr.style.display = 'block';
  ifr.setAttribute('title', '3D Minesweeper');
  host.innerHTML = '';
  host.appendChild(ifr);

  __threeD.iframe = ifr;
  __threeD.ready = false;
  ifr.addEventListener('load', () => {
    // load ì‹œì ì—ë„ í•œë²ˆ ì‹œë„ (ready ì´ì „ì´ë©´ 3Dìª½ pendingInitì— ë“¤ì–´ê°€ê²Œ ë§Œë“¤ ìˆ˜ë„ ìˆìŒ)
    if (__threeD.lastInit) post3D({ type:'init', payload: __threeD.lastInit });
    post3D({ type:'sound', enabled: !!(window.minefield && window.minefield.soundEnabled) });
  });
  return ifr;
}

function post3D(msg){
  const ifr = __threeD.iframe;
  if (!ifr || !ifr.contentWindow) return;
  ifr.contentWindow.postMessage({ __mine3d: 1, ...msg }, '*');
}

function show3DBoard(on){
  const a2d = document.getElementById('mine-area-2d');
  const a3d = document.getElementById('mine-area-3d');
  if (!a2d || !a3d) return;

  if (on){
    ensure3DIframe();
    a2d.style.display = 'none';
    a3d.style.display = '';
  } else {
    // âœ… 3Dì—ì„œ 2Dë¡œ ë‚˜ê°ˆ ë•Œ 3D ìë™í’€ì´ê°€ ëŒê³  ìˆìœ¼ë©´ ì •ì§€
    stop3DAutoSolve();
__last3DTick = 0;
    __threeD.pendingHintPopup = false;

    // âœ… iframe ì œê±°(= 3dmine.html ë‚´ë¶€ setInterval/RAF íƒ€ì´ë¨¸ë„ ê°™ì´ ì¢…ë£Œë¨)
    if (__threeD.iframe) {
      try { __threeD.iframe.src = 'about:blank'; } catch(_) {}
      try { __threeD.iframe.remove(); } catch(_) {}
      __threeD.iframe = null;
    }
    __threeD.ready = false;
    a3d.style.display = 'none';
    a2d.style.display = '';
  }
}
// ===== 3D Auto-solve / Hint bridge =====
window.__threeDsolver = window.__threeDsolver || { running:false, paused:false };

function _solveLabelPlay(){
  const ko = (navigator.language || '').toLowerCase().startsWith('ko');
  return ko ? 'ìë™ìœ¼ë¡œ í’€ê¸°' : 'Solve Automatically';
}
function _solveLabelPause(){
  const ko = (navigator.language || '').toLowerCase().startsWith('ko');
  return ko ? 'ìë™ í’€ê¸° ì¼ì‹œ ì¤‘ì§€' : 'Pause Auto-solve';
}
function _syncSolveBtnText3D(){
  const btn = document.getElementById('console-play');
  if (!btn) return;
  // running && !paused => pause ë¼ë²¨, ê·¸ ì™¸ëŠ” play ë¼ë²¨
  btn.textContent = (window.__threeDsolver.running && !window.__threeDsolver.paused)
    ? _solveLabelPause()
    : _solveLabelPlay();
}

function toggle3DAutoSolve(){
  ensure3DIframe();
  if (!__threeD.iframe) return;

  const st = window.__threeDsolver;

  if (!st.running){
    st.running = true; st.paused = false;
    post3D({ type:'solver', cmd:'start' });
  } else if (!st.paused){
    st.paused = true;
    post3D({ type:'solver', cmd:'pause' });
  } else {
    st.paused = false;
    post3D({ type:'solver', cmd:'resume' });
  }
  _syncSolveBtnText3D();
}

function stop3DAutoSolve(){
  const st = window.__threeDsolver;
  if (st.running){
    post3D({ type:'solver', cmd:'stop' });
  }
  st.running = false;
  st.paused = false;
  _syncSolveBtnText3D();

  // (ìˆìœ¼ë©´) ì½˜ì†” ë²„í¼ flush
  if (typeof __flushSolveLog === 'function') __flushSolveLog();
}

function request3DHint(){
  ensure3DIframe();
  __threeD.pendingHintPopup = true;      // âœ… ì¶”ê°€
  post3D({ type:'solver', cmd:'hint' });
}

// 3D -> parent ë©”ì‹œì§€ ìˆ˜ì‹ 
let __last3DTick = 0;

window.addEventListener('message', (e) => {
  const m = e.data;
  if (!m || !m.__mine3d) return;
  if (typeof is3DTheme === 'function' && !is3DTheme()) return;
  if (m.type === 'solverState'){
    window.__threeDsolver.running = !!m.running;
    window.__threeDsolver.paused  = !!m.paused;
    _syncSolveBtnText3D();
    return;
  }
// âœ… 3D iframeì—ì„œ ì˜¨ í‚¤ ì…ë ¥ì„ mainì˜ ê¸°ì¡´ ë‹¨ì¶•í‚¤ í•¸ë“¤ëŸ¬ë¡œ ì „ë‹¬
if (m.type === 'key') {
  const ev = new KeyboardEvent('keydown', {
    key: m.key,
    code: m.code,
    ctrlKey: !!m.ctrlKey,
    altKey: !!m.altKey,
    shiftKey: !!m.shiftKey,
    metaKey: !!m.metaKey,
    bubbles: true
  });
  document.dispatchEvent(ev);
  return;
}

  if (m.type === 'ready'){
    __threeD.ready = true;

    if (__threeD.lastInit) {
      post3D({ type:'init', payload: __threeD.lastInit });
    }

    // (ì„ íƒ) ì‚¬ìš´ë“œ ìƒíƒœë„ 3Dë¡œ ì¬ì „ì†¡
    post3D({ type:'sound', enabled: !!(window.minefield && window.minefield.soundEnabled) });

    return;
  }
// âœ… ì¶”ê°€: 3D íŒíŠ¸/ìŠ¤í… ê²°ê³¼ë¥¼ ë°›ì•„ ì•Œë¦¼ì°½ ë„ìš°ê¸°
 // âœ… ìˆ˜ì •: 3D íŒíŠ¸/ìë™í’€ê¸° ì•Œë¦¼ ì •ì±…(2Dì™€ ë™ì¼)
if (m.type === 'solverStep') {
  const step = m.step || m.payload;
  if (!step) return;

  const ko = (navigator.language || '').toLowerCase().startsWith('ko');
  const x = step.x|0, y = step.y|0, z = step.z|0;
  const reason = (step.reason || '').toString();

  // 1) ìë™í’€ê¸°ì—ì„œëŠ” "ì°ê¸° ë¶ˆê°€í”¼"ë§Œ alert
  // 2) íŒíŠ¸ ìš”ì²­(pendingHintPopup)ì¼ ë•Œë§Œ ìƒì„¸ alert
  const isHintPopup = !!__threeD.pendingHintPopup;
  if (isHintPopup) __threeD.pendingHintPopup = false;
const misFlag =
    step.kind === 'fixFlag' ||
    /ì˜ëª»\s*ë§ˆí‚¹í•œ\s*ì¹¸ì´\s*ìˆìŠµë‹ˆë‹¤/i.test(reason) ||
    /mis-flag/i.test(reason);

  if (misFlag) {
    // 2D ë¬¸êµ¬ì— ë§ì¶¤ (3Dë¼ zë„ ê°™ì´ í‘œê¸°)
    alert(
      ko
        ? `ì˜ëª» ë§ˆí‚¹í•œ ì¹¸ì´ ìˆìŠµë‹ˆë‹¤: (${x}, ${y}, ${z}). ë¨¼ì € ì´ ì¹¸ì„ ìˆ˜ì •í•˜ì„¸ìš”.`
        : `You mis-flagged a cell: (${x}, ${y}, ${z}). Please fix this first.`
    );
    return;
  }
  // âœ… ìë™í’€ê¸°/ì¼ë°˜ step: usedGuessë§Œ ê²½ê³ ì°½
  if (!isHintPopup) {
    if (step.usedGuess) {
      alert(ko ? 'ì°ê¸° ë¶ˆê°€í”¼ â€” í•œ ì¹¸ì˜ ì •ë‹µì„ ì œê³µ.' : 'Guess unavoidable â€” revealing the truth for one cell');
    }
    return; // â† ì—¬ê¸°ì„œ ë! (ë§¤ stepë§ˆë‹¤ ì•Œë¦¼ ì•ˆ ëœ¸)
  }

  // âœ… íŒíŠ¸(F4)ë¡œ ì˜¨ step: ìƒì„¸ ì•Œë¦¼
  if (step.usedGuess) {
    alert(ko ? 'ì°ê¸° ë¶ˆê°€í”¼ â€” í•œ ì¹¸ì˜ ì •ë‹µì„ ì œê³µ.' : 'Guess unavoidable â€” revealing the truth for one cell');
  }

  if (step.kind === 'open') {
    alert(
      ko
        ? `ë‹¤ìŒìœ¼ë¡œ ì—´ì–´ì•¼ í•˜ëŠ” ì•ˆì „í•œ ì¹¸: (${x}, ${y}, ${z}). ê·¼ê±°: ${reason}`
        : `Next safe cell to open: (${x}, ${y}, ${z}). Rationale: ${reason}`
    );
    return;
  }

  if (step.kind === 'markMine' || step.kind === 'fixFlag') {
    const v = (step.val|0);
    const n = Math.abs(v);
    const isWhite = (v < 0);

    alert(
      ko
        ? `ë‹¤ìŒ ìœ„ì¹˜ì— ${isWhite ? 'ìŒìˆ˜ ì§€ë¢°' : 'ì§€ë¢°'} ê¹ƒë°œ ${n}ê°œ: (${x}, ${y}, ${z}). ê·¼ê±°: ${reason}`
        : `Place ${n} ${isWhite ? 'anti-mine' : 'mine'} flag(s) at (${x}, ${y}, ${z}). Rationale: ${reason}`
    );
    return;
  }

  alert(`${step.kind} (${x},${y},${z}) : ${reason}`);
  return;
}

if (m.type === 'face'){
    // status: -2 win, -1 dead, 2 thinking, 0 normal
    setFaceByStatus(m.status);
    return;
  }
    //  3D ì¹´ìš´í„°(ì§€ë¢°/ìŒìˆ˜ì§€ë¢°) ë™ê¸°í™”
  if (m.type === 'counters'){
    update3DCounters(m.payload || m);
    return;
  }

  //  3D íƒ€ì´ë¨¸ ë™ê¸°í™” (ì´ˆ ë‹¨ìœ„)
  if (m.type === 'timer'){
  const sec = Math.max(0, (m.elapsed|0));
  update_counter_timer(sec, $(".mine-timer"));

  // âœ… 3D íƒ€ì´ë¨¸ ì¦ê°€ ì‹œ ì†Œë¦¬ (secê°€ ë°”ë€” ë•Œë§Œ)
  if (sec > 0 && sec !== __last3DTick) playSound('timer.wav');
  __last3DTick = sec;

  return;
}
  if (m.type === 'playSound'){
    // 3Dìª½ì—ì„œ "ì´ ì‚¬ìš´ë“œ ì¬ìƒí•´ì¤˜" ìš”ì²­
    playSound(m.file);
    return;
  }
});
//  3D ì¹´ìš´í„°(UI) ê°±ì‹  (2D minefield ì—†ì´ë„ DOM ì§ì ‘ ì—…ë°ì´íŠ¸)
function update3DCounters(p){
  // p: { blackRemain, whiteRemain, blackTotal, whiteTotal }
  //    ë˜ëŠ” { minesLeft, antiMinesLeft, minesTotal, antiMinesTotal } ë“±ë„ í—ˆìš©
  if (!document.getElementById('mine-counter-single')) return; // DOM ì¤€ë¹„ ì „ì´ë©´ ë¬´ì‹œ

  const bRemain = ((p.blackRemain ?? p.minesLeft ?? p.remain ?? 0) | 0);
  const wRemain = ((p.whiteRemain ?? p.antiMinesLeft ?? p.whiteLeft ?? 0) | 0);

  const bTotal  = ((p.blackTotal  ?? p.minesTotal ?? p.totalMines     ?? Math.max(bRemain,0)) | 0);
  const wTotal  = ((p.whiteTotal  ?? p.antiMinesTotal ?? p.totalAntiMines ?? Math.max(wRemain,0)) | 0);

  const hasWhite = (wTotal > 0) || (wRemain !== 0);

  // í—¤ë”/ì¹´ìš´í„° ë ˆì´ì•„ì›ƒ ì „í™˜(ì´ë¯¸ mainì— ìˆëŠ” í•¨ìˆ˜ ì¬ì‚¬ìš©)
  renderCounters(hasWhite);
  const head = document.querySelector('.window-content .mine-head-area');
  if (head) head.style.height = hasWhite ? '58px' : '38px';

  if (hasWhite){
    const maxAbs = Math.max(
      Math.abs(bTotal), Math.abs(wTotal),
      Math.abs(bRemain), Math.abs(wRemain)
    );
    const N = Math.max(3, String(maxAbs).length);

    update_counter_generic(bRemain, $("#mine-counter-black"), bTotal, N);
    update_counter_generic(wRemain, $("#mine-counter-white"), wTotal, N);
  } else {
    // ë‹¨ì¼ ì¹´ìš´í„°ëŠ” â€œê²€ì€ ì§€ë¢° remainâ€ë§Œ í‘œì‹œí•œë‹¤ê³  ê°€ì •
    update_counter_generic(bRemain, $("#mine-counter-single"), bTotal || Math.abs(bRemain));
  }
}

// ì–¼êµ´ í‘œì‹œ í†µì¼ í•¨ìˆ˜(2D/3D ê³µìš©)
function setFaceByStatus(status){
  // 0 normal, 2 thinking, -1 dead, -2 win
  var smile = $(".mine-reset-button .mine-reset-button-inner");
  var bg = "0 0";
  if (status === -1) bg = "-24px 0";
  if (status === -2) bg = "-72px 0";
  if (status === 2)  bg = "-48px 0";
  smile.css({ "background-position": bg });
}
function resetBoard(){
  if (is3DTheme()){
    stop3DAutoSolve();     // âœ… ì¶”ê°€

    __last3DTick = 0;
    post3D({ type:'reset' });
    setFaceByStatus(0);
    return;
  }
  if (window.minefield) minefield.reset_board();
}
function syncDepthUI(){
  const on = is3DTheme();
  document.getElementById('z')?.style.setProperty('display', on ? '' : 'none');

  // custom dialog
  document.getElementById('lbl-depth1')?.style.setProperty('display', on ? '' : 'none');
  document.getElementById('lbl-depth2')?.style.setProperty('display', on ? '' : 'none');
  document.getElementById('c-depth')?.style.setProperty('display', on ? '' : 'none');
}
const __aiBackup = {
  mainHTML: null,
  customHTML: null,
};

function syncAIModeUI(){
  const on = is3DTheme();

  // ë©”ì¸ ì…€ë ‰íŠ¸
  const sel = document.getElementById('ai');
  if (sel){
    if (__aiBackup.mainHTML === null) __aiBackup.mainHTML = sel.innerHTML;

    if (on){
      //ë¸Œë¼ìš°ì €ê°€ ì˜ì–´ì¸ì§€ í™•ì¸í•´ì•¼í•¨, ì˜ì–´ì´ë©´ ì˜ì–´ë¬¸êµ¬
      if((navigator.language || '').toLowerCase().startsWith('ko')){
        sel.innerHTML = `<option value="0" selected>0: ì°ê¸° í—ˆìš© + ìµœì†Œ êµ¬ì œ</option>`;
      } else {
        sel.innerHTML = `<option value="0" selected>0: Allow Guessing + Minimal Rescue</option>`;
      }
      sel.value = '0';
    } else {
      sel.innerHTML = __aiBackup.mainHTML;
      // ê¸°ë³¸ 2ë¡œ ë³µêµ¬(ì›ë˜ ë¡œì§ ìœ ì§€)
      sel.value = sel.value || '2';
    }
  }

  // ì»¤ìŠ¤í…€ ë‹¤ì´ì–¼ë¡œê·¸ ì…€ë ‰íŠ¸
  const csel = document.getElementById('c-ai');
  if (csel){
    if (__aiBackup.customHTML === null) __aiBackup.customHTML = csel.innerHTML;

    if (on){
      //ë¸Œë¼ìš°ì €ê°€ ì˜ì–´ì¸ì§€ í™•ì¸í•´ì•¼í•¨, ì˜ì–´ì´ë©´ ì˜ì–´ë¬¸êµ¬
      if((navigator.language || '').toLowerCase().startsWith('ko')){
        csel.innerHTML = `<option value="0" selected>0: ì°ê¸° í—ˆìš© + ìµœì†Œ êµ¬ì œ</option>`;
      } else {
        csel.innerHTML = `<option value="0" selected>0: Allow Guessing + Minimal Rescue</option>`;
      }
      csel.value = '0';
    } else {
      csel.innerHTML = __aiBackup.customHTML;
      csel.value = csel.value || '2';
    }
  }
}
// ===== 3D iframe -> main bridge (face / timer / counters / sound) =====
(function install3DBridge(){
  if (window.__mine3dBridgeInstalled) return;
  window.__mine3dBridgeInstalled = true;

  function setFaceUI(status){
    // 0 normal, 2 thinking, -1 dead, -2 win  (3dmine.htmlê³¼ ë™ì¼ ì•½ì†)
    const faceEl = document.querySelector(".mine-reset-button .mine-reset-button-inner");
    if (!faceEl) return;

    let bg = "0 0";
    if (status === -1) bg = "-24px 0";
    else if (status === -2) bg = "-72px 0";
    else if (status === 2) bg = "-48px 0";

    // 3DëŠ” iframeì—ì„œ ì˜¤ë‹ˆ CSS(:active)ì™€ ì¶©ëŒ ì—†ê²Œ importantë¡œ ê°•ì œ
    faceEl.style.setProperty("background-position", bg, "important");
  }

  function update3DTimer(elapsed){
    elapsed = (elapsed|0);
    // 3ìë¦¬ íƒ€ì´ë¨¸ ê°±ì‹  (ê¸°ì¡´ ìœ í‹¸ ì¬ì‚¬ìš©)
    update_counter_timer(elapsed, $(".mine-timer"));
  }

  function update3DCounters(p){
    if (!p) return;
    const blackTotal  = (p.blackTotal|0);
    const whiteTotal  = (p.whiteTotal|0);
    const blackRemain = (p.blackRemain|0);
    const whiteRemain = (p.whiteRemain|0);

    const hasWhite = whiteTotal > 0;
    renderCounters(hasWhite);

    // í—¤ë” ë†’ì´ë„ 2Dì™€ ë™ì¼ ê·œì¹™ìœ¼ë¡œ ë§ì¶¤
    const head = document.querySelector('.window-content .mine-head-area');
    if (head) head.style.height = hasWhite ? '58px' : '38px';

    if (hasWhite){
      const maxAbs = Math.max(Math.abs(blackTotal), Math.abs(whiteTotal));
      const N = Math.max(3, String(maxAbs).length);
      update_counter_generic(blackRemain, $("#mine-counter-black"), blackTotal, N);
      update_counter_generic(whiteRemain, $("#mine-counter-white"), whiteTotal, N);
    } else {
      update_counter_generic(blackRemain, $("#mine-counter-single"), blackTotal);
    }
  }

  window.addEventListener("message", (e) => {
    const m = e.data;
    if (!m || !m.__mine3d) return;

    // í˜¹ì‹œ 2D í…Œë§ˆì¼ ë•Œ ë“¤ì–´ì˜¨ ë©”ì‹œì§€ëŠ” ë¬´ì‹œ(í…Œë§ˆ ì „í™˜ ì¤‘ ë ˆì´ìŠ¤ ë°©ì§€)
    if (typeof is3DTheme === "function" && !is3DTheme()) return;

    if (m.type === "ready") {
      window.__threeD = window.__threeD || {};
      window.__threeD.ready = true;
      if (window.__threeD.lastInit && typeof post3D === "function") {
        post3D({ type:"init", payload: window.__threeD.lastInit });
      }
      return;
    }

    if (m.type === "face") {
      setFaceUI(m.status);
      return;
    }

    if (m.type === "timer") {
      update3DTimer(m.elapsed);
      return;
    }

    if (m.type === "counters") {
      update3DCounters(m.payload);
      return;
    }

    if (m.type === "playSound") {
      if (typeof playSound === "function") playSound(m.file);
      return;
    }
  });
})();

</script>
</body>

</html>